



---

## Outbox 패턴 (하이브리드 구조)

*설계 원칙: file_storage_objects는 현재 상태 + 락 역할, sync_events는 Outbox + 히스토리 전담*

### 역할 분리

| 테이블 | 역할 | 상태 관리 |
|--------|------|-----------|
| **file_storage_objects** | 현재 상태, 빠른 락 체크 | `availabilityStatus` (4개) |
| **sync_events** | Outbox, 비동기 작업 추적, 히스토리 | `status` (4개) |

### 연결 방식

- `file_storage_objects.active_sync_event_id` → `sync_events.id` (FK)
- NULL이면 idle 상태, 값이 있으면 작업 중
- Worker 완료 시 `active_sync_event_id = NULL`로 리셋

---

### <sync_events> (Outbox + 동기화 히스토리)

*목적: NAS 비동기 작업의 Outbox 역할 + 작업 히스토리/재시도 관리*

```
id (UUID, PK)

eventType (SYNC / MOVE / DELETE / RENAME)
  - SYNC: 업로드/수정 → 캐시에서 NAS로 복사
  - MOVE:  폴더 이동
  - RESTORE: 복구
  - TRASH: 휴지통 이동
  - DELETE: 영구 삭제
  - RENAME: 파일명 변경

targetType (FILE / FOLDER)
fileId (FK → files.id, NULL 가능)
folderId (FK → folders.id, NULL 가능)

sourcePath (원본 경로, VARCHAR)
targetPath (대상 경로, VARCHAR)

status (PENDING / PROCESSING / DONE / FAILED)
  - PENDING: 트랜잭션 내 INSERT, Scheduler 대기
  - PROCESSING: Scheduler가 Bull에 발행 후
  - DONE: Worker 성공 완료
  - FAILED: 최대 재시도 후 실패

retryCount (재시도 횟수, 기본값: 0)
maxRetries (최대 재시도 횟수, 기본값: 3)
errorMessage (실패 시 에러 메시지)

processedAt (처리 완료 시각)
createdAt
updatedAt
```

*제약/인덱스*
```sql
INDEX(status, createdAt)  -- Outbox Scheduler 조회용
INDEX(fileId)
INDEX(folderId)
INDEX(processedAt)        -- 히스토리 조회/정리용
```

---

**멀티 파트 업로드 관련 엔티티**

<upload_sessions>

id

uploaderId (업로더 ID)

targetFolderId (대상 폴더 ID)

fileName (파일명)

mimeType (MIME 타입)

bytes (전체 파일 크기)

strategy (SINGLE / MULTIPART)

status (INIT / UPLOADING / COMPLETED / ABORTED)

expiresAt (만료 시간)


<upload_parts>

id

sessionId (FK → upload_sessions.id)

partNumber (파트 번호)

bytes (파트 크기)

etag/checksum (무결성 검증용)

status (파트 상태)

*제약조건*
UNIQUE(sessionId, partNumber) -- 중복 파트 방지


#####  0.파일 관련 엔티티 (4NF 기반 설계)**

*설계 원칙: 한 파일이 SeaweedFS(캐시)와 NAS(영구저장)에 동시에 존재할 수 있음 → 멀티밸류 분리*

---

<files> (논리 파일, 메타)

id

folderId (FK → folders.id)

name (파일명)

bytes (파일 크기)

mimeType

state (ACTIVE / TRASHED / DELETED)


*제약/인덱스*
INDEX(folderId)
UNIQUE(folderId, name) -- 같은 폴더 내 파일명 중복 금지 정책 시


<file_storage_objects> (파일 저장소별 물리 객체)

*목적: "한 파일이 여러 저장소에 존재"를 중복 없이 표현 + 현재 상태/락 관리*

---

**공통 필드**

| 필드 | 타입 | 설명 |
|------|------|------|
| id | UUID | PK |
| fileId | UUID (FK) | files.id 참조 |
| storageType | ENUM | CACHE_SEAWEED / NAS |
| storageLocator | VARCHAR | 저장소 위치 (리전/볼륨/IP) |
| objectKey | VARCHAR | 저장소 내 파일 키 |
| checksum | VARCHAR | 무결성 검증용 (옵션) |
| **activeSyncEventId** | UUID (FK) | sync_events.id 참조, **NULL이면 idle** |

---

**storageType별 필드 사용 여부**

| 필드 | CACHE_SEAWEED (캐시) | NAS (영구저장소) | 설명 |
|------|:-------------------:|:---------------:|------|
| **storageLocator** | `ap.north.xxxxx` | `192.168.xxx.xxx` | 캐시: 리전/볼륨, NAS: IP |
| **objectKey** | `fileId (UUID)` | `/a/b/c/file.txt` | 캐시: UUID 그대로, NAS: 전체 경로 |
| **activeSyncEventId** | ✅ 사용 | ✅ 사용 | 현재 진행 중인 작업 (FK → sync_events) |
| **lastAccessed** | ✅ 사용 | ❌ NULL | LRU 정책용 (다운로드 시 NOW()) |
| **accessCount** | ✅ 사용 (기본값: 1) | ❌ NULL | LFU 정책용 (다운로드 시 +1) |
| **leaseCount** | ✅ 사용 (기본값: 0) | ❌ NULL | 읽기 중 삭제 방지 (atomic +1/-1) |
| **lastVerifiedAt** | ❌ NULL | ✅ 사용 | NAS 파일 무결성 검증 시각 |

---

**availabilityStatus (단순화 - 4개)**

| 상태 | CACHE_SEAWEED (캐시) | NAS (영구저장소) | 용도 |
|------|---------------------|-----------------|------|
| **AVAILABLE** | ✅ 캐시에 정상 저장됨 | ✅ NAS에 정상 동기화됨 | 정상 상태, 작업 가능 |
| **BUSY** | ✅ 작업 진행 중 | ✅ 작업 진행 중 | **activeSyncEventId로 구체적 작업 확인** |
| **MISSING** | ✅ 캐시에 없음 | ✅ NAS에 없음 | 캐시: 복원 필요, NAS: 파일 없음 |
| **ERROR** | ✅ 캐시 저장 실패 | ✅ 동기화/이동 실패 | 수동 처리 필요 |

**BUSY 상태에서 구체적 작업 확인:**
- `activeSyncEventId`가 NOT NULL이면 → `sync_events` JOIN으로 `eventType` 확인
- SYNC, MOVE, DELETE, RENAME 중 어떤 작업인지 즉시 파악 가능

---

**캐시 전용 필드 상세**

lastAccessed (마지막 접근 시각, 캐시 전용)
  - 다운로드/미리보기 시 NOW()로 업데이트
  - LRU 정책에서 eviction 대상 선정 기준
  - CACHE_SEAWEED 레코드에서만 의미 있음

accessCount (접근 횟수, 캐시 전용)
  - 다운로드/미리보기 시 +1 증가
  - LFU 정책에서 eviction 대상 선정 기준
  - CACHE_SEAWEED 레코드에서만 의미 있음
  - 기본값: 1 (캐시 생성 시점 = 첫 접근)

leaseCount (읽기 중 삭제 방지, 캐시 전용)
  - 현재 파일을 읽고 있는 클라이언트 수
  - 다운로드/미리보기 시작 시 +1, 완료/실패 시 -1 (atomic 연산)
  - leaseCount > 0인 파일은 Eviction 대상에서 제외
  - CACHE_SEAWEED 레코드에서만 의미 있음
  - 기본값: 0

lastVerifiedAt (옵션, 마지막 검증 시각)

*제약*
```sql
UNIQUE(fileId, storageType) -- 같은 파일+저장소는 1개 레코드
INDEX(activeSyncEventId)    -- 작업 중인 파일 조회
INDEX(availabilityStatus)   -- 상태별 조회
```




#### <folders>

id

name (폴더명)

parentId (FK → folders.id, 상위 폴더)

path (전체 경로, 옵션 - 조회 최적화용)

state (ACTIVE / TRASHED / DELETED)

*참고: files.folderId가 이 테이블의 id를 참조함*

*제약/인덱스*
INDEX(parentId)
UNIQUE(parentId, name) -- 같은 상위 폴더 내 폴더명 중복 금지


#### <folder_storage_objects> (폴더 저장소 객체 - NAS 동기화 상태 관리)

*목적: 폴더의 NAS 동기화 상태 관리 + 동시성 제어 (파일과 동일한 패턴)*
*참고: 폴더는 SeaweedFS(캐시)에 저장되지 않음, NAS만 해당*

```
id (UUID, PK)

folderId (FK → folders.id)

storageType (NAS) -- 폴더는 NAS만 해당

storageLocator (192.168.xxx.xxx 등 NAS 주소)

objectKey (NAS 경로, 예: /a/b/c/folder_name)

activeSyncEventId (FK → sync_events.id, NULL이면 idle)

availabilityStatus (단순화 - 4개)
  - AVAILABLE: NAS에 정상 생성됨 (수정 가능)
  - BUSY: 작업 진행 중 (activeSyncEventId로 구체적 작업 확인)
  - MISSING: NAS에 없음
  - ERROR: 동기화/이동 실패 (수동 처리 필요)

lastVerifiedAt (옵션, 마지막 검증 시각)
createdAt
updatedAt
```

*제약/인덱스*
```sql
UNIQUE(folderId, storageType)  -- 같은 폴더+저장소는 1개 레코드
INDEX(activeSyncEventId)       -- 작업 중인 폴더 조회
INDEX(availabilityStatus)      -- 상태별 조회
```





### ㄷ. 휴지통 ===============================

*설계 방식: files.state=TRASHED로 휴지통 상태 관리 + trash_metadata로 삭제 정보 보관*

<trash_metadata> (휴지통 메타정보)

id

fileId (FK → files.id) -- 파일인 경우
folderId (FK → folders.id) -- 폴더인 경우 (둘 중 하나만 NOT NULL)

deletedAt (삭제 시각, 휴지통에 들어온 시간)

deletedBy (삭제한 사용자)

originalFolderId (FK → folders.id, 원래 상위 폴더 ID)

originalPath (삭제 시점의 전체 경로, VARCHAR)
  - 예: "/projects/work/documents/report.pdf"
  - 복구 시 경로 변경 감지용

expiresAt (자동 영구삭제 예정 시각, TIMESTAMP)

*제약/인덱스*
CHECK (fileId IS NOT NULL OR folderId IS NOT NULL) -- 둘 중 하나 필수
INDEX(fileId)
INDEX(folderId)
INDEX(expiresAt) -- 만료 대상 조회용




## 캐싱 관련 엔티티

### cache_settings (캐시 설정)

```
<cache_settings>

id (PK)

maxCacheSizeBytes (최대 캐시 용량, bytes)
  - 기본값: 10GB (10737418240)

evictionPolicy (캐시 제거 정책)
  - LRU / LFU / FIFO
  - 기본값: LRU

thresholdPercent (임계값, %)
  - 기본값: 80
  - 이 비율 초과 시 eviction 시작

targetPercent (목표 사용률, %)
  - 기본값: 70
  - eviction 후 도달할 목표 사용률

batchSize (배치 크기)
  - 기본값: 100
  - 한 번에 조회/처리할 파일 수

createdAt
updatedAt
```



## 엔티티 정의

### <share_links> (공유 링크)

```
id (UUID, PK)
shareCode (고유 공유 코드, URL에 사용)
createdBy (FK → users.id, 생성자)
resourceType (FILE / FOLDER)
resourceId (FK → files.id 또는 folders.id)
title (공유 제목, 표시용)
description (공유 설명, 옵션)

-- 접근 제어
accessType (PUBLIC / PROTECTED / PRIVATE)
  - PUBLIC: 링크만 있으면 접근 가능
  - PROTECTED: 비밀번호 필요
  - PRIVATE: 지정된 게스트 유저만 접근 가능
password (해시된 비밀번호, PROTECTED인 경우)

-- 기간 제어
startsAt (공유 시작 시각)
expiresAt (공유 만료 시각)

-- 다운로드 제어
maxDownloads (최대 다운로드 횟수, NULL = 무제한)
currentDownloads (현재 다운로드 횟수)

-- 추가 제어
allowPreview (미리보기 허용 여부)
allowDownload (다운로드 허용 여부)
allowedIpRanges (허용 IP 범위, JSON 배열, 옵션)

-- 상태
status (ACTIVE / EXPIRED / DISABLED / DELETED)
createdAt
updatedAt

*인덱스*
UNIQUE(shareCode)
INDEX(createdBy, status)
INDEX(resourceType, resourceId)
INDEX(expiresAt, status)
```

---

### <guest_users> (게스트 유저)

```
id (UUID, PK)
email (이메일, 식별자)
name (이름, 표시용)
phone (전화번호, 옵션)
company (소속 회사, 옵션)

-- 인증
passwordHash (비밀번호 해시, 옵션 - 계정 보호용)
isEmailVerified (이메일 인증 여부)
verificationToken (인증 토큰)
verificationExpiresAt (인증 만료 시각)

-- 상태
status (ACTIVE / SUSPENDED / DELETED)
lastAccessedAt (마지막 접근 시각)
createdAt
updatedAt
createdBy (FK → users.id, 생성한 내부 사용자)

*인덱스*
UNIQUE(email)
INDEX(status, createdBy)
INDEX(lastAccessedAt)
```

---

### <share_link_guests> (공유 링크-게스트 매핑)

```
id (UUID, PK)
shareLinkId (FK → share_links.id)
guestUserId (FK → guest_users.id)
grantedBy (FK → users.id, 권한 부여자)
grantedAt (권한 부여 시각)

*제약*
UNIQUE(shareLinkId, guestUserId)
```

---

### <share_access_logs> (공유 접근 로그)

```
id (UUID, PK)
shareLinkId (FK → share_links.id)
guestUserId (FK → guest_users.id, 옵션 - PUBLIC인 경우 NULL)
accessType ( DOWNLOAD / PREVIEW)
accessIp (접근 IP)
userAgent (브라우저/클라이언트 정보)
accessedAt (접근 시각)
success (성공 여부)
failReason (실패 사유, 옵션)

*인덱스*
INDEX(shareLinkId, accessedAt)
INDEX(guestUserId, accessedAt)
INDEX(accessedAt)
```

---

### <share_policies> (공유 정책 - 마스터 관리자용)

```
id (UUID, PK)
policyName (정책명)

-- 기본값 설정
defaultMaxDays (기본 최대 공유 기간, 일)
defaultMaxDownloads (기본 최대 다운로드 횟수)

-- 제한 설정
maxDownloads (최대 다운로드 횟수)
maxExpiryDays (최대 만료일)

-- 보안 설정
requirePassword (비밀번호 필수 여부)

isActive (활성화 여부)
createdAt
updatedAt

*제약*
-- 기본 정책은 1개만 존재 (isDefault 플래그 또는 ID 고정)
```

---