# 대외 공유 시스템

## 개요

내부 파일 리소스를 외부 사용자(게스트)에게 안전하게 공유하기 위한 시스템
- 공유 기간, 다운로드 횟수 등 세밀한 제어 가능
- 게스트 유저 관리를 통한 접근 통제
- 마스터 관리자의 전체 공유 현황 모니터링

---

## 액터 정의

| 액터 | 설명 |
|------|------|
| **내부 사용자 (Internal User)** | 파일을 소유하고 공유 링크를 생성하는 사용자 |
| **게스트 유저 (Guest User)** | 공유 링크를 통해 파일에 접근하는 외부 사용자 |
| **마스터 관리자 (Master Admin)** | 전체 공유 시스템을 관리하고 모니터링하는 관리자 |

---


## 유즈 케이스

### UC-01. 공유 링크 생성

**액터**: 내부 사용자

**선행 조건**:
- 사용자가 로그인 상태
- 공유할 파일에 대한 접근 권한 보유

**기본 플로우**:
```
1. 사용자가 파일 선택 후 "외부 공유" 요청
2. 시스템이 공유 정책 확인 (파일 크기, 타입, 사용자 공유 한도)
3. 사용자가 공유 설정 입력:
   - 공유 제목/설명
   - 접근 유형 (PUBLIC/PROTECTED/PRIVATE)
   - 공유 기간 (시작일, 종료일)
   - 다운로드 횟수 제한
   - 비밀번호 (PROTECTED인 경우)
   - 미리보기/다운로드 허용 여부
4. 시스템이 고유 shareCode 생성
5. 시스템이 share_links 레코드 생성
6. 시스템이 공유 URL 반환
```

**대안 플로우**:
- 3a. 정책 위반 시 → 에러 메시지 + 허용 범위 안내
- 4a. PRIVATE인 경우 → 게스트 유저 지정 화면으로 이동 (UC-06)

**후행 조건**:
- 공유 링크 생성 완료
- share_links 레코드 INSERT
- 감사 로그 기록

---

### UC-02. 공유 링크 수정

**액터**: 내부 사용자

**선행 조건**:
- 해당 공유 링크의 생성자이거나 관리 권한 보유
- 공유 링크가 DELETED 상태가 아님

**기본 플로우**:
```
1. 사용자가 공유 링크 목록에서 수정할 링크 선택
2. 시스템이 현재 설정 표시
3. 사용자가 설정 변경:
   - 공유 기간 연장/단축
   - 다운로드 횟수 제한 변경
   - 비밀번호 변경
   - 접근 유형 변경
4. 시스템이 정책 검증
5. 시스템이 share_links 레코드 UPDATE
6. 변경 완료 알림
```

**대안 플로우**:
- 3a. 다운로드 횟수를 현재 사용량보다 낮게 설정 시 → 경고 표시
- 4a. 정책 위반 시 → 에러 메시지

---

### UC-03. 공유 링크 비활성화/삭제

**액터**: 내부 사용자, 마스터 관리자

**선행 조건**:
- 해당 공유 링크에 대한 관리 권한

**기본 플로우**:
```
1. 사용자가 공유 링크 선택 후 "비활성화" 또는 "삭제" 요청
2. 시스템이 확인 다이얼로그 표시
3. 사용자 확인
4. 비활성화: status = DISABLED
   삭제: status = DELETED (소프트 삭제)
5. 기존 공유 URL 접근 시 "공유가 종료되었습니다" 표시
```

**후행 조건**:
- 해당 공유 링크로 더 이상 접근 불가
- 감사 로그 기록

---

### UC-04. 공유 링크 목록 조회

**액터**: 내부 사용자

**선행 조건**:
- 사용자가 로그인 상태

**기본 플로우**:
```
1. 사용자가 "내 공유" 메뉴 접근
2. 시스템이 해당 사용자가 생성한 공유 링크 목록 조회
3. 각 링크에 대해 표시:
   - 공유 제목
   - 대상 파일명
   - 접근 유형
   - 공유 기간 (시작~종료)
   - 다운로드 현황 (현재/최대)
   - 상태 (활성/만료/비활성)
   - 마지막 접근 시각
4. 필터/정렬 기능 제공:
   - 상태별 필터
   - 생성일/만료일 정렬
   - 검색 (제목, 파일명)
```

---

### UC-05. 게스트 유저 생성

**액터**: 내부 사용자, 마스터 관리자

**선행 조건**:
- 로그인 상태
- 게스트 유저 생성 권한 보유

**기본 플로우**:
```
1. 사용자가 "게스트 유저 추가" 요청
2. 게스트 정보 입력:
   - 이메일 (필수)
   - 이름 (필수)
   - 전화번호 (옵션)
   - 소속 회사 (옵션)
3. 시스템이 이메일 중복 검사
4. 시스템이 guest_users 레코드 생성
5. (정책에 따라) 이메일 인증 링크 발송
6. 게스트 유저 생성 완료
```

**대안 플로우**:
- 3a. 이메일 중복 시:
  - 기존 게스트 유저 정보 표시
  - 해당 게스트에게 새 공유 권한 부여 가능 안내

**후행 조건**:
- guest_users 레코드 INSERT
- (선택) 이메일 인증 대기 상태

---

### UC-06. 게스트 유저에 공유 권한 부여

**액터**: 내부 사용자

**선행 조건**:
- 공유 링크가 PRIVATE 유형이거나 특정 게스트 지정 필요
- 게스트 유저가 존재

**기본 플로우**:
```
1. 사용자가 공유 링크의 "게스트 관리" 접근
2. 시스템이 현재 권한 부여된 게스트 목록 표시
3. 사용자가 "게스트 추가" 선택
4. 게스트 검색 (이메일/이름) 또는 새 게스트 생성
5. 권한 설정:
   - 권한 유형 (VIEW / DOWNLOAD)
   - 개별 만료일 (옵션)
6. 시스템이 share_link_guests 레코드 생성
7. (선택) 게스트에게 공유 알림 이메일 발송
```

---

### UC-07. 게스트 유저 권한 해제

**액터**: 내부 사용자, 마스터 관리자

**선행 조건**:
- 해당 공유 링크에 대한 관리 권한

**기본 플로우**:
```
1. 사용자가 공유 링크의 게스트 목록 조회
2. 권한 해제할 게스트 선택
3. "권한 해제" 확인
4. 시스템이 share_link_guests 레코드 DELETE
5. 해당 게스트는 더 이상 공유 링크 접근 불가
```

---

### UC-08. 공유 링크 접근 (게스트)

**액터**: 게스트 유저 (또는 익명 사용자)

**선행 조건**:
- 유효한 공유 URL 보유

**기본 플로우**:
```
1. 게스트가 공유 URL 접근
2. 시스템이 shareCode로 share_links 조회
3. 시스템이 유효성 검증:
   - status = ACTIVE 확인
   - 현재 시각이 startsAt ~ expiresAt 범위 내
   - 다운로드 횟수가 maxDownloads 미만 (다운로드 요청 시)
   - (PROTECTED) 비밀번호 검증
   - (PRIVATE) 게스트 유저 권한 검증
   - (옵션) IP 제한 검증
4. 검증 통과 시:
   - 파일: 미리보기/다운로드 화면 표시
5. share_access_logs에 접근 기록
```

**대안 플로우**:
- 3a. 만료된 경우 → "공유 기간이 종료되었습니다"
- 3b. 다운로드 한도 초과 → "다운로드 한도에 도달했습니다"
- 3c. 비밀번호 불일치 → 비밀번호 재입력 요청
- 3d. 권한 없음 → "접근 권한이 없습니다"
- 3e. IP 제한 → "허용되지 않은 네트워크입니다"

---

### UC-09. 파일 다운로드 (게스트)

**액터**: 게스트 유저

**선행 조건**:
- UC-08 완료 (공유 링크 접근 성공)
- allowDownload = true
- 다운로드 횟수 한도 미도달

**기본 플로우**:
```
1. 게스트가 "다운로드" 버튼 클릭
2. 시스템이 다운로드 가능 여부 재검증
3. 시스템이 currentDownloads 증가
4. 파일 스트림 전송
5. share_access_logs에 다운로드 기록
6. (한도 도달 시) 공유 링크 상태 업데이트
```

---

### UC-10. 파일 미리보기 (게스트)

**액터**: 게스트 유저

**선행 조건**:
- UC-08 완료 (공유 링크 접근 성공)
- allowPreview = true
- 미리보기 가능한 파일 형식

**기본 플로우**:
```
1. 게스트가 파일 선택 또는 자동 미리보기
2. 시스템이 미리보기 가능 여부 확인
3. 파일 유형에 따른 미리보기 제공:
   - 이미지: 이미지 뷰어
   - PDF: PDF 뷰어
   - 문서: 웹 뷰어 또는 변환 후 표시
   - 동영상: 스트리밍 플레이어
4. share_access_logs에 미리보기 기록
```

---

### UC-11. 게스트 로그인/인증

**액터**: 게스트 유저

**선행 조건**:
- PRIVATE 공유 링크 접근 또는 계정 기반 접근

**기본 플로우**:
```
1. 게스트가 공유 링크 접근
2. 시스템이 게스트 로그인 요청
3. 게스트가 이메일/비밀번호 입력
4. 시스템이 guest_users 조회 및 인증
5. 세션 생성 (제한된 권한)
6. 공유 콘텐츠 접근 허용
```

**대안 플로우**:
- 3a. 비밀번호 미설정 상태:
  - 이메일 인증 링크 발송
  - 링크 클릭으로 접근

---

### UC-12. 전체 공유 현황 모니터링 (관리자)

**액터**: 마스터 관리자

**선행 조건**:
- 관리자 권한 로그인

**기본 플로우**:
```
1. 관리자가 "공유 관리" 대시보드 접근
2. 시스템이 전체 공유 통계 표시:
   - 총 활성 공유 수
   - 오늘 생성된 공유 수
   - 만료 예정 공유 (7일 내)
   - 다운로드 한도 임박 공유
   - 총 다운로드 횟수
3. 공유 목록 조회 (필터/검색):
   - 생성자별 필터
   - 상태별 필터
   - 기간 필터
   - 파일 유형 필터
4. 개별 공유 상세 조회:
   - 접근 로그
   - 게스트 목록
   - 다운로드 이력
```

---

### UC-13. 게스트 유저 전체 관리 (관리자)

**액터**: 마스터 관리자

**선행 조건**:
- 관리자 권한 로그인

**기본 플로우**:
```
1. 관리자가 "게스트 유저 관리" 접근
2. 시스템이 전체 게스트 유저 목록 표시:
   - 이메일, 이름, 소속
   - 상태 (활성/정지)
   - 마지막 접근
   - 부여된 공유 수
3. 관리 기능:
   - 게스트 정보 수정
   - 게스트 정지/해제
   - 게스트 삭제 (및 모든 권한 해제)
   - 게스트 활동 로그 조회
```

---

### UC-14. 공유 정책 설정 (관리자)

**액터**: 마스터 관리자

**선행 조건**:
- 관리자 권한 로그인

**기본 플로우**:
```
1. 관리자가 "공유 정책 설정" 접근
2. 시스템이 현재 정책 표시
3. 관리자가 정책 수정:
   - 기본 공유 기간 (최대 N일)
   - 기본 다운로드 횟수
   - 공유 가능 최대 파일 크기
   - 사용자당 공유 한도
   - 공유당 게스트 한도
   - 허용/차단 파일 타입
   - PUBLIC 공유 허용 여부
   - 비밀번호 필수 여부
4. 시스템이 정책 저장
5. 새 공유 생성 시 정책 적용
```

**후행 조건**:
- 기존 공유에는 영향 없음
- 새 공유 생성 시 정책 적용

---

### UC-15. 감사 로그 조회 (관리자)

**액터**: 마스터 관리자

**선행 조건**:
- 관리자 권한 로그인

**기본 플로우**:
```
1. 관리자가 "감사 로그" 접근
2. 필터 설정:
   - 기간
   - 액션 유형 (생성/수정/삭제/접근/다운로드)
   - 사용자/게스트
   - 공유 링크
   - IP 주소
3. 시스템이 로그 목록 표시:
   - 시각
   - 액션 유형
   - 수행자
   - 대상 리소스
   - IP 주소
   - 결과 (성공/실패)
4. 상세 조회 및 CSV 내보내기 가능
```

---

### UC-16. 공유 알림/리마인더

**액터**: 시스템 (자동), 내부 사용자

**트리거**:
- 공유 만료 7일/1일 전
- 다운로드 한도 80%/100% 도달
- 게스트 첫 접근 시

**기본 플로우**:
```
1. 시스템이 조건 감지
2. 공유 생성자에게 알림 발송:
   - 이메일
   - 인앱 알림
3. 생성자가 공유 연장/수정 선택 가능
```

---

### UC-17. 만료된 공유 자동 처리

**액터**: 시스템 (배치)

**트리거**:
- 매일 정해진 시각 (예: 00:00)

**기본 플로우**:
```
1. 배치 스케줄러 실행
2. expiresAt < NOW() 인 share_links 조회
3. status = EXPIRED로 업데이트
4. (정책에 따라) 일정 기간 후 자동 삭제
5. 로그 기록
```

---

## 플로우 다이어그램

### 공유 링크 생성 → 게스트 접근 전체 플로우

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  [내부 사용자]                                                               │
│       │                                                                     │
│       │ 1. 파일 선택                                                    │
│       ↓                                                                     │
│  ┌──────────┐     2. 정책 검증      ┌──────────────┐                        │
│  │ 공유 생성 │ ─────────────────→  │ share_policies│                        │
│  │  요청    │                      └──────────────┘                        │
│  └────┬─────┘                                                               │
│       │                                                                     │
│       │ 3. 공유 설정 입력                                                    │
│       │    - 기간, 횟수, 접근유형                                            │
│       ↓                                                                     │
│  ┌──────────┐                                                               │
│  │share_links│ ← INSERT                                                    │
│  └────┬─────┘                                                               │
│       │                                                                     │
│       │ 4. (PRIVATE인 경우)                                                 │
│       ↓                                                                     │
│  ┌──────────────────┐                                                       │
│  │share_link_guests │ ← 게스트 매핑                                         │
│  └────┬─────────────┘                                                       │
│       │                                                                     │
│       │ 5. 공유 URL 생성                                                    │
│       ↓                                                                     │
│  https://domain/s/{shareCode}                                              │
│                                                                             │
│ ════════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  [게스트 유저]                                                               │
│       │                                                                     │
│       │ 6. URL 접근                                                         │
│       ↓                                                                     │
│  ┌──────────────────────────────────────────┐                               │
│  │            유효성 검증                     │                               │
│  │  ┌─────────────────────────────────────┐ │                               │
│  │  │ • 상태 확인 (ACTIVE?)               │ │                               │
│  │  │ • 기간 확인 (startsAt~expiresAt)    │ │                               │
│  │  │ • 다운로드 횟수 확인                 │ │                               │
│  │  │ • 접근 유형별 추가 검증              │ │                               │
│  │  │   - PUBLIC: 즉시 허용               │ │                               │
│  │  │   - PROTECTED: 비밀번호 확인        │ │                               │
│  │  │   - PRIVATE: 게스트 권한 확인       │ │                               │
│  │  └─────────────────────────────────────┘ │                               │
│  └────┬──────────────────┬──────────────────┘                               │
│       │                  │                                                  │
│       │ 성공             │ 실패                                             │
│       ↓                  ↓                                                  │
│  ┌──────────┐      ┌──────────────┐                                         │
│  │ 콘텐츠   │      │ 에러 페이지   │                                         │
│  │ 표시     │      │ (만료/한도/..)│                                         │
│  └────┬─────┘      └──────────────┘                                         │
│       │                                                                     │
│       │ 7. 미리보기/다운로드                                                 │
│       ↓                                                                     │
│  ┌──────────────────┐                                                       │
│  │share_access_logs │ ← 로그 기록                                           │
│  └──────────────────┘                                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 접근 유형별 시나리오

### PUBLIC (공개 링크)

```
┌─────────────────────────────────────────────────────────────────────┐
│  [시나리오: 일시적 파일 공유]                                         │
│                                                                     │
│  사용 예시: 클라이언트에게 시안 파일 전달                             │
│                                                                     │
│  설정:                                                              │
│  - accessType: PUBLIC                                               │
│  - expiresAt: 7일 후                                                │
│  - maxDownloads: 10회                                               │
│                                                                     │
│  접근 흐름:                                                          │
│  1. 링크 클릭                                                        │
│  2. 즉시 파일 표시 (인증 없음)                                       │
│  3. 다운로드 가능                                                    │
│                                                                     │
│  보안: 낮음 (링크 유출 시 누구나 접근)                               │
└─────────────────────────────────────────────────────────────────────┘
```

### PROTECTED (비밀번호 보호)

```
┌─────────────────────────────────────────────────────────────────────┐
│  [시나리오: 제한된 공개 공유]                                         │
│                                                                     │
│  사용 예시: 협력사에 기밀 문서 전달                                   │
│                                                                     │
│  설정:                                                              │
│  - accessType: PROTECTED                                            │
│  - password: "secure123"                                            │
│  - expiresAt: 30일 후                                               │
│  - maxDownloads: 5회                                                │
│                                                                     │
│  접근 흐름:                                                          │
│  1. 링크 클릭                                                        │
│  2. 비밀번호 입력 화면                                               │
│  3. 비밀번호 검증                                                    │
│  4. 파일 표시                                                        │
│                                                                     │
│  보안: 중간 (링크 + 비밀번호 필요)                                   │
└─────────────────────────────────────────────────────────────────────┘
```

### PRIVATE (지정 게스트만)

```
┌─────────────────────────────────────────────────────────────────────┐
│  [시나리오: 특정인 전용 공유]                                         │
│                                                                     │
│  사용 예시: 외부 감사인에게 재무 자료 제공                            │
│                                                                     │
│  설정:                                                              │
│  - accessType: PRIVATE                                              │
│  - 게스트: auditor@partner.com                                      │
│  - permission: VIEW (다운로드 불가)                                 │
│  - expiresAt: 감사 종료일                                           │
│                                                                     │
│  접근 흐름:                                                          │
│  1. 링크 클릭                                                        │
│  2. 게스트 로그인 화면                                               │
│  3. 이메일/비밀번호 또는 이메일 인증                                  │
│  4. 권한 확인                                                        │
│  5. 파일 표시 (미리보기만)                                           │
│                                                                     │
│  보안: 높음 (지정된 사용자만 접근)                                   │
└─────────────────────────────────────────────────────────────────────┘
```

---

## API 엔드포인트

### 내부 사용자용

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | /api/shares | 공유 링크 생성 |
| GET | /api/shares | 내 공유 목록 조회 |
| GET | /api/shares/{id} | 공유 상세 조회 |
| PUT | /api/shares/{id} | 공유 수정 |
| DELETE | /api/shares/{id} | 공유 삭제 |
| POST | /api/shares/{id}/guests | 게스트 권한 부여 |
| DELETE | /api/shares/{id}/guests/{guestId} | 게스트 권한 해제 |
| GET | /api/shares/{id}/logs | 접근 로그 조회 |

### 게스트용

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | /s/{shareCode} | 공유 링크 접근 |
| POST | /s/{shareCode}/verify | 비밀번호 검증 |
| POST | /s/{shareCode}/auth | 게스트 로그인 |
| GET | /s/{shareCode}/download | 파일 다운로드 |
| GET | /s/{shareCode}/preview | 파일 미리보기 |
| GET | /s/{shareCode}/files | 파일 목록 |

### 관리자용

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | /api/admin/shares | 전체 공유 목록 |
| GET | /api/admin/shares/stats | 공유 통계 |
| PUT | /api/admin/shares/{id}/disable | 공유 강제 비활성화 |
| GET | /api/admin/guests | 전체 게스트 목록 |
| PUT | /api/admin/guests/{id}/suspend | 게스트 정지 |
| GET | /api/admin/policies | 공유 정책 조회 |
| PUT | /api/admin/policies | 공유 정책 수정 |
| GET | /api/admin/audit-logs | 감사 로그 조회 |

---

## 보안 고려사항

### 1. 링크 보안
- shareCode는 충분히 길고 예측 불가능한 UUID 또는 랜덤 문자열 사용
- 무차별 대입 공격 방지: 잘못된 비밀번호 N회 시 일시 차단
- 속도 제한(Rate Limiting) 적용

### 2. 데이터 보안
- 비밀번호는 bcrypt 등으로 해싱
- HTTPS 강제
- 다운로드 시 일회성 토큰 발급 (링크 유출 방지)

### 3. 접근 제어
- IP 화이트리스트 옵션
- 특정 시간대만 접근 허용 옵션
- 2단계 인증 옵션 (이메일 OTP)

### 4. 감사 및 모니터링
- 모든 접근/다운로드 로깅
- 비정상 접근 패턴 감지 (동일 IP 다수 접근 등)
- 실시간 알림 (관리자)

---

## 알림 템플릿

### 공유 생성 알림 (게스트에게)

```
제목: [회사명] 파일이 공유되었습니다

안녕하세요, {guestName}님

{creatorName}님이 파일을 공유했습니다.

공유 제목: {shareTitle}
공유 기간: {startsAt} ~ {expiresAt}

아래 링크를 클릭하여 파일에 접근하세요:
{shareUrl}

{(PROTECTED인 경우) 비밀번호: 별도 안내}
```

### 만료 임박 알림 (생성자에게)

```
제목: [공유 만료 임박] {shareTitle}

생성하신 공유 링크가 곧 만료됩니다.

공유 제목: {shareTitle}
만료일: {expiresAt}
남은 기간: {remainingDays}일

다운로드 현황: {currentDownloads}/{maxDownloads}

공유를 연장하시려면 아래 버튼을 클릭하세요:
[공유 관리로 이동]
```

---

## 확장 고려사항

### 1. 워터마크
- 미리보기/다운로드 시 워터마크 삽입
- 게스트 정보, 다운로드 일시 포함

### 2. 승인 워크플로우
- 민감 파일 공유 시 관리자 승인 필요
- 승인 대기 상태 추가

### 3. 공유 템플릿
- 자주 사용하는 공유 설정을 템플릿으로 저장
- 빠른 공유 생성

### 4. 공유 분석
- 다운로드 패턴 분석
- 게스트 활동 리포트
- 공유 효과 측정

### 5. 외부 시스템 연동
- SSO 연동 (게스트 계정)
- CRM 연동 (고객 정보)
- 알림 시스템 연동 (Slack, Teams)
