

##### ã„·. íœ´ì§€í†µ ===============================


---

## íŒŒì¼ íœ´ì§€í†µ ì²˜ë¦¬

---

##### 1.íœ´ì§€í†µ ì¡°íšŒ:íœ´ì§€í†µì— ìˆëŠ” íŒŒì¼, í´ë” ëª©ë¡ ì¡°íšŒ

---

**ì²˜ë¦¬ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨ (ìœˆë„ìš° íœ´ì§€í†µ ë°©ì‹)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [íœ´ì§€í†µ ì¡°íšŒ - ìœˆë„ìš° íœ´ì§€í†µ ìŠ¤íƒ€ì¼]                                      â”‚
â”‚                                                                         â”‚
â”‚  â€» í”Œë« ë¦¬ìŠ¤íŠ¸: ëª¨ë“  ì‚­ì œ í•­ëª©ì´ ë‹¨ì¼ ë ˆë²¨ë¡œ ë‚˜ì—´                         â”‚
â”‚  â€» í´ë” ì•ˆìœ¼ë¡œ ë“¤ì–´ê°€ì§€ ì•ŠìŒ (í´ë”ë„ í•˜ë‚˜ì˜ í•­ëª©)                         â”‚
â”‚  â€» ì›ë˜ ìœ„ì¹˜ë¡œ ë³µì›                                                      â”‚
â”‚                                                                         â”‚
â”‚  GET /trash                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ì´ë¦„              â”‚ ì›ë˜ ìœ„ì¹˜                  â”‚ ì‚­ì œëœ ë‚ ì§œ  â”‚ í¬ê¸°  â”‚ â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚
â”‚  â”‚ ğŸ“ test          â”‚ C:\Users\USER\Desktop\scan â”‚ 01-20 ì˜¤í›„5:36â”‚ 0KB  â”‚ â”‚
â”‚  â”‚ ğŸ“ test          â”‚ C:\Users\USER\Desktop      â”‚ 01-20 ì˜¤í›„5:36â”‚ 0KB  â”‚ â”‚
â”‚  â”‚ ğŸ“„ 1231.txt      â”‚ C:\Users\USER\Desktop\scan\testâ”‚ 01-20 ì˜¤í›„5:36â”‚ 0KBâ”‚ â”‚
â”‚  â”‚ ğŸ“„ 123123.txt    â”‚ C:\Users\USER\Desktop\scan â”‚ 01-20 ì˜¤í›„5:37â”‚ 0KB  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â”‚  [íŠ¹ì§•]                                                                  â”‚
â”‚  - í´ë” ì‚­ì œ ì‹œ: í´ë” ìì²´ê°€ í•˜ë‚˜ì˜ í•­ëª©ìœ¼ë¡œ í‘œì‹œ                          â”‚
â”‚  - íŒŒì¼ ì‚­ì œ ì‹œ: íŒŒì¼ì´ í•˜ë‚˜ì˜ í•­ëª©ìœ¼ë¡œ í‘œì‹œ                               â”‚
â”‚  - ê°™ì€ ì´ë¦„ë„ ì›ë˜ ìœ„ì¹˜ê°€ ë‹¤ë¥´ë©´ ë³„ë„ í•­ëª©                                â”‚
â”‚  - ë³µì›: ì›ë˜ ìœ„ì¹˜ë¡œ ë³µì› (ê²½ë¡œ ì—†ìœ¼ë©´ ìƒì„±)                               â”‚
â”‚  - ì˜êµ¬ì‚­ì œ: ì„ íƒí•œ í•­ëª© ì˜êµ¬ì‚­ì œ                                          â”‚
â”‚  - íœ´ì§€í†µ ë¹„ìš°ê¸°: ì „ì²´ ì˜êµ¬ì‚­ì œ                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**API: GET /trash**

---

**[STEP 1] ì¡°íšŒ ìš”ì²­**

1)ìœ ì €(íœ´ì§€í†µ ì¡°íšŒí•´ì¤˜)===> 

---

**[STEP 2] DB ì¡°íšŒ (íŒŒì¼ + í´ë” - í”Œë« ë¦¬ìŠ¤íŠ¸)**

2-1) ê°œë³„ ì‚­ì œëœ íŒŒì¼ ì¡°íšŒ (trash_metadataì— fileIdê°€ ìˆëŠ” ê²½ìš°)
```sql
SELECT 
  'FILE' as type,
  f.id,
  f.name,
  f.sizeBytes,
  f.mimeType,
  tm.id as trashMetadataId,
  tm.originalPath,
  tm.deletedAt,
  tm.deletedBy,
  tm.expiresAt,
  f.updatedAt as modifiedAt
FROM files f
INNER JOIN trash_metadata tm ON f.id = tm.fileId
WHERE f.state = 'TRASHED'
  AND tm.fileId IS NOT NULL;
```

2-2) í´ë” ë‹¨ìœ„ë¡œ ì‚­ì œëœ ìµœìƒìœ„ í´ë” ì¡°íšŒ (trash_metadataì— folderIdê°€ ìˆëŠ” ê²½ìš°)
```sql
SELECT 
  'FOLDER' as type,
  fo.id,
  fo.name,
  NULL as sizeBytes,
  'folder' as mimeType,
  tm.id as trashMetadataId,
  tm.originalPath,
  tm.deletedAt,
  tm.deletedBy,
  tm.expiresAt,
  fo.updatedAt as modifiedAt
FROM folders fo
INNER JOIN trash_metadata tm ON fo.id = tm.folderId
WHERE fo.state = 'TRASHED'
  AND tm.folderId IS NOT NULL;
```

2-3) UNIONìœ¼ë¡œ í•©ì³ì„œ ì •ë ¬
```sql
-- íŒŒì¼ + í´ë” í•©ì³ì„œ ì‚­ì œì¼ ê¸°ì¤€ ì •ë ¬
(íŒŒì¼ ì¿¼ë¦¬)
UNION ALL
(í´ë” ì¿¼ë¦¬)
ORDER BY deletedAt DESC;
```

---

**[STEP 3] ì‘ë‹µ ë°˜í™˜**

3)í”Œë« ë¦¬ìŠ¤íŠ¸ë¡œ ì‘ë‹µ 

```typescript
interface TrashListResponse {
  items: TrashItem[];
  totalCount: number;
  totalSizeBytes: number;        // íœ´ì§€í†µ ì „ì²´ í¬ê¸°
}

interface TrashItem {
  type: 'FILE' | 'FOLDER';
  id: string;
  name: string;
  
  // í¬ê¸° (íŒŒì¼ë§Œ, í´ë”ëŠ” null)
  sizeBytes?: number;
  mimeType?: string;
  
  // íœ´ì§€í†µ ë©”íƒ€ ì •ë³´
  trashMetadataId: string;       // íœ´ì§€í†µ ë©”íƒ€ ID (ë³µêµ¬/ì‚­ì œ ì‹œ ì‚¬ìš©)
  originalPath: string;          // ì›ë˜ ìœ„ì¹˜ (ìœˆë„ìš°ì˜ "ì›ë˜ ìœ„ì¹˜" ì»¬ëŸ¼)
  deletedAt: Date;               // ì‚­ì œëœ ë‚ ì§œ
  deletedBy: string;             // ì‚­ì œì
  modifiedAt: Date;              // ìˆ˜ì •í•œ ë‚ ì§œ (ì‚­ì œ ì „ ë§ˆì§€ë§‰ ìˆ˜ì •ì¼)
  expiresAt: Date;               // ìë™ ì˜êµ¬ì‚­ì œ ì˜ˆì •ì¼
}
```

---

**ì£¼ìš” ì•¡ì…˜**

| ì•¡ì…˜ | ì„¤ëª… | API |
|------|------|-----|
| **í•­ëª© ë³µì›** | ì„ íƒí•œ íŒŒì¼/í´ë”ë¥¼ ì›ë˜ ìœ„ì¹˜ë¡œ ë³µì› | `POST /trash/{trashMetadataId}/restore` |
| **í•­ëª© ì‚­ì œ** | ì„ íƒí•œ íŒŒì¼/í´ë”ë¥¼ ì˜êµ¬ì‚­ì œ | `DELETE /trash/{trashMetadataId}` |
| **íœ´ì§€í†µ ë¹„ìš°ê¸°** | íœ´ì§€í†µ ì „ì²´ ì˜êµ¬ì‚­ì œ | `DELETE /trash/all` |
| **ëª¨ë“  í•­ëª© ë³µì›** | íœ´ì§€í†µ ì „ì²´ ë³µì› | `POST /trash/restore-all` |

---

**íœ´ì§€í†µê³¼ ë™ì¼í•œ ë™ì‘**

```
[í´ë” ì‚­ì œ ì‹œ]
/root/path/test í´ë” ì‚­ì œ ìš”ì²­
  â†“
íœ´ì§€í†µì— "ğŸ“ test | /root/path | 01-20" í•­ëª© 1ê°œ í‘œì‹œ
  â†“
í´ë” ì•ˆì˜ íŒŒì¼/í´ë”ëŠ” íœ´ì§€í†µ ë¦¬ìŠ¤íŠ¸ì— í‘œì‹œë˜ì§€ ì•ŠìŒ
(í´ë” ë³µì› ì‹œ ë‚´ë¶€ íŒŒì¼/í´ë”ë„ í•¨ê»˜ ë³µì›)

[íŒŒì¼ ê°œë³„ ì‚­ì œ ì‹œ]
/root/path/test/file1.txt ì‚­ì œ ìš”ì²­
  â†“
íœ´ì§€í†µì— "ğŸ“„ file1.txt | /root/path/test | 01-20" í•­ëª© 1ê°œ í‘œì‹œ
```

---

**ì •ë ¬ ì˜µì…˜**

```typescript
// ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°
GET /trash?sortBy=deletedAt&order=desc

// ì •ë ¬ ê°€ëŠ¥ í•„ë“œ
sortBy: 'name' | 'originalPath' | 'deletedAt' | 'sizeBytes' | 'modifiedAt'
order: 'asc' | 'desc'
```

---

##### 1-1.íœ´ì§€í†µ í´ë” ë‚´ë¶€ íƒìƒ‰:ì‚­ì œëœ í´ë” ë‚´ë¶€ íŒŒì¼/í´ë” ì¡°íšŒ

---

**ì²˜ë¦¬ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [íœ´ì§€í†µ í´ë” ë‚´ë¶€ íƒìƒ‰]                                                   â”‚
â”‚                                                                         â”‚
â”‚  â€» ìœˆë„ìš° íœ´ì§€í†µ ê¸°ë³¸ ë™ì‘ê³¼ ë‹¬ë¦¬, í´ë” ë”ë¸”í´ë¦­ ì‹œ ë‚´ë¶€ íƒìƒ‰ ì œê³µ           â”‚
â”‚  â€» ì½ê¸° ì „ìš©: íƒìƒ‰ë§Œ ê°€ëŠ¥, ê°œë³„ ë³µêµ¬/ì‚­ì œëŠ” ìµœìƒìœ„ í´ë” ë‹¨ìœ„ë¡œë§Œ             â”‚
â”‚                                                                         â”‚
â”‚  [íœ´ì§€í†µ ë£¨íŠ¸]                                                            â”‚
â”‚  â”œâ”€â”€ ğŸ“ project (ë”ë¸”í´ë¦­) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”œâ”€â”€ ğŸ“ backup                                                   â”‚       â”‚
â”‚  â””â”€â”€ ğŸ“„ file1.txt                                                â”‚       â”‚
â”‚                                                                  â†“       â”‚
â”‚  [project í´ë” ë‚´ë¶€]                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“‚ íœ´ì§€í†µ > project                                 [â† ë’¤ë¡œê°€ê¸°]   â”‚ â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚
â”‚  â”‚ ğŸ“ src         â”‚ 2026-01-15 â”‚ -                                    â”‚ â”‚
â”‚  â”‚ ğŸ“ docs        â”‚ 2026-01-14 â”‚ -                                    â”‚ â”‚
â”‚  â”‚ ğŸ“„ README.md   â”‚ 2026-01-10 â”‚ 2.5KB                                â”‚ â”‚
â”‚  â”‚ ğŸ“„ config.json â”‚ 2026-01-08 â”‚ 1.2KB                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â”‚  â€» src í´ë” ë”ë¸”í´ë¦­ â†’ src í´ë” ë‚´ë¶€ íƒìƒ‰ (ê³„ì† depth ì´ë™ ê°€ëŠ¥)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**API: GET /trash/folders/{folderId}/contents**

**ëª©ì **: íœ´ì§€í†µì— ìˆëŠ” í´ë”ì˜ ë‚´ë¶€ íŒŒì¼/í´ë” ëª©ë¡ ì¡°íšŒ

---

**[STEP 1] íƒìƒ‰ ìš”ì²­**

1)ìœ ì €(íœ´ì§€í†µì—ì„œ project í´ë” ë”ë¸”í´ë¦­)===> 

---

**[STEP 2] í´ë” ìƒíƒœ ê²€ì¦ + ë‚´ìš© ì¡°íšŒ**

2-1) í´ë”ê°€ íœ´ì§€í†µ ìƒíƒœì¸ì§€ í™•ì¸
```sql
-- í•´ë‹¹ í´ë”ê°€ TRASHED ìƒíƒœì¸ì§€ í™•ì¸
SELECT id, name, parentId, state 
FROM folders 
WHERE id = ëŒ€ìƒí´ë”ID AND state = 'TRASHED';
```

2-2) í•´ë‹¹ í´ë” ë°”ë¡œ ì•„ë˜ì˜ íŒŒì¼/í´ë” ì¡°íšŒ (ì§ì ‘ í•˜ìœ„ë§Œ, ì¬ê·€ X)
```sql
-- í•˜ìœ„ í´ë” ì¡°íšŒ
SELECT 
  'FOLDER' as type,
  fo.id,
  fo.name,
  NULL as sizeBytes,
  NULL as mimeType,
  fo.updatedAt as modifiedAt
FROM folders fo
WHERE fo.parentId = ëŒ€ìƒí´ë”ID 
  AND fo.state = 'TRASHED'
ORDER BY fo.name;

-- í•˜ìœ„ íŒŒì¼ ì¡°íšŒ
SELECT 
  'FILE' as type,
  f.id,
  f.name,
  f.sizeBytes,
  f.mimeType,
  f.updatedAt as modifiedAt
FROM files f
WHERE f.folderId = ëŒ€ìƒí´ë”ID 
  AND f.state = 'TRASHED'
ORDER BY f.name;
```

---

**[STEP 3] ì‘ë‹µ ë°˜í™˜**

```typescript
interface TrashFolderContentsResponse {
  // í˜„ì¬ í´ë” ì •ë³´
  currentFolder: {
    id: string;
    name: string;
  };
  
  // ìƒìœ„ í´ë” ì •ë³´ (ë’¤ë¡œê°€ê¸°ìš©, ìµœìƒìœ„ë©´ null)
  parentFolder?: {
    id: string;
    name: string;
  };
  
  // ë¸Œë ˆë“œí¬ëŸ¼ ê²½ë¡œ (íœ´ì§€í†µ ë£¨íŠ¸ â†’ í˜„ì¬ í´ë”)
  breadcrumb: {
    id: string;
    name: string;
  }[];
  
  // í•˜ìœ„ í•­ëª©ë“¤
  items: TrashFolderItem[];
  totalCount: number;
}

interface TrashFolderItem {
  type: 'FILE' | 'FOLDER';
  id: string;
  name: string;
  
  // íŒŒì¼ì¸ ê²½ìš°ë§Œ
  sizeBytes?: number;
  mimeType?: string;
  
  // ê³µí†µ
  modifiedAt: Date;
}
```

---

**ë¸Œë ˆë“œí¬ëŸ¼ ê²½ë¡œ ì¡°íšŒ**

```sql
-- í˜„ì¬ í´ë”ì—ì„œ ìµœìƒìœ„ íœ´ì§€í†µ í´ë”ê¹Œì§€ ì—­ì¶”ì 
WITH RECURSIVE folder_path AS (
  SELECT id, name, parentId, 1 as depth
  FROM folders 
  WHERE id = í˜„ì¬í´ë”ID
  
  UNION ALL
  
  SELECT f.id, f.name, f.parentId, fp.depth + 1
  FROM folders f
  JOIN folder_path fp ON f.id = fp.parentId
  WHERE f.state = 'TRASHED'
)
SELECT id, name FROM folder_path
ORDER BY depth DESC;

-- ê²°ê³¼ ì˜ˆì‹œ: [{ id: 'project', name: 'project' }, { id: 'src', name: 'src' }]
```

---

**UI íƒìƒ‰ íë¦„ ì˜ˆì‹œ**

```
[íœ´ì§€í†µ ë£¨íŠ¸] GET /trash
â”œâ”€â”€ ğŸ“ project - ë”ë¸”í´ë¦­!
â”‚
â””â”€â”€ [project ë‚´ë¶€] GET /trash/folders/{projectId}/contents
    â”œâ”€â”€ ğŸ“ src - ë”ë¸”í´ë¦­!
    â”‚   â””â”€â”€ [src ë‚´ë¶€] GET /trash/folders/{srcId}/contents
    â”‚       â”œâ”€â”€ ğŸ“„ index.ts
    â”‚       â””â”€â”€ ğŸ“„ app.ts
    â”œâ”€â”€ ğŸ“ docs
    â”œâ”€â”€ ğŸ“„ README.md
    â””â”€â”€ ğŸ“„ package.json
    
â€» ë¸Œë ˆë“œí¬ëŸ¼: íœ´ì§€í†µ > project > src
â€» ë’¤ë¡œê°€ê¸°: parentFolder.idë¡œ ì´ë™
â€» íœ´ì§€í†µ ë£¨íŠ¸ë¡œ: GET /trash
```

---

**ì£¼ì˜ì‚¬í•­**
- **ì½ê¸° ì „ìš©**: íœ´ì§€í†µ ë‚´ í´ë” íƒìƒ‰ì€ ì¡°íšŒë§Œ ê°€ëŠ¥
- **ê°œë³„ ë³µêµ¬/ì‚­ì œ ë¶ˆê°€**: í•˜ìœ„ íŒŒì¼/í´ë” ê°œë³„ ì„ íƒ ë³µêµ¬/ì‚­ì œ ë¶ˆê°€
- **ìµœìƒìœ„ ë‹¨ìœ„ë¡œë§Œ ë³µêµ¬/ì‚­ì œ**: trash_metadataê°€ ìˆëŠ” ìµœìƒìœ„ í´ë” ë‹¨ìœ„ë¡œë§Œ ì²˜ë¦¬
- **ë¸Œë ˆë“œí¬ëŸ¼ ì œê³µ**: UIì—ì„œ í˜„ì¬ ìœ„ì¹˜ íŒŒì•… ë° ìƒìœ„ í´ë” ì´ë™ í¸ì˜

---



##### 2-1.íœ´ì§€í†µìœ¼ë¡œ íŒŒì¼ ì´ë™:íœ´ì§€í†µìœ¼ë¡œ íŒŒì¼ ì´ë™

---

**ì²˜ë¦¬ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [íŒŒì¼ íœ´ì§€í†µ ì´ë™ í”Œë¡œìš°]                                                â”‚
â”‚                                                                         â”‚
â”‚  ì˜ˆì‹œ: /root/path/test/file1.txt ì‚­ì œ ìš”ì²­                              â”‚
â”‚                                                                         â”‚
â”‚  [ì²˜ë¦¬ ìˆœì„œ]                                                             â”‚
â”‚  1. íŒŒì¼ ìƒíƒœ ê²€ì¦ (ACTIVEì¸ì§€, ë™ê¸°í™” ìƒíƒœ í™•ì¸)                         â”‚
â”‚  2. ê²€ì¦ ì‹¤íŒ¨ ì‹œ â†’ 409 Conflict ë°˜í™˜                                    â”‚
â”‚  3. DB íŠ¸ëœì­ì…˜:                                                        â”‚
â”‚     - files.state = TRASHED                                             â”‚
â”‚     - trash_metadata ìƒì„± (originalPath ì €ì¥)                           â”‚
â”‚     - file_storage_objects.availabilityStatus = MOVING                  â”‚
â”‚  4. Bull í ë“±ë¡ (NAS ì´ë™)                                             â”‚
â”‚  5. Bull Worker: NASì—ì„œ íœ´ì§€í†µìœ¼ë¡œ ì´ë™                                 â”‚
â”‚                                                                         â”‚
â”‚  [NAS ê²½ë¡œ ë³€í™˜]                                                         â”‚
â”‚  ì›ë˜: /root/path/test/file1.txt                                        â”‚
â”‚  íœ´ì§€í†µ: /.trash/{trashId}/root/path/test/file1.txt                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**[STEP 1] ì‚­ì œ ìš”ì²­**

1)ìœ ì €(íŒŒì¼ ì‚­ì œí•´ì¤˜)===> 

---

**[STEP 2] íŒŒì¼ ìƒíƒœ + ë™ê¸°í™” ìƒíƒœ ê²€ì¦**

2)íŒŒì¼ ìƒíƒœ + ë™ê¸°í™” ìƒíƒœ ê²€ì¦
```sql
SELECT f.id, f.state, f.name, fso.availabilityStatus, fso.objectKey
FROM files f
LEFT JOIN file_storage_objects fso ON f.id = fso.fileId AND fso.storageType = 'NAS'
WHERE f.id = ëŒ€ìƒíŒŒì¼
FOR UPDATE;  -- ë™ì‹œ ìˆ˜ì • ë°©ì§€

-- ê²€ì¦ ì¡°ê±´:
-- f.state = 'ACTIVE' ì´ì–´ì•¼ í•¨
-- fso.availabilityStatusê°€ 'AVAILABLE'ì´ ì•„ë‹ˆë©´ â†’ ì—ëŸ¬ ë°˜í™˜
-- (NULLì¸ ê²½ìš° = NAS ë ˆì½”ë“œ ì—†ìŒ = ì•„ì§ ë™ê¸°í™” ì•ˆë¨ â†’ í—ˆìš©)
```

*ë¹„ì •ìƒ ìƒíƒœ ì‚­ì œ ì°¨ë‹¨*
```
availabilityStatus NOT IN ('AVAILABLE', NULL)
â†’ 409 Conflict: "íŒŒì¼ ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."

ìƒíƒœë³„ ë©”ì‹œì§€:
- SYNCING: "íŒŒì¼ì´ ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤"
- MOVING: "íŒŒì¼ì´ ì´ë™ ì¤‘ì…ë‹ˆë‹¤"
- PENDING: "íŒŒì¼ì´ ì‚­ì œ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤"
- ERROR: "íŒŒì¼ ë™ê¸°í™”/ì´ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”"
- EVICTING: "ìºì‹œ ì •ë¦¬ ì¤‘ì…ë‹ˆë‹¤"
```

---

**[STEP 3] DB íŠ¸ëœì­ì…˜ - ìƒíƒœ ë³€ê²½**

3)â˜…ë‹¨ì¼ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì²˜ë¦¬â˜…
```
=== BEGIN TRANSACTION ===
1. UPDATE files SET state=TRASHED WHERE id=ëŒ€ìƒíŒŒì¼
2. INSERT trash_metadata (
     fileId, 
     deletedAt, 
     deletedBy, 
     originalFolderId,
     originalPath,        â† ì‚­ì œ ì‹œì ì˜ ì „ì²´ ê²½ë¡œ ì €ì¥ (ì˜ˆ: "/root/path/test")
     expiresAt            â† í˜„ì¬ì‹œê° + 30ì¼ (ì„¤ì •ê°’)
   )
3. UPDATE file_storage_objects 
   SET availabilityStatus = 'MOVING'
   WHERE fileId = ëŒ€ìƒíŒŒì¼ AND storageType = 'NAS'
4. INSERT file_events (eventType='TRASH', payloadJson={originalPath, ...})
=== COMMIT ===
```

**íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ê²°ê³¼:**
```
[DB ìƒíƒœ ë³€ê²½]
files:
  - file1.txt: state ACTIVE â†’ TRASHED

file_storage_objects (NAS):
  - availabilityStatus: AVAILABLE â†’ MOVING

trash_metadata:
  - 1ê°œ ë ˆì½”ë“œ ìƒì„±
```

---

**[STEP 4] Bull í ë“±ë¡**

4)íŠ¸ëœì­ì…˜ ì»¤ë°‹ í›„ Redis Queue (Bull) ë“±ë¡
```typescript
await nasQueue.add('sync', {
  aggregateType: 'TRASH', 
  eventType: 'NAS_MOVE_TO_TRASH',
  payload: { 
    fileId,
    trashMetadataId,
    sourcePath: '/root/path/test/file1.txt',                 // ì›ë˜ ê²½ë¡œ
    trashPath: `/.trash/${trashMetadataId}/root/path/test/file1.txt`,
    fileName: 'file1.txt'
  }
}, { attempts: 3, backoff: { type: 'exponential', delay: 1000 } });
```

---

**[STEP 5] Bull Worker ì²˜ë¦¬ (NAS íœ´ì§€í†µ ì´ë™)**

5)Bull Worker ì²˜ë¦¬ (NAS íœ´ì§€í†µ ì´ë™)

```
[NAS ì‘ì—…]
1. íœ´ì§€í†µ í´ë” ìƒì„±: /.trash/{trashMetadataId}/root/path/test/
2. íŒŒì¼ ì´ë™: /root/path/test/file1.txt â†’ /.trash/{trashMetadataId}/root/path/test/file1.txt
```

**ì„±ê³µ ì‹œ:**
```typescript
await fileStorageObjectRepository.update(
  { fileId, storageType: 'NAS' },
  { 
    objectKey: trashPath,           // íœ´ì§€í†µ ê²½ë¡œë¡œ ì—…ë°ì´íŠ¸
    availabilityStatus: 'AVAILABLE' // ì´ë™ ì™„ë£Œ
  }
);
```

**ìµœì¢… ìƒíƒœ (ì„±ê³µ ì‹œ):**
```
[DB ìƒíƒœ]
files: state=TRASHED
file_storage_objects: availabilityStatus=AVAILABLE, objectKey=/.trash/...

[NAS ìƒíƒœ]
/.trash/{trashMetadataId}/root/path/test/file1.txt âœ“
```

**ì‹¤íŒ¨ ì‹œ (3íšŒ ì¬ì‹œë„ í›„):**
```typescript
await fileStorageObjectRepository.update(
  { fileId, storageType: 'NAS' },
  { availabilityStatus: 'ERROR' }
);
await alertService.send('íŒŒì¼ íœ´ì§€í†µ ì´ë™ ì‹¤íŒ¨', { fileId, error });
```

**ì‹¤íŒ¨ ì‹œ ìƒíƒœ:**
```
[DB ìƒíƒœ]
files: state=TRASHED (ë…¼ë¦¬ì ìœ¼ë¡œëŠ” íœ´ì§€í†µ)
file_storage_objects: availabilityStatus=ERROR (NAS ì´ë™ ì‹¤íŒ¨)

[NAS ìƒíƒœ]
/root/path/test/file1.txt â† ì›ë˜ ìœ„ì¹˜ì— ê·¸ëŒ€ë¡œ ìˆìŒ

â€» ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ NAS ì´ë™ ì²˜ë¦¬ í›„ ìƒíƒœ ì—…ë°ì´íŠ¸ í•„ìš”
```


##### 2-2.íœ´ì§€í†µìœ¼ë¡œ í´ë” ì´ë™:íœ´ì§€í†µìœ¼ë¡œ í´ë” ì´ë™ (í•˜ìœ„ í¬í•¨)

**í•µì‹¬ ì„¤ê³„: í´ë” + í•˜ìœ„ ëª¨ë“  íŒŒì¼/í´ë”ë¥¼ í•¨ê»˜ TRASHED ì²˜ë¦¬**

---

**ì²˜ë¦¬ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [í´ë” íœ´ì§€í†µ ì´ë™ - ì¬ê·€ ì²˜ë¦¬ í”Œë¡œìš°]                                    â”‚
â”‚                                                                         â”‚
â”‚  ì˜ˆì‹œ: /root/path/test í´ë” ì‚­ì œ ìš”ì²­                                    â”‚
â”‚                                                                         â”‚
â”‚  [ì›ë˜ êµ¬ì¡°]                                                             â”‚
â”‚  /root/path/test/           â† ì‚­ì œ ëŒ€ìƒ í´ë”                            â”‚
â”‚  â”œâ”€â”€ file1.txt                                                          â”‚
â”‚  â”œâ”€â”€ file2.txt                                                          â”‚
â”‚  â””â”€â”€ subfolder/             â† í•˜ìœ„ í´ë”                                 â”‚
â”‚      â”œâ”€â”€ file3.txt                                                      â”‚
â”‚      â””â”€â”€ deep/              â† ë” ê¹Šì€ í•˜ìœ„ í´ë”                         â”‚
â”‚          â””â”€â”€ file4.txt                                                  â”‚
â”‚                                                                         â”‚
â”‚  [ì²˜ë¦¬ ìˆœì„œ]                                                             â”‚
â”‚  1. ì¬ê·€ë¡œ ëª¨ë“  í•˜ìœ„ í´ë” ID ìˆ˜ì§‘: [test, subfolder, deep]               â”‚
â”‚  2. í•´ë‹¹ í´ë”ë“¤ì˜ ëª¨ë“  íŒŒì¼ ID ìˆ˜ì§‘: [file1, file2, file3, file4]        â”‚
â”‚  3. ë™ê¸°í™” ìƒíƒœ ê²€ì¦ (AVAILABLE ì•„ë‹ˆë©´ ì°¨ë‹¨)                             â”‚
â”‚  4. ë‹¨ì¼ íŠ¸ëœì­ì…˜ìœ¼ë¡œ:                                                   â”‚
â”‚     - trash_metadata: ìµœìƒìœ„ í´ë”(test)ë§Œ ê¸°ë¡                          â”‚
â”‚     - folders: 3ê°œ ëª¨ë‘ state=TRASHED                                   â”‚
â”‚     - files: 4ê°œ ëª¨ë‘ state=TRASHED                                     â”‚
â”‚     - _storage_objects: ëª¨ë‘ availabilityStatus=MOVING                  â”‚
â”‚  5. Bull í: NASì—ì„œ í´ë” í†µì§¸ë¡œ ì´ë™                                    â”‚
â”‚                                                                         â”‚
â”‚  [NAS íœ´ì§€í†µ êµ¬ì¡°]                                                       â”‚
â”‚  /.trash/{trashMetadataId}/root/path/test/                              â”‚
â”‚  â”œâ”€â”€ file1.txt                                                          â”‚
â”‚  â”œâ”€â”€ file2.txt                                                          â”‚
â”‚  â””â”€â”€ subfolder/                                                         â”‚
â”‚      â”œâ”€â”€ file3.txt                                                      â”‚
â”‚      â””â”€â”€ deep/                                                          â”‚
â”‚          â””â”€â”€ file4.txt                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**[STEP 1] ì‚­ì œ ìš”ì²­**

1)ìœ ì €(í´ë” ì‚­ì œí•´ì¤˜)===> 

---

**[STEP 2] í•˜ìœ„ í•­ëª© ì¬ê·€ ì¡°íšŒ + ë™ê¸°í™” ìƒíƒœ ê²€ì¦**

2)í•˜ìœ„ í•­ëª© ì¡°íšŒ + ë™ê¸°í™” ìƒíƒœ ê²€ì¦ (ì¬ê·€)
```sql
-- í•˜ìœ„ ëª¨ë“  í´ë” ì¡°íšŒ (ì¬ê·€ CTE)
WITH RECURSIVE sub_folders AS (
  SELECT id, parentId, name FROM folders WHERE id = ëŒ€ìƒí´ë”
  UNION ALL
  SELECT f.id, f.parentId, f.name 
  FROM folders f
  JOIN sub_folders sf ON f.parentId = sf.id
  WHERE f.state = 'ACTIVE'
)
SELECT id FROM sub_folders;

-- í•´ë‹¹ í´ë”ë“¤ì˜ ëª¨ë“  íŒŒì¼ ì¡°íšŒ
SELECT id FROM files WHERE folderId IN (sub_folders) AND state = 'ACTIVE';

-- â˜… ë¹„ì •ìƒ ìƒíƒœ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ â˜…
SELECT COUNT(*) as unavailable_file_count
FROM files f
JOIN file_storage_objects fso ON f.id = fso.fileId
WHERE f.folderId IN (sub_folders) 
  AND f.state = 'ACTIVE'
  AND fso.storageType = 'NAS'
  AND fso.availabilityStatus NOT IN ('AVAILABLE');

-- â˜… ë¹„ì •ìƒ ìƒíƒœ í´ë” ì¡´ì¬ ì—¬ë¶€ í™•ì¸ â˜…
SELECT COUNT(*) as unavailable_folder_count
FROM folders fo
JOIN folder_storage_objects fso ON fo.id = fso.folderId
WHERE fo.id IN (sub_folders)
  AND fso.storageType = 'NAS'
  AND fso.availabilityStatus NOT IN ('AVAILABLE');
```

*ë¹„ì •ìƒ ìƒíƒœ ì‚­ì œ ì°¨ë‹¨*
```
unavailable_file_count > 0 OR unavailable_folder_count > 0
â†’ 409 Conflict: "ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì§€ ì•Šì€ íŒŒì¼/í´ë”ê°€ ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
```

---

**[STEP 3] DB íŠ¸ëœì­ì…˜ - ìƒíƒœ ì¼ê´„ ë³€ê²½**

3)â˜…ë‹¨ì¼ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì²˜ë¦¬â˜…
```
=== BEGIN TRANSACTION ===
-- 1. ìµœìƒìœ„ í´ë”ë§Œ trash_metadataì— ê¸°ë¡
INSERT trash_metadata (
  folderId,           â† ìµœìƒìœ„ í´ë” ID
  deletedAt, 
  deletedBy, 
  originalFolderId,   â† ìƒìœ„ í´ë” ID (parentId)
  originalPath,       â† ì‚­ì œ ì‹œì ì˜ ì „ì²´ ê²½ë¡œ (ì˜ˆ: "/root/path/test")
  expiresAt
)

-- 2. í•´ë‹¹ í´ë” + í•˜ìœ„ ëª¨ë“  í´ë” TRASHED
UPDATE folders SET state=TRASHED WHERE id IN (ì¬ê·€ë¡œ ì¡°íšŒëœ í´ë”ë“¤)

-- 3. í•´ë‹¹ í´ë”ë“¤ì˜ ëª¨ë“  íŒŒì¼ TRASHED
UPDATE files SET state=TRASHED WHERE folderId IN (ì¬ê·€ë¡œ ì¡°íšŒëœ í´ë”ë“¤)

-- 4. â˜… NAS ìƒíƒœë¥¼ MOVINGìœ¼ë¡œ ë³€ê²½ â˜…
UPDATE file_storage_objects 
SET availabilityStatus = 'MOVING'
WHERE fileId IN (í•´ë‹¹ íŒŒì¼ë“¤) AND storageType = 'NAS'

UPDATE folder_storage_objects 
SET availabilityStatus = 'MOVING'
WHERE folderId IN (ì¬ê·€ë¡œ ì¡°íšŒëœ í´ë”ë“¤) AND storageType = 'NAS'
=== COMMIT ===
```

**íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ê²°ê³¼ (ì˜ˆì‹œ):**
```
[DB ìƒíƒœ ë³€ê²½]
folders:
  - test (id:006): state ACTIVE â†’ TRASHED
  - subfolder (id:007): state ACTIVE â†’ TRASHED  
  - deep (id:008): state ACTIVE â†’ TRASHED

files:
  - file1.txt: state ACTIVE â†’ TRASHED
  - file2.txt: state ACTIVE â†’ TRASHED
  - file3.txt: state ACTIVE â†’ TRASHED
  - file4.txt: state ACTIVE â†’ TRASHED

file_storage_objects (NAS):
  - 4ê°œ íŒŒì¼ ëª¨ë‘: availabilityStatus AVAILABLE â†’ MOVING

folder_storage_objects (NAS):
  - 3ê°œ í´ë” ëª¨ë‘: availabilityStatus AVAILABLE â†’ MOVING

trash_metadata:
  - 1ê°œ ë ˆì½”ë“œ ìƒì„± (ìµœìƒìœ„ í´ë” testë§Œ)
```

---

**[STEP 4] Bull í ë“±ë¡**

4)Bull í ë“±ë¡ (NAS í´ë” ì´ë™)
```typescript
await nasQueue.add('sync', {
  aggregateType: 'TRASH', 
  eventType: 'NAS_MOVE_FOLDER_TO_TRASH',
  payload: { 
    trashMetadataId,                                      // íœ´ì§€í†µ ë©”íƒ€ ID
    sourcePath: '/root/path/test',                        // ì›ë˜ ê²½ë¡œ
    trashPath: '/.trash/{trashMetadataId}/root/path/test',// íœ´ì§€í†µ ê²½ë¡œ (ì›ë˜ êµ¬ì¡° ìœ ì§€)
    folderId: ëŒ€ìƒí´ë”ID,
    affectedFileIds: ['file1-id', 'file2-id', 'file3-id', 'file4-id'],
    affectedFolderIds: ['006', '007', '008']
  }
}, { attempts: 3, backoff: { type: 'exponential', delay: 1000 } });
```

---

**[STEP 5] Bull Worker ì²˜ë¦¬ (NAS íœ´ì§€í†µ ì´ë™)**

5)Bull Worker ì²˜ë¦¬ (NAS íœ´ì§€í†µ ì´ë™)

```
[NAS ì‘ì—…]
1. íœ´ì§€í†µ í´ë” ìƒì„±: /.trash/{trashMetadataId}/root/path/
2. í´ë” í†µì§¸ë¡œ ì´ë™: /root/path/test â†’ /.trash/{trashMetadataId}/root/path/test
   (í•˜ìœ„ êµ¬ì¡° ì „ì²´ ìœ ì§€ë¨)
```

**ì„±ê³µ ì‹œ:**
```typescript
// NAS ì´ë™ ì™„ë£Œ í›„ DB ìƒíƒœ ì—…ë°ì´íŠ¸
await db.transaction(async (tx) => {
  // íŒŒì¼ objectKey ì—…ë°ì´íŠ¸ (ê° íŒŒì¼ë³„ë¡œ)
  for (const file of affectedFiles) {
    await tx.fileStorageObjects.update(
      { fileId: file.id, storageType: 'NAS' },
      { 
        objectKey: `/.trash/${trashMetadataId}/${file.originalPath}`,
        availabilityStatus: 'AVAILABLE' 
      }
    );
  }
  
  // í´ë” objectKey ì—…ë°ì´íŠ¸ (ê° í´ë”ë³„ë¡œ)
  for (const folder of affectedFolders) {
    await tx.folderStorageObjects.update(
      { folderId: folder.id, storageType: 'NAS' },
      { 
        objectKey: `/.trash/${trashMetadataId}/${folder.originalPath}`,
        availabilityStatus: 'AVAILABLE' 
      }
    );
  }
});
```

**ìµœì¢… ìƒíƒœ (ì„±ê³µ ì‹œ):**
```
[DB ìƒíƒœ]
folders: state=TRASHED (3ê°œ)
files: state=TRASHED (4ê°œ)
file_storage_objects: availabilityStatus=AVAILABLE, objectKey=/.trash/... (4ê°œ)
folder_storage_objects: availabilityStatus=AVAILABLE, objectKey=/.trash/... (3ê°œ)

[NAS ìƒíƒœ]
/.trash/{trashMetadataId}/root/path/test/
â”œâ”€â”€ file1.txt âœ“
â”œâ”€â”€ file2.txt âœ“
â””â”€â”€ subfolder/
    â”œâ”€â”€ file3.txt âœ“
    â””â”€â”€ deep/
        â””â”€â”€ file4.txt âœ“
```

**ì‹¤íŒ¨ ì‹œ (3íšŒ ì¬ì‹œë„ í›„):**
```typescript
// ëª¨ë“  ê´€ë ¨ í•­ëª©ì„ ERROR ìƒíƒœë¡œ ë³€ê²½
await db.fileStorageObjects.update(
  { fileId: In(affectedFileIds), storageType: 'NAS' },
  { availabilityStatus: 'ERROR' }
);

await db.folderStorageObjects.update(
  { folderId: In(affectedFolderIds), storageType: 'NAS' },
  { availabilityStatus: 'ERROR' }
);

// ê´€ë¦¬ì ì•Œë¦¼
await alertService.send('íœ´ì§€í†µ ì´ë™ ì‹¤íŒ¨', { 
  folderId, 
  affectedFileCount: affectedFileIds.length,
  affectedFolderCount: affectedFolderIds.length,
  error 
});
```

**ì‹¤íŒ¨ ì‹œ ìƒíƒœ:**
```
[DB ìƒíƒœ]
folders: state=TRASHED (3ê°œ) â† ë…¼ë¦¬ì ìœ¼ë¡œëŠ” íœ´ì§€í†µ
files: state=TRASHED (4ê°œ)
file_storage_objects: availabilityStatus=ERROR â† NAS ì´ë™ ì‹¤íŒ¨
folder_storage_objects: availabilityStatus=ERROR

[NAS ìƒíƒœ]
/root/path/test/ â† ì›ë˜ ìœ„ì¹˜ì— ê·¸ëŒ€ë¡œ ìˆìŒ (ì´ë™ ì‹¤íŒ¨)

â€» ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ NAS ì´ë™ ì²˜ë¦¬ í›„ ìƒíƒœ ì—…ë°ì´íŠ¸ í•„ìš”
```

*ì£¼ì˜*
- **trash_metadataëŠ” ìµœìƒìœ„ í´ë”ë§Œ ê¸°ë¡**: í•˜ìœ„ í•­ëª©ì€ stateë§Œ ë³€ê²½
- **í•˜ìœ„ íŒŒì¼/í´ë” ê°œë³„ ë³µêµ¬ ë¶ˆê°€**: í´ë” ë‹¨ìœ„ë¡œë§Œ ë³µêµ¬ ê°€ëŠ¥
- **NASëŠ” í´ë” í†µì§¸ë¡œ ì´ë™**: í•˜ìœ„ êµ¬ì¡° ìœ ì§€
- **NAS ë™ê¸°í™” ìƒíƒœ ê´€ë¦¬**: MOVING â†’ AVAILABLE (ì„±ê³µ) / ERROR (ì‹¤íŒ¨)



##### 3.íœ´ì§€í†µ íŒŒì¼ ì˜êµ¬ ì‚­ì œ:íœ´ì§€í†µì— ìˆëŠ” íŒŒì¼ ì˜êµ¬ì‚­ì œ

---

**ì²˜ë¦¬ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [íŒŒì¼ ì˜êµ¬ì‚­ì œ í”Œë¡œìš°]                                                   â”‚
â”‚                                                                         â”‚
â”‚  â€» ì‚­ì œëŠ” ì—…ë¡œë“œì™€ ìˆœì„œê°€ ë‹¤ë¦„! (DB ìš°ì„ )                                â”‚
â”‚                                                                         â”‚
â”‚  ì˜ˆì‹œ: íœ´ì§€í†µì˜ file1.txt ì˜êµ¬ì‚­ì œ ìš”ì²­                                  â”‚
â”‚                                                                         â”‚
â”‚  [ì²˜ë¦¬ ìˆœì„œ]                                                             â”‚
â”‚  1. íŒŒì¼ ìƒíƒœ ê²€ì¦ (TRASHEDì¸ì§€, ë™ê¸°í™” ìƒíƒœ í™•ì¸)                        â”‚
â”‚  2. DB íŠ¸ëœì­ì…˜ (ë¨¼ì € ì»¤ë°‹):                                             â”‚
â”‚     - files.state = DELETED                                             â”‚
â”‚     - trash_metadata ì‚­ì œ                                               â”‚
â”‚     - file_storage_objects(CACHE).availabilityStatus = PENDING          â”‚
â”‚  3. SeaweedFS ì‚­ì œ ì‹œë„                                                  â”‚
â”‚     - ì‹¤íŒ¨í•´ë„ DB ë¡¤ë°± ì•ˆí•¨ â†’ ë°°ì¹˜ë¡œ ì •ë¦¬                                â”‚
â”‚  4. Bull í ë“±ë¡ (NAS ì˜êµ¬ì‚­ì œ)                                          â”‚
â”‚  5. Bull Worker: NASì—ì„œ íŒŒì¼ ì˜êµ¬ì‚­ì œ                                   â”‚
â”‚                                                                         â”‚
â”‚  [ì‚­ì œ ëŒ€ìƒ]                                                             â”‚
â”‚  - DB: files, trash_metadata, file_storage_objects                      â”‚
â”‚  - ìºì‹œ: SeaweedFS íŒŒì¼                                                  â”‚
â”‚  - NAS: /.trash/{trashId}/...                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**ì˜ì‚¬ íŠ¸ëœì­ì…˜ íë¦„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [ì˜êµ¬ì‚­ì œ ì‹œë‚˜ë¦¬ì˜¤ - ì˜ì‚¬ íŠ¸ëœì­ì…˜]                                  â”‚
â”‚                                                                     â”‚
â”‚  1. DB íŠ¸ëœì­ì…˜ ì‹œì‘                                                 â”‚
â”‚     - UPDATE files SET state=DELETED                                â”‚
â”‚     - DELETE trash_metadata                                         â”‚
â”‚     - UPDATE file_storage_objects SET availabilityStatus=PENDING    â”‚
â”‚     â†“ ì‹¤íŒ¨ ì‹œ â†’ DB ë¡¤ë°± (SeaweedFS ë³€ê²½ ì—†ìŒ, ë³´ìƒ ë¶ˆí•„ìš”)           â”‚
â”‚     â†“ ì„±ê³µ ì‹œ                                                       â”‚
â”‚                                                                     â”‚
â”‚  2. SeaweedFS ì‚­ì œ ì‹œë„ (objectKey = fileId)                         â”‚
â”‚     â†“ ì‹¤íŒ¨ ì‹œ â†’ DB ë¡¤ë°±í•˜ì§€ ì•ŠìŒ! (ë°°ì¹˜ë¡œ ì •ë¦¬)                      â”‚
â”‚     â†“ ì„±ê³µ ì‹œ â†’ file_storage_objectsì—ì„œ ìºì‹œ ë ˆì½”ë“œ ì‚­ì œ            â”‚
â”‚                                                                     â”‚
â”‚  3. Bull í ë“±ë¡ (NAS ì˜êµ¬ì‚­ì œ)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**[STEP 1] ì˜êµ¬ì‚­ì œ ìš”ì²­**

1)ìœ ì €(íœ´ì§€í†µ ë¹„ì›Œì¤˜)===> 

---

**[STEP 2] íŒŒì¼ ìƒíƒœ + ë™ê¸°í™” ìƒíƒœ ê²€ì¦**

2)íŒŒì¼ ìƒíƒœ ê²€ì¦
```sql
-- state=TRASHED í™•ì¸ + NAS ë™ê¸°í™” ìƒíƒœ í™•ì¸
SELECT f.id, f.state, f.name,
       fso_nas.availabilityStatus as nasStatus,
       fso_nas.objectKey as trashPath,
       fso_cache.id as cacheId
FROM files f
LEFT JOIN file_storage_objects fso_nas 
  ON f.id = fso_nas.fileId AND fso_nas.storageType = 'NAS'
LEFT JOIN file_storage_objects fso_cache 
  ON f.id = fso_cache.fileId AND fso_cache.storageType = 'CACHE_SEAWEED'
WHERE f.id = ëŒ€ìƒíŒŒì¼
FOR UPDATE;

-- ê²€ì¦ ì¡°ê±´:
-- f.state = 'TRASHED' ì´ì–´ì•¼ í•¨
-- fso_nas.availabilityStatusê°€ 'AVAILABLE'ì´ ì•„ë‹ˆë©´ â†’ ì—ëŸ¬ ë°˜í™˜
```

*ë¹„ì •ìƒ ìƒíƒœ ì‚­ì œ ì°¨ë‹¨*
```
nasStatus NOT IN ('AVAILABLE', NULL)
â†’ 409 Conflict ë°˜í™˜ (ìƒíƒœë³„ ë©”ì‹œì§€ ì œê³µ)

- MOVING: "íŒŒì¼ì´ íœ´ì§€í†µìœ¼ë¡œ ì´ë™ ì¤‘ì…ë‹ˆë‹¤. ì™„ë£Œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
- SYNCING: "íŒŒì¼ì´ ë™ê¸°í™” ì¤‘ì…ë‹ˆë‹¤"
- ERROR: "ì´ì „ ì‘ì—…ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”."
```

---

**[STEP 3] DB íŠ¸ëœì­ì…˜ (ë¨¼ì € ì»¤ë°‹)**

3)â˜…DB íŠ¸ëœì­ì…˜ ë¨¼ì €â˜… 
```
=== BEGIN TRANSACTION ===
1. UPDATE files SET state=DELETED WHERE id=ëŒ€ìƒíŒŒì¼
2. DELETE trash_metadata WHERE fileId=ëŒ€ìƒíŒŒì¼
3. UPDATE file_storage_objects 
   SET availabilityStatus=PENDING
   WHERE fileId=ëŒ€ìƒíŒŒì¼ AND storageType=CACHE_SEAWEED
4. INSERT file_events (eventType='PURGE', payloadJson={trashPath, ...})
=== COMMIT ===
```

**íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ê²°ê³¼:**
```
[DB ìƒíƒœ ë³€ê²½]
files:
  - file1.txt: state TRASHED â†’ DELETED

trash_metadata:
  - í•´ë‹¹ ë ˆì½”ë“œ ì‚­ì œë¨

file_storage_objects (CACHE):
  - availabilityStatus: AVAILABLE â†’ PENDING (ì‚­ì œ ëŒ€ê¸°)
```

---

**[STEP 4] SeaweedFS ì‚­ì œ ì‹œë„**

4)â˜…SeaweedFS ì‚­ì œ ì‹œë„â˜… (objectKey = fileId) 
```typescript
try {
  await seaweedService.delete(fileId);
  // ì„±ê³µ ì‹œ ìºì‹œ ë ˆì½”ë“œ ì‚­ì œ
  await fileStorageObjectRepository.delete({ fileId, storageType: 'CACHE_SEAWEED' });
  logger.info(`SeaweedFS ì‚­ì œ ì™„ë£Œ: ${fileId}`);
} catch (error) {
  // ì‹¤íŒ¨í•´ë„ DB ë¡¤ë°±í•˜ì§€ ì•ŠìŒ! ë°°ì¹˜ë¡œ ì •ë¦¬
  logger.warn(`SeaweedFS ì‚­ì œ ì‹¤íŒ¨, ë°°ì¹˜ ì •ë¦¬ ëŒ€ìƒ: ${fileId}`, error);
  // file_storage_objects.availabilityStatus = PENDING ìƒíƒœë¡œ ìœ ì§€
  // â†’ ë°°ì¹˜ ì •ë¦¬ Workerê°€ ì£¼ê¸°ì ìœ¼ë¡œ ì²˜ë¦¬
}
```

**SeaweedFS ì‚­ì œ ê²°ê³¼:**
```
[ì„±ê³µ ì‹œ]
- SeaweedFSì—ì„œ íŒŒì¼ ì‚­ì œë¨
- file_storage_objects(CACHE_SEAWEED) ë ˆì½”ë“œ ì‚­ì œë¨

[ì‹¤íŒ¨ ì‹œ]
- SeaweedFSì— íŒŒì¼ ë‚¨ì•„ìˆìŒ (orphan)
- file_storage_objects(CACHE_SEAWEED).availabilityStatus = PENDING
- â†’ ë°°ì¹˜ ì •ë¦¬ Workerê°€ ì£¼ê¸°ì ìœ¼ë¡œ PENDING ìƒíƒœ íŒŒì¼ ì •ë¦¬
```

---

**[STEP 5] Bull í ë“±ë¡**

5)Bull í ë“±ë¡ (NAS ì˜êµ¬ì‚­ì œ)
```typescript
await nasQueue.add('sync', {
  aggregateType: 'TRASH', 
  eventType: 'NAS_PURGE',
  payload: { 
    fileId, 
    trashPath: '/.trash/{trashMetadataId}/root/path/test/file1.txt',
    fileName: 'file1.txt'
  }
}, { attempts: 3, backoff: { type: 'exponential', delay: 1000 } });
```

---

**[STEP 6] Bull Worker ì²˜ë¦¬ (NAS ì˜êµ¬ì‚­ì œ)**

6)Bull Workerê°€ NASì—ì„œ ì˜êµ¬ì‚­ì œ ì²˜ë¦¬

```
[NAS ì‘ì—…]
1. íŒŒì¼ ì‚­ì œ: /.trash/{trashMetadataId}/root/path/test/file1.txt
2. ë¹ˆ íœ´ì§€í†µ í´ë” ì •ë¦¬ (ì„ íƒ)
```

**ì„±ê³µ ì‹œ:**
```typescript
// NAS ë ˆì½”ë“œë„ ì‚­ì œ
await fileStorageObjectRepository.delete({ fileId, storageType: 'NAS' });
logger.info(`NAS ì˜êµ¬ì‚­ì œ ì™„ë£Œ: ${fileId}`);
```

**ìµœì¢… ìƒíƒœ (ì„±ê³µ ì‹œ):**
```
[DB ìƒíƒœ]
files: state=DELETED (ë…¼ë¦¬ ì‚­ì œ ì™„ë£Œ)
file_storage_objects: ëª¨ë“  ë ˆì½”ë“œ ì‚­ì œë¨ (CACHE, NAS)
trash_metadata: ì‚­ì œë¨

[ìŠ¤í† ë¦¬ì§€ ìƒíƒœ]
SeaweedFS: íŒŒì¼ ì—†ìŒ âœ“
NAS: íŒŒì¼ ì—†ìŒ âœ“
```

**ì‹¤íŒ¨ ì‹œ (3íšŒ ì¬ì‹œë„ í›„):**
```typescript
// NAS ë ˆì½”ë“œ ERROR ìƒíƒœë¡œ ë³€ê²½
await fileStorageObjectRepository.update(
  { fileId, storageType: 'NAS' },
  { availabilityStatus: 'ERROR' }
);
await alertService.send('NAS ì˜êµ¬ì‚­ì œ ì‹¤íŒ¨', { fileId, trashPath, error });
```

**ì‹¤íŒ¨ ì‹œ ìƒíƒœ:**
```
[DB ìƒíƒœ]
files: state=DELETED
file_storage_objects(NAS): availabilityStatus=ERROR

[ìŠ¤í† ë¦¬ì§€ ìƒíƒœ]
NAS: /.trash/.../file1.txt â† íŒŒì¼ ë‚¨ì•„ìˆìŒ (orphan)

â€» ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ NAS íŒŒì¼ ì‚­ì œ í›„ DB ë ˆì½”ë“œ ì •ë¦¬ í•„ìš”
```


##### 4.íœ´ì§€í†µ íŒŒì¼ ë³µêµ¬

---

**ì²˜ë¦¬ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [íŒŒì¼ ë³µêµ¬ í”Œë¡œìš°]                                                      â”‚
â”‚                                                                         â”‚
â”‚  ì˜ˆì‹œ: íœ´ì§€í†µì˜ file1.txtë¥¼ /root/path/testë¡œ ë³µêµ¬ ìš”ì²­                  â”‚
â”‚                                                                         â”‚
â”‚  [ì²˜ë¦¬ ìˆœì„œ]                                                             â”‚
â”‚  1. ë³µêµ¬ ì •ë³´ ì¡°íšŒ API í˜¸ì¶œ â†’ ê²½ë¡œ ìƒíƒœ í™•ì¸                             â”‚
â”‚  2. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ìƒíƒœì— ë”°ë¼ UI í‘œì‹œ                                   â”‚
â”‚  3. ë³µêµ¬ ì‹¤í–‰ API í˜¸ì¶œ                                                   â”‚
â”‚  4. DB íŠ¸ëœì­ì…˜:                                                        â”‚
â”‚     - files.state = ACTIVE                                              â”‚
â”‚     - trash_metadata ì‚­ì œ                                               â”‚
â”‚     - file_storage_objects.availabilityStatus = MOVING                  â”‚
â”‚  5. Bull í ë“±ë¡ (NAS ë³µì›)                                             â”‚
â”‚  6. Bull Worker: NASì—ì„œ ì›ë˜ ê²½ë¡œë¡œ ì´ë™                                â”‚
â”‚                                                                         â”‚
â”‚  [NAS ê²½ë¡œ ë³€í™˜]                                                         â”‚
â”‚  íœ´ì§€í†µ: /.trash/{trashId}/root/path/test/file1.txt                     â”‚
â”‚  ë³µêµ¬: /root/path/test/file1.txt                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**ë³µêµ¬ ë¡œì§ íë¦„ë„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [íŒŒì¼ ë³µêµ¬ ë¡œì§]                                                    â”‚
â”‚                                                                     â”‚
â”‚  1. originalPathë¡œ ê²½ë¡œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸                               â”‚
â”‚                                                                     â”‚
â”‚  2. ê²½ë¡œ ì¡´ì¬ O (í´ë” ACTIVE + ê²½ë¡œ ë™ì¼)                             â”‚
â”‚     â”œâ”€ ë™ì¼ íŒŒì¼ëª… ì—†ìŒ â†’ ë°”ë¡œ ë³µêµ¬                                  â”‚
â”‚     â””â”€ ë™ì¼ íŒŒì¼ëª… ìˆìŒ â†’ ì‚¬ìš©ìì—ê²Œ íŒŒì¼ëª… ìˆ˜ì • ì•ˆë‚´ í›„ ë³µêµ¬         â”‚
â”‚                                                                     â”‚
â”‚  3. ê²½ë¡œ ì¡´ì¬ X (í´ë” ì—†ìŒ/ì‚­ì œ/ê²½ë¡œ ë³€ê²½)                            â”‚
â”‚     â””â”€ originalPath ê²½ë¡œë¥¼ ìë™ ìƒì„± í›„ ë³µêµ¬                         â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**[STEP 1] ë³µêµ¬ ì •ë³´ ì¡°íšŒ API**

GET /trash/files/{trashId}/restore-info

```typescript
interface FileRestoreInfoResponse {
  trashId: string;
  fileName: string;
  
  // ì›ë˜ ê²½ë¡œ ì •ë³´
  originalPath: string;           // "/root/path/test"
  originalFolderId: string;
  
  // ê²½ë¡œ ìƒíƒœ
  pathStatus: 'AVAILABLE' | 'PATH_NOT_FOUND';
  
  // AVAILABLEì¸ ê²½ìš° ì¶©ëŒ ì—¬ë¶€
  hasConflict: boolean;           // ê°™ì€ ì´ë¦„ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€
  conflictFileName?: string;
}
```

**ì‘ë‹µ ê²°ì • ë¡œì§:**
```
í´ë” ACTIVE + folder.path = originalPath â†’ AVAILABLE
ê·¸ ì™¸ ëª¨ë“  ê²½ìš° â†’ PATH_NOT_FOUND
```

---

**[STEP 2] ë³µêµ¬ ì‹¤í–‰ API**

POST /trash/files/{trashId}/restore

```typescript
interface FileRestoreRequest {
  // ì¶©ëŒ ì‹œ ìƒˆ íŒŒì¼ëª… (ì¶©ëŒ ìˆì„ ë•Œë§Œ í•„ìˆ˜)
  newFileName?: string;
}
```

**ìš”ì²­/ì‘ë‹µ ë§¤íŠ¸ë¦­ìŠ¤:**

| pathStatus | ì¶©ëŒ | ìš”ì²­ body | ê²°ê³¼ |
|------------|-----|----------|------|
| AVAILABLE | ì—†ìŒ | {} | ë°”ë¡œ ë³µêµ¬ |
| AVAILABLE | ìˆìŒ | { newFileName: "file (1).txt" } | ì´ë¦„ ë³€ê²½ í›„ ë³µêµ¬ |
| PATH_NOT_FOUND | - | {} | ê²½ë¡œ ìë™ ìƒì„± í›„ ë³µêµ¬ |

---

**[STEP 3] ë³µêµ¬ í”Œë¡œìš° ìƒì„¸**

**Case A: ê²½ë¡œ ì¡´ì¬ + ì¶©ëŒ ì—†ìŒ**

```
=== BEGIN TRANSACTION ===
1. UPDATE files SET state=ACTIVE WHERE id=ëŒ€ìƒ
2. DELETE trash_metadata WHERE fileId=ëŒ€ìƒ
3. UPDATE file_storage_objects 
   SET objectKey=ë³µêµ¬ê²½ë¡œ, availabilityStatus='MOVING' 
   WHERE fileId=ëŒ€ìƒ AND storageType='NAS'
4. INSERT file_events (eventType='RESTORE')
=== COMMIT ===
```

**íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ê²°ê³¼:**
```
[DB ìƒíƒœ ë³€ê²½]
files:
  - file1.txt: state TRASHED â†’ ACTIVE

trash_metadata:
  - í•´ë‹¹ ë ˆì½”ë“œ ì‚­ì œë¨

file_storage_objects (NAS):
  - objectKey: /.trash/...  â†’ /root/path/test/file1.txt
  - availabilityStatus: AVAILABLE â†’ MOVING
```

---

**[STEP 4] Bull í ë“±ë¡ (NAS ë³µì›)**

```typescript
await nasQueue.add('sync', {
  aggregateType: 'TRASH', 
  eventType: 'NAS_RESTORE_FILE',
  payload: { 
    fileId, 
    trashPath: '/.trash/{trashId}/root/path/test/file1.txt',
    restorePath: '/root/path/test/file1.txt'
  }
}, { attempts: 3, backoff: { type: 'exponential', delay: 1000 } });
```

---

**[STEP 5] Bull Worker ì²˜ë¦¬ (NAS ë³µì›)**

```
[NAS ì‘ì—…]
1. ì›ë˜ í´ë” ì¡´ì¬ í™•ì¸: /root/path/test/
2. íŒŒì¼ ì´ë™: /.trash/{trashId}/root/path/test/file1.txt â†’ /root/path/test/file1.txt
```

**ì„±ê³µ ì‹œ:**
```typescript
await fileStorageObjectRepository.update(
  { fileId, storageType: 'NAS' },
  { availabilityStatus: 'AVAILABLE' }
);
```

**ìµœì¢… ìƒíƒœ (ì„±ê³µ ì‹œ):**
```
[DB ìƒíƒœ]
files: state=ACTIVE
file_storage_objects: availabilityStatus=AVAILABLE, objectKey=/root/path/test/file1.txt

[NAS ìƒíƒœ]
/root/path/test/file1.txt âœ“
```

**ì‹¤íŒ¨ ì‹œ (3íšŒ ì¬ì‹œë„ í›„):**
```typescript
await fileStorageObjectRepository.update(
  { fileId, storageType: 'NAS' },
  { availabilityStatus: 'ERROR' }
);
await alertService.send('íŒŒì¼ ë³µêµ¬ ì‹¤íŒ¨', { fileId, restorePath, error });
```

**ì‹¤íŒ¨ ì‹œ ìƒíƒœ:**
```
[DB ìƒíƒœ]
files: state=ACTIVE (ë…¼ë¦¬ì ìœ¼ë¡œëŠ” ë³µêµ¬ë¨)
file_storage_objects: availabilityStatus=ERROR (NAS ë³µì› ì‹¤íŒ¨)

[NAS ìƒíƒœ]
/.trash/.../file1.txt â† íœ´ì§€í†µì— ì—¬ì „íˆ ìˆìŒ

â€» ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ NAS íŒŒì¼ ì´ë™ í›„ ìƒíƒœ ì—…ë°ì´íŠ¸ í•„ìš”
```

---

**Case B: ê²½ë¡œ ì¡´ì¬ + ì¶©ëŒ ìˆìŒ**

1) ì‚¬ìš©ìì—ê²Œ íŒŒì¼ëª… ìˆ˜ì • ì•ˆë‚´
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ ë™ì¼í•œ íŒŒì¼ëª…ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤                          â”‚
â”‚                                                             â”‚
â”‚  ê¸°ì¡´ íŒŒì¼: file1.txt                                       â”‚
â”‚  ê²½ë¡œ: /root/path/test                                      â”‚
â”‚                                                             â”‚
â”‚  ìƒˆ íŒŒì¼ëª…: [file1 (1).txt        ]                         â”‚
â”‚                                                             â”‚
â”‚  [ë³µêµ¬] [ì·¨ì†Œ]                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

2) ì‚¬ìš©ìê°€ ìƒˆ íŒŒì¼ëª… ì…ë ¥ í›„ ë³µêµ¬ ìš”ì²­ (newFileName = "file1 (1).txt")

3) íŠ¸ëœì­ì…˜ ì²˜ë¦¬
```
=== BEGIN TRANSACTION ===
1. UPDATE files SET state=ACTIVE, name='file1 (1).txt' WHERE id=ëŒ€ìƒ
2. DELETE trash_metadata WHERE fileId=ëŒ€ìƒ
3. UPDATE file_storage_objects 
   SET objectKey='/root/path/test/file1 (1).txt', availabilityStatus='MOVING' 
   WHERE fileId=ëŒ€ìƒ AND storageType='NAS'
4. INSERT file_events (eventType='RESTORE', payloadJson={renamed: true, oldName, newName})
=== COMMIT ===
```

4) Bull í ë“±ë¡ â†’ Bull Worker ì²˜ë¦¬ (Case Aì™€ ë™ì¼, ìƒˆ íŒŒì¼ëª…ìœ¼ë¡œ)

---

**Case C: ê²½ë¡œ ì¡´ì¬ X â†’ ê²½ë¡œ ìë™ ìƒì„±**

```
=== BEGIN TRANSACTION ===
-- 1. ê²½ë¡œ ì¬ìƒì„± (originalPath ê¸°ì¤€)
-- "/root/path/test" â†’ ê° í´ë” ì¡´ì¬ í™•ì¸/ìƒì„±
FOR each folder IN originalPath:
  IF folder NOT EXISTS OR folder.state != 'ACTIVE':
    INSERT folders (name, parentId, state='ACTIVE')
    INSERT folder_storage_objects (folderId, storageType='NAS', objectKey=í´ë”ê²½ë¡œ)
    
-- 2. íŒŒì¼ ë³µêµ¬
UPDATE files SET state=ACTIVE, folderId=ìµœì¢…í´ë”ID WHERE id=ëŒ€ìƒ
DELETE trash_metadata WHERE fileId=ëŒ€ìƒ
UPDATE file_storage_objects 
  SET objectKey=ë³µêµ¬ê²½ë¡œ, availabilityStatus='MOVING' 
  WHERE storageType='NAS'
INSERT file_events (eventType='RESTORE', payloadJson={pathRecreated: true})
=== COMMIT ===
```

**íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ê²°ê³¼:**
```
[DB ìƒíƒœ ë³€ê²½]
folders:
  - /root: ê¸°ì¡´ ì¡´ì¬ or ìƒì„±
  - /root/path: ê¸°ì¡´ ì¡´ì¬ or ìƒì„±
  - /root/path/test: ìƒˆë¡œ ìƒì„±

files:
  - file1.txt: state TRASHED â†’ ACTIVE, folderId=ìƒˆí´ë”ID

file_storage_objects (NAS):
  - availabilityStatus: AVAILABLE â†’ MOVING
```

---

Bull í ë“±ë¡ (ê²½ë¡œ ìƒì„± + íŒŒì¼ ë³µì›)
```typescript
await nasQueue.add('sync', {
  aggregateType: 'TRASH', 
  eventType: 'NAS_RESTORE_WITH_PATH',
  payload: { 
    fileId,
    trashPath: '/.trash/{trashId}/root/path/test/file1.txt',
    restorePath: '/root/path/test/file1.txt',
    fileName: 'file1.txt',
    foldersToCreate: ['/root', '/root/path', '/root/path/test']  // ìƒì„±í•  í´ë”ë“¤
  }
}, { attempts: 3, backoff: { type: 'exponential', delay: 1000 } });
```

---

**Bull Worker ì²˜ë¦¬ (ê²½ë¡œ ìƒì„± + íŒŒì¼ ë³µì›)**

```
[NAS ì‘ì—…]
1. í´ë” ìƒì„±: /root (ì¡´ì¬ ì‹œ skip)
2. í´ë” ìƒì„±: /root/path (ì¡´ì¬ ì‹œ skip)
3. í´ë” ìƒì„±: /root/path/test
4. íŒŒì¼ ì´ë™: /.trash/.../file1.txt â†’ /root/path/test/file1.txt
```

**ì„±ê³µ ì‹œ:**
```typescript
await db.transaction(async (tx) => {
  // íŒŒì¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  await tx.fileStorageObjects.update(
    { fileId, storageType: 'NAS' },
    { availabilityStatus: 'AVAILABLE' }
  );
  // ìƒì„±ëœ í´ë”ë“¤ ìƒíƒœ ì—…ë°ì´íŠ¸
  await tx.folderStorageObjects.update(
    { folderId: In(createdFolderIds), storageType: 'NAS' },
    { availabilityStatus: 'AVAILABLE' }
  );
});
```

**ìµœì¢… ìƒíƒœ (ì„±ê³µ ì‹œ):**
```
[DB ìƒíƒœ]
files: state=ACTIVE
folders: ê²½ë¡œì— í•´ë‹¹í•˜ëŠ” í´ë”ë“¤ state=ACTIVE
file_storage_objects: availabilityStatus=AVAILABLE

[NAS ìƒíƒœ]
/root/path/test/file1.txt âœ“
```

---




##### 5.íœ´ì§€í†µ ë¹„ìš°ê¸°:íœ´ì§€í†µ ì „ì²´ ì˜êµ¬ì‚­ì œ

---

**ì²˜ë¦¬ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [íœ´ì§€í†µ ë¹„ìš°ê¸° í”Œë¡œìš°]                                                   â”‚
â”‚                                                                         â”‚
â”‚  ìœˆë„ìš° íœ´ì§€í†µì˜ "íœ´ì§€í†µ ë¹„ìš°ê¸°" ê¸°ëŠ¥ê³¼ ë™ì¼                               â”‚
â”‚                                                                         â”‚
â”‚  [ì²˜ë¦¬ ìˆœì„œ]                                                             â”‚
â”‚  1. íœ´ì§€í†µ ì „ì²´ í•­ëª© ì¡°íšŒ (trash_metadata ê¸°ì¤€)                           â”‚
â”‚  2. ê° í•­ëª© ì˜êµ¬ì‚­ì œ ì²˜ë¦¬:                                               â”‚
â”‚     - íŒŒì¼: ì„¹ì…˜ 3 í”Œë¡œìš° ì ìš©                                           â”‚
â”‚     - í´ë”: ì„¹ì…˜ 6 í”Œë¡œìš° ì ìš© (í•˜ìœ„ ì¬ê·€)                                â”‚
â”‚  3. ë°°ì¹˜ ì²˜ë¦¬ë¡œ NAS ì •ë¦¬                                                  â”‚
â”‚                                                                         â”‚
â”‚  â€» ëŒ€ìš©ëŸ‰ ë°ì´í„° ê³ ë ¤í•˜ì—¬ ì²­í¬ ë‹¨ìœ„ ì²˜ë¦¬                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**API: DELETE /trash/all**

---

**[STEP 1] ì „ì²´ ì‚­ì œ ìš”ì²­**

1)ìœ ì €(íœ´ì§€í†µ ë¹„ì›Œì¤˜)===> 

---

**[STEP 2] íœ´ì§€í†µ ì „ì²´ í•­ëª© ì¡°íšŒ**

```sql
-- íœ´ì§€í†µì˜ ëª¨ë“  trash_metadata ì¡°íšŒ
SELECT 
  tm.id,
  tm.fileId,
  tm.folderId,
  CASE WHEN tm.fileId IS NOT NULL THEN 'FILE' ELSE 'FOLDER' END as type
FROM trash_metadata tm
ORDER BY tm.deletedAt ASC;  -- ì˜¤ë˜ëœ ê²ƒë¶€í„° ì‚­ì œ
```

---

**[STEP 3] ì²­í¬ ë‹¨ìœ„ ì‚­ì œ ì²˜ë¦¬**

```typescript
// ëŒ€ìš©ëŸ‰ ë°ì´í„° ê³ ë ¤ - 100ê°œì”© ì²­í¬ ì²˜ë¦¬
const CHUNK_SIZE = 100;
const results = { success: 0, failed: 0 };

for (const chunk of chunkArray(trashItems, CHUNK_SIZE)) {
  for (const item of chunk) {
    try {
      if (item.type === 'FILE') {
        // íŒŒì¼ ì˜êµ¬ì‚­ì œ (ì„¹ì…˜ 3 ë¡œì§)
        await deleteFileFromTrash(item.fileId);
      } else {
        // í´ë” ì˜êµ¬ì‚­ì œ (ì„¹ì…˜ 6 ë¡œì§ - í•˜ìœ„ ì¬ê·€)
        await deleteFolderFromTrash(item.folderId);
      }
      results.success++;
    } catch (error) {
      results.failed++;
      logger.error(`íœ´ì§€í†µ ë¹„ìš°ê¸° ì‹¤íŒ¨: ${item.id}`, error);
    }
  }
}

return { 
  message: `íœ´ì§€í†µ ë¹„ìš°ê¸° ì™„ë£Œ: ${results.success}ê±´ ì‚­ì œ, ${results.failed}ê±´ ì‹¤íŒ¨`,
  success: results.success,
  failed: results.failed
};
```

---

**ì£¼ì˜ì‚¬í•­**
- **ì²­í¬ ë‹¨ìœ„ ì²˜ë¦¬**: ëŒ€ìš©ëŸ‰ ë°ì´í„° ê³ ë ¤í•˜ì—¬ 100ê°œì”© ì²˜ë¦¬
- **ìˆœì°¨ ì²˜ë¦¬**: ê° í•­ëª© ê°œë³„ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì²˜ë¦¬ (ì¼ë¶€ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ ì§„í–‰)
- **ì‹¤íŒ¨ í•­ëª© ë¡œê¹…**: ì‹¤íŒ¨í•œ í•­ëª©ì€ ë³„ë„ ë¡œê¹… ë° ê´€ë¦¬ì ì•Œë¦¼
- **Bull í**: ê° í•­ëª©ë³„ë¡œ NAS ì‚­ì œ ì‘ì—… íì— ë“±ë¡

---


##### 6.íœ´ì§€í†µ í´ë” ì˜êµ¬ ì‚­ì œ:íœ´ì§€í†µì— ìˆëŠ” í´ë” ì˜êµ¬ì‚­ì œ (í•˜ìœ„ í¬í•¨)

---

**ì²˜ë¦¬ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [í´ë” ì˜êµ¬ì‚­ì œ - ì¬ê·€ ì²˜ë¦¬ í”Œë¡œìš°]                                        â”‚
â”‚                                                                         â”‚
â”‚  ì˜ˆì‹œ: íœ´ì§€í†µì˜ /test í´ë” ì˜êµ¬ì‚­ì œ ìš”ì²­                                  â”‚
â”‚                                                                         â”‚
â”‚  [í˜„ì¬ íœ´ì§€í†µ êµ¬ì¡°]                                                       â”‚
â”‚  /.trash/{trashMetadataId}/root/path/test/                              â”‚
â”‚  â”œâ”€â”€ file1.txt                                                          â”‚
â”‚  â”œâ”€â”€ file2.txt                                                          â”‚
â”‚  â””â”€â”€ subfolder/                                                         â”‚
â”‚      â”œâ”€â”€ file3.txt                                                      â”‚
â”‚      â””â”€â”€ deep/                                                          â”‚
â”‚          â””â”€â”€ file4.txt                                                  â”‚
â”‚                                                                         â”‚
â”‚  [ì²˜ë¦¬ ìˆœì„œ]                                                             â”‚
â”‚  1. ì¬ê·€ë¡œ ëª¨ë“  í•˜ìœ„ í´ë” ID ìˆ˜ì§‘: [test, subfolder, deep]               â”‚
â”‚  2. í•´ë‹¹ í´ë”ë“¤ì˜ ëª¨ë“  íŒŒì¼ ID ìˆ˜ì§‘: [file1, file2, file3, file4]        â”‚
â”‚  3. ë™ê¸°í™” ìƒíƒœ ê²€ì¦ (AVAILABLE ì•„ë‹ˆë©´ ì°¨ë‹¨)                             â”‚
â”‚  4. DB íŠ¸ëœì­ì…˜ (ë¨¼ì € ì»¤ë°‹):                                             â”‚
â”‚     - files: 4ê°œ ëª¨ë‘ state=DELETED                                     â”‚
â”‚     - folders: 3ê°œ ëª¨ë‘ state=DELETED                                   â”‚
â”‚     - trash_metadata: ì‚­ì œ                                              â”‚
â”‚     - file_storage_objects(CACHE): PENDING                              â”‚
â”‚  5. SeaweedFS ì‚­ì œ (4ê°œ íŒŒì¼)                                           â”‚
â”‚  6. Bull í ë“±ë¡ (NAS í´ë” ì˜êµ¬ì‚­ì œ)                                     â”‚
â”‚                                                                         â”‚
â”‚  [ì‚­ì œ ëŒ€ìƒ]                                                             â”‚
â”‚  - DB: files(4), folders(3), trash_metadata(1), _storage_objects        â”‚
â”‚  - SeaweedFS: 4ê°œ íŒŒì¼                                                  â”‚
â”‚  - NAS: /.trash/{trashId}/... í´ë” ì „ì²´                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**[STEP 1] ì˜êµ¬ì‚­ì œ ìš”ì²­**

1)ìœ ì €(íœ´ì§€í†µ í´ë” ë¹„ì›Œì¤˜)===> 

---

**[STEP 2] í•˜ìœ„ í•­ëª© ì¬ê·€ ì¡°íšŒ + ë™ê¸°í™” ìƒíƒœ ê²€ì¦**

2)í•˜ìœ„ í•­ëª© ì¡°íšŒ + ë™ê¸°í™” ìƒíƒœ ê²€ì¦
```sql
-- í•˜ìœ„ ëª¨ë“  í´ë” ì¡°íšŒ (ì¬ê·€ CTE, state=TRASHED ê¸°ì¤€)
WITH RECURSIVE sub_folders AS (
  SELECT id, name FROM folders WHERE id = ëŒ€ìƒí´ë” AND state = 'TRASHED'
  UNION ALL
  SELECT f.id, f.name FROM folders f
  JOIN sub_folders sf ON f.parentId = sf.id
  WHERE f.state = 'TRASHED'
)
SELECT id FROM sub_folders;

-- í•´ë‹¹ í´ë”ë“¤ì˜ ëª¨ë“  íŒŒì¼ ì¡°íšŒ
SELECT id FROM files WHERE folderId IN (sub_folders) AND state = 'TRASHED';

-- â˜… ë¹„ì •ìƒ ìƒíƒœ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ â˜…
SELECT COUNT(*) as unavailable_count
FROM files f
JOIN file_storage_objects fso ON f.id = fso.fileId
WHERE f.folderId IN (sub_folders) 
  AND f.state = 'TRASHED'
  AND fso.storageType = 'NAS'
  AND fso.availabilityStatus NOT IN ('AVAILABLE');
```

*ë¹„ì •ìƒ ìƒíƒœ ì‚­ì œ ì°¨ë‹¨*
```
unavailable_count > 0
â†’ 409 Conflict: "ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì§€ ì•Šì€ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."

- MOVINGì¸ ê²½ìš°: "íœ´ì§€í†µ ì´ë™ì´ ì•„ì§ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤."
- ERRORì¸ ê²½ìš°: "ì´ì „ ì‘ì—…ì´ ì‹¤íŒ¨í•œ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”."
```

---

**[STEP 3] DB íŠ¸ëœì­ì…˜ (ë¨¼ì € ì»¤ë°‹)**

3)â˜…DB íŠ¸ëœì­ì…˜ ë¨¼ì €â˜…
```
=== BEGIN TRANSACTION ===
-- 1. í•˜ìœ„ ëª¨ë“  íŒŒì¼ DELETED
UPDATE files SET state=DELETED WHERE folderId IN (ì¬ê·€ë¡œ ì¡°íšŒëœ í´ë”ë“¤)

-- 2. í•˜ìœ„ ëª¨ë“  í´ë” DELETED  
UPDATE folders SET state=DELETED WHERE id IN (ì¬ê·€ë¡œ ì¡°íšŒëœ í´ë”ë“¤)

-- 3. trash_metadata ì‚­ì œ
DELETE trash_metadata WHERE folderId=ìµœìƒìœ„í´ë”

-- 4. file_storage_objects(CACHE) ìƒíƒœ ë³€ê²½
UPDATE file_storage_objects 
SET availabilityStatus=PENDING
WHERE fileId IN (í•´ë‹¹ íŒŒì¼ë“¤) AND storageType='CACHE_SEAWEED'

-- 5. ì´ë²¤íŠ¸ ê¸°ë¡
INSERT folder_events (eventType='PURGE', payloadJson={
  affectedFolderCount: 3,
  affectedFileCount: 4
})
=== COMMIT ===
```

**íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ê²°ê³¼:**
```
[DB ìƒíƒœ ë³€ê²½]
folders:
  - test (id:006): state TRASHED â†’ DELETED
  - subfolder (id:007): state TRASHED â†’ DELETED
  - deep (id:008): state TRASHED â†’ DELETED

files:
  - file1.txt ~ file4.txt: state TRASHED â†’ DELETED (4ê°œ)

file_storage_objects (CACHE):
  - 4ê°œ íŒŒì¼ ëª¨ë‘: availabilityStatus AVAILABLE â†’ PENDING

trash_metadata:
  - í•´ë‹¹ ë ˆì½”ë“œ ì‚­ì œë¨
```

---

**[STEP 4] SeaweedFS ì‚­ì œ (í•˜ìœ„ íŒŒì¼ë“¤)**

4)SeaweedFS ì‚­ì œ (í•˜ìœ„ íŒŒì¼ë“¤)
```typescript
const deleteResults = { success: 0, failed: 0 };

for (const fileId of affectedFileIds) {
  try {
    await seaweedService.delete(fileId);
    await fileStorageObjectRepository.delete({ fileId, storageType: 'CACHE_SEAWEED' });
    deleteResults.success++;
  } catch (error) {
    // ì‹¤íŒ¨í•´ë„ DB ë¡¤ë°±í•˜ì§€ ì•ŠìŒ! ë°°ì¹˜ë¡œ ì •ë¦¬
    logger.warn(`SeaweedFS ì‚­ì œ ì‹¤íŒ¨, ë°°ì¹˜ ì •ë¦¬ ëŒ€ìƒ: ${fileId}`, error);
    deleteResults.failed++;
  }
}

logger.info(`SeaweedFS ì‚­ì œ ì™„ë£Œ: ${deleteResults.success}/${affectedFileIds.length}`);
```

**SeaweedFS ì‚­ì œ ê²°ê³¼:**
```
[ì„±ê³µ ì‹œ]
- SeaweedFSì—ì„œ 4ê°œ íŒŒì¼ ì‚­ì œë¨
- file_storage_objects(CACHE_SEAWEED) 4ê°œ ë ˆì½”ë“œ ì‚­ì œë¨

[ì¼ë¶€ ì‹¤íŒ¨ ì‹œ]
- ì‹¤íŒ¨í•œ íŒŒì¼ë“¤: file_storage_objects(CACHE).availabilityStatus = PENDING
- â†’ ë°°ì¹˜ ì •ë¦¬ Workerê°€ ì£¼ê¸°ì ìœ¼ë¡œ ì²˜ë¦¬
```

---

**[STEP 5] Bull í ë“±ë¡ (NAS í´ë” ì˜êµ¬ì‚­ì œ)**

5)Bull í ë“±ë¡ (NAS í´ë” ì˜êµ¬ì‚­ì œ)
```typescript
await nasQueue.add('sync', {
  aggregateType: 'TRASH', 
  eventType: 'NAS_PURGE_FOLDER',
  payload: { 
    folderId: ëŒ€ìƒí´ë”ID,
    trashPath: '/.trash/{trashMetadataId}/root/path/test',
    affectedFileIds: ['file1-id', 'file2-id', 'file3-id', 'file4-id'],
    affectedFolderIds: ['006', '007', '008']
  }
}, { attempts: 3, backoff: { type: 'exponential', delay: 1000 } });
```

---

**[STEP 6] Bull Worker ì²˜ë¦¬ (NAS í´ë” ì˜êµ¬ì‚­ì œ)**

6)Bull Workerê°€ NASì—ì„œ ì˜êµ¬ì‚­ì œ ì²˜ë¦¬

```
[NAS ì‘ì—…]
1. í´ë” ì „ì²´ ì‚­ì œ: /.trash/{trashMetadataId}/root/path/test (ì¬ê·€ ì‚­ì œ)
   - í•˜ìœ„ íŒŒì¼ 4ê°œ ì‚­ì œ
   - í•˜ìœ„ í´ë” 3ê°œ ì‚­ì œ
2. ë¹ˆ ìƒìœ„ íœ´ì§€í†µ í´ë” ì •ë¦¬ (ì„ íƒ)
```

**ì„±ê³µ ì‹œ:**
```typescript
await db.transaction(async (tx) => {
  // NAS ë ˆì½”ë“œ ì‚­ì œ
  await tx.fileStorageObjects.delete({
    fileId: In(affectedFileIds),
    storageType: 'NAS'
  });
  
  await tx.folderStorageObjects.delete({
    folderId: In(affectedFolderIds),
    storageType: 'NAS'
  });
});

logger.info(`NAS í´ë” ì˜êµ¬ì‚­ì œ ì™„ë£Œ: ${trashPath}`);
```

**ìµœì¢… ìƒíƒœ (ì„±ê³µ ì‹œ):**
```
[DB ìƒíƒœ]
files: state=DELETED (4ê°œ) - ë…¼ë¦¬ ì‚­ì œ ì™„ë£Œ
folders: state=DELETED (3ê°œ) - ë…¼ë¦¬ ì‚­ì œ ì™„ë£Œ
file_storage_objects: ëª¨ë“  ë ˆì½”ë“œ ì‚­ì œë¨ (CACHE, NAS)
folder_storage_objects: ëª¨ë“  ë ˆì½”ë“œ ì‚­ì œë¨

[ìŠ¤í† ë¦¬ì§€ ìƒíƒœ]
SeaweedFS: íŒŒì¼ ì—†ìŒ âœ“
NAS: í´ë”/íŒŒì¼ ì—†ìŒ âœ“
```

**ì‹¤íŒ¨ ì‹œ (3íšŒ ì¬ì‹œë„ í›„):**
```typescript
await db.fileStorageObjects.update(
  { fileId: In(affectedFileIds), storageType: 'NAS' },
  { availabilityStatus: 'ERROR' }
);

await db.folderStorageObjects.update(
  { folderId: In(affectedFolderIds), storageType: 'NAS' },
  { availabilityStatus: 'ERROR' }
);

await alertService.send('NAS í´ë” ì˜êµ¬ì‚­ì œ ì‹¤íŒ¨', { 
  folderId, 
  trashPath,
  affectedFileCount: affectedFileIds.length,
  error 
});
```

**ì‹¤íŒ¨ ì‹œ ìƒíƒœ:**
```
[DB ìƒíƒœ]
files: state=DELETED
folders: state=DELETED
file_storage_objects(NAS): availabilityStatus=ERROR

[ìŠ¤í† ë¦¬ì§€ ìƒíƒœ]
NAS: /.trash/.../test/ â† í´ë”/íŒŒì¼ ë‚¨ì•„ìˆìŒ (orphan)

â€» ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ NAS í´ë” ì‚­ì œ í›„ DB ë ˆì½”ë“œ ì •ë¦¬ í•„ìš”
```


##### 7.íœ´ì§€í†µ í´ë” ë³µêµ¬:íœ´ì§€í†µì— ìˆëŠ” í´ë” ë³µêµ¬ (í•˜ìœ„ í¬í•¨)

---

**ì²˜ë¦¬ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [í´ë” ë³µêµ¬ - ì¬ê·€ ì²˜ë¦¬ í”Œë¡œìš°]                                          â”‚
â”‚                                                                         â”‚
â”‚  ì˜ˆì‹œ: íœ´ì§€í†µì˜ /test í´ë”ë¥¼ /root/pathë¡œ ë³µêµ¬ ìš”ì²­                      â”‚
â”‚                                                                         â”‚
â”‚  [í˜„ì¬ íœ´ì§€í†µ êµ¬ì¡°]                                                       â”‚
â”‚  /.trash/{trashMetadataId}/root/path/test/                              â”‚
â”‚  â”œâ”€â”€ file1.txt                                                          â”‚
â”‚  â”œâ”€â”€ file2.txt                                                          â”‚
â”‚  â””â”€â”€ subfolder/                                                         â”‚
â”‚      â”œâ”€â”€ file3.txt                                                      â”‚
â”‚      â””â”€â”€ deep/                                                          â”‚
â”‚          â””â”€â”€ file4.txt                                                  â”‚
â”‚                                                                         â”‚
â”‚  [ì²˜ë¦¬ ìˆœì„œ]                                                             â”‚
â”‚  1. ë³µêµ¬ ì •ë³´ ì¡°íšŒ API í˜¸ì¶œ â†’ ê²½ë¡œ ìƒíƒœ + ì¶©ëŒ ì—¬ë¶€ í™•ì¸                 â”‚
â”‚  2. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ìƒíƒœì— ë”°ë¼ UI í‘œì‹œ (ë³µêµ¬ ì˜µì…˜)                       â”‚
â”‚  3. ë³µêµ¬ ì‹¤í–‰ API í˜¸ì¶œ                                                   â”‚
â”‚  4. DB íŠ¸ëœì­ì…˜:                                                        â”‚
â”‚     - folders: 3ê°œ ëª¨ë‘ state=ACTIVE                                    â”‚
â”‚     - files: 4ê°œ ëª¨ë‘ state=ACTIVE                                      â”‚
â”‚     - trash_metadata ì‚­ì œ                                               â”‚
â”‚     - _storage_objects: availabilityStatus=MOVING                       â”‚
â”‚  5. Bull í ë“±ë¡ (NAS í´ë” ë³µì›)                                         â”‚
â”‚  6. Bull Worker: NASì—ì„œ ì›ë˜ ê²½ë¡œë¡œ ì´ë™                                â”‚
â”‚                                                                         â”‚
â”‚  [ë³µêµ¬ í›„ êµ¬ì¡°]                                                          â”‚
â”‚  /root/path/test/                                                       â”‚
â”‚  â”œâ”€â”€ file1.txt                                                          â”‚
â”‚  â”œâ”€â”€ file2.txt                                                          â”‚
â”‚  â””â”€â”€ subfolder/                                                         â”‚
â”‚      â”œâ”€â”€ file3.txt                                                      â”‚
â”‚      â””â”€â”€ deep/                                                          â”‚
â”‚          â””â”€â”€ file4.txt                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**ë³µêµ¬ ë¡œì§ íë¦„ë„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [í´ë” ë³µêµ¬ ë¡œì§]                                                    â”‚
â”‚                                                                     â”‚
â”‚  1. originalPathë¡œ ìƒìœ„ ê²½ë¡œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸                          â”‚
â”‚                                                                     â”‚
â”‚  2. ìƒìœ„ ê²½ë¡œ ì¡´ì¬ O                                                 â”‚
â”‚     â”œâ”€ ë™ì¼ í´ë”ëª… ì—†ìŒ â†’ ë°”ë¡œ ë³µêµ¬ (í•˜ìœ„ í¬í•¨)                       â”‚
â”‚     â””â”€ ë™ì¼ í´ë”ëª… ìˆìŒ â†’ ì‚¬ìš©ìì—ê²Œ í´ë”ëª… ìˆ˜ì • ì•ˆë‚´ í›„ ë³µêµ¬         â”‚
â”‚                                                                     â”‚
â”‚  3. ìƒìœ„ ê²½ë¡œ ì¡´ì¬ X                                                 â”‚
â”‚     â””â”€ ì‚¬ìš©ìì—ê²Œ ì„ íƒ ìš”ì²­:                                         â”‚
â”‚        â”œâ”€ A: ë‹¤ë¥¸ ê²½ë¡œ ì§€ì • â†’ í•´ë‹¹ ê²½ë¡œë¡œ ë³µêµ¬                       â”‚
â”‚        â””â”€ B: ê¸°ì¡´ ê²½ë¡œ ìƒì„± â†’ originalPath ê²½ë¡œ ìƒì„± í›„ ë³µêµ¬         â”‚
â”‚                                                                     â”‚
â”‚  â€» ëª¨ë“  ê²½ìš° í•˜ìœ„ íŒŒì¼/í´ë”ë„ ì¬ê·€ì ìœ¼ë¡œ ë³µêµ¬                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**[STEP 1] ë³µêµ¬ ì •ë³´ ì¡°íšŒ API**

GET /trash/folders/{trashId}/restore-info

```typescript
interface FolderRestoreInfoResponse {
  trashId: string;
  folderName: string;
  
  // ì›ë˜ ê²½ë¡œ ì •ë³´
  originalPath: string;           // "/root/path/test"
  originalParentId: string;       // ìƒìœ„ í´ë” ID
  
  // ìƒìœ„ ê²½ë¡œ ìƒíƒœ
  parentPathStatus: 'AVAILABLE' | 'PATH_NOT_FOUND';
  
  // AVAILABLEì¸ ê²½ìš° ì¶©ëŒ ì—¬ë¶€
  hasConflict: boolean;           // ê°™ì€ ì´ë¦„ í´ë” ì¡´ì¬ ì—¬ë¶€
  conflictFolderId?: string;
  conflictFolderName?: string;
  
  // í•˜ìœ„ í•­ëª© ìˆ˜
  childCount: {
    files: number;
    folders: number;
  };
}
```

---

**[STEP 2] ë³µêµ¬ ì‹¤í–‰ API**

POST /trash/folders/{trashId}/restore

```typescript
interface FolderRestoreRequest {
  // ë³µêµ¬ ì „ëµ (PATH_NOT_FOUNDì¸ ê²½ìš° í•„ìˆ˜)
  restoreStrategy?: 'CHOOSE_LOCATION' | 'RECREATE_PATH';
  
  // CHOOSE_LOCATIONì¸ ê²½ìš° ëŒ€ìƒ í´ë” ID
  targetParentId?: string;
  
  // ì¶©ëŒ ì‹œ ìƒˆ í´ë”ëª…
  newFolderName?: string;
}
```

**ìš”ì²­/ì‘ë‹µ ë§¤íŠ¸ë¦­ìŠ¤:**

| parentPathStatus | ì¶©ëŒ | ìš”ì²­ body | ê²°ê³¼ |
|------------------|-----|----------|------|
| AVAILABLE | ì—†ìŒ | {} | ë°”ë¡œ ë³µêµ¬ |
| AVAILABLE | ìˆìŒ | { newFolderName: "test (ë³µêµ¬ë¨)" } | ì´ë¦„ ë³€ê²½ í›„ ë³µêµ¬ |
| PATH_NOT_FOUND | - | { restoreStrategy: 'CHOOSE_LOCATION', targetParentId: 'xxx' } | ì§€ì • ìœ„ì¹˜ë¡œ ë³µêµ¬ |
| PATH_NOT_FOUND | - | { restoreStrategy: 'RECREATE_PATH' } | ì›ë˜ ê²½ë¡œ ìƒì„± í›„ ë³µêµ¬ |

---

**[STEP 3] ë³µêµ¬ í”Œë¡œìš° ìƒì„¸**

---

**Case A: ìƒìœ„ ê²½ë¡œ ì¡´ì¬ + ì¶©ëŒ ì—†ìŒ**

*DB íŠ¸ëœì­ì…˜*
```
=== BEGIN TRANSACTION ===
-- 1. ìµœìƒìœ„ í´ë” ë³µêµ¬
UPDATE folders SET state=ACTIVE WHERE id=ëŒ€ìƒí´ë”

-- 2. í•˜ìœ„ ëª¨ë“  í´ë” ë³µêµ¬ (ì¬ê·€)
UPDATE folders SET state=ACTIVE WHERE id IN (í•˜ìœ„í´ë”ë“¤)

-- 3. í•˜ìœ„ ëª¨ë“  íŒŒì¼ ë³µêµ¬
UPDATE files SET state=ACTIVE WHERE folderId IN (ëŒ€ìƒí´ë” + í•˜ìœ„í´ë”ë“¤)

-- 4. trash_metadata ì‚­ì œ
DELETE trash_metadata WHERE folderId=ëŒ€ìƒí´ë”

-- 5. â˜… ìƒíƒœë¥¼ MOVINGìœ¼ë¡œ ë³€ê²½ (NAS ì´ë™ ëŒ€ê¸°) â˜…
UPDATE file_storage_objects 
SET objectKey=ìƒˆê²½ë¡œ, availabilityStatus='MOVING'
WHERE fileId IN (ë³µêµ¬ëœ íŒŒì¼ë“¤) AND storageType='NAS'

UPDATE folder_storage_objects 
SET objectKey=ìƒˆê²½ë¡œ, availabilityStatus='MOVING'
WHERE folderId IN (ëŒ€ìƒí´ë” + í•˜ìœ„í´ë”ë“¤) AND storageType='NAS'

-- 6. ì´ë²¤íŠ¸ ê¸°ë¡
INSERT folder_events (eventType='RESTORE', payloadJson={childCount: ...})
=== COMMIT ===
```

**íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ê²°ê³¼:**
```
[DB ìƒíƒœ ë³€ê²½]
folders:
  - test (id:006): state TRASHED â†’ ACTIVE
  - subfolder (id:007): state TRASHED â†’ ACTIVE
  - deep (id:008): state TRASHED â†’ ACTIVE

files:
  - file1.txt ~ file4.txt: state TRASHED â†’ ACTIVE (4ê°œ)

file_storage_objects (NAS):
  - 4ê°œ íŒŒì¼ ëª¨ë‘: objectKey=ìƒˆê²½ë¡œ, availabilityStatus=MOVING

folder_storage_objects (NAS):
  - 3ê°œ í´ë” ëª¨ë‘: objectKey=ìƒˆê²½ë¡œ, availabilityStatus=MOVING

trash_metadata:
  - í•´ë‹¹ ë ˆì½”ë“œ ì‚­ì œë¨
```

---

**[STEP 4] Bull í ë“±ë¡ (NAS í´ë” ë³µì›)**

```typescript
await nasQueue.add('sync', {
  aggregateType: 'TRASH', 
  eventType: 'NAS_RESTORE_FOLDER',
  payload: { 
    folderId: ëŒ€ìƒí´ë”ID,
    trashPath: '/.trash/{trashMetadataId}/root/path/test',
    restorePath: '/root/path/test',
    affectedFileIds: ['file1-id', 'file2-id', 'file3-id', 'file4-id'],
    affectedFolderIds: ['006', '007', '008']
  }
}, { attempts: 3, backoff: { type: 'exponential', delay: 1000 } });
```

---

**[STEP 5] Bull Worker ì²˜ë¦¬ (NAS í´ë” ë³µì›)**

```
[NAS ì‘ì—…]
1. ìƒìœ„ í´ë” ì¡´ì¬ í™•ì¸: /root/path/
2. í´ë” í†µì§¸ë¡œ ì´ë™: /.trash/{trashId}/root/path/test â†’ /root/path/test
   (í•˜ìœ„ êµ¬ì¡° ì „ì²´ ìœ ì§€ë¨)
```

**ì„±ê³µ ì‹œ:**
```typescript
await db.transaction(async (tx) => {
  // íŒŒì¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  await tx.fileStorageObjects.update(
    { fileId: In(affectedFileIds), storageType: 'NAS' },
    { availabilityStatus: 'AVAILABLE' }
  );
  
  // í´ë” ìƒíƒœ ì—…ë°ì´íŠ¸
  await tx.folderStorageObjects.update(
    { folderId: In(affectedFolderIds), storageType: 'NAS' },
    { availabilityStatus: 'AVAILABLE' }
  );
});
```

**ìµœì¢… ìƒíƒœ (ì„±ê³µ ì‹œ):**
```
[DB ìƒíƒœ]
folders: state=ACTIVE (3ê°œ)
files: state=ACTIVE (4ê°œ)
file_storage_objects: availabilityStatus=AVAILABLE, objectKey=/root/path/test/...
folder_storage_objects: availabilityStatus=AVAILABLE, objectKey=/root/path/test/...

[NAS ìƒíƒœ]
/root/path/test/
â”œâ”€â”€ file1.txt âœ“
â”œâ”€â”€ file2.txt âœ“
â””â”€â”€ subfolder/
    â”œâ”€â”€ file3.txt âœ“
    â””â”€â”€ deep/
        â””â”€â”€ file4.txt âœ“
```

**ì‹¤íŒ¨ ì‹œ (3íšŒ ì¬ì‹œë„ í›„):**
```typescript
await db.fileStorageObjects.update(
  { fileId: In(affectedFileIds), storageType: 'NAS' },
  { availabilityStatus: 'ERROR' }
);

await db.folderStorageObjects.update(
  { folderId: In(affectedFolderIds), storageType: 'NAS' },
  { availabilityStatus: 'ERROR' }
);

await alertService.send('í´ë” ë³µêµ¬ ì‹¤íŒ¨', { 
  folderId, 
  restorePath,
  affectedFileCount: affectedFileIds.length,
  error 
});
```

**ì‹¤íŒ¨ ì‹œ ìƒíƒœ:**
```
[DB ìƒíƒœ]
folders: state=ACTIVE (ë…¼ë¦¬ì ìœ¼ë¡œëŠ” ë³µêµ¬ë¨)
files: state=ACTIVE
file_storage_objects: availabilityStatus=ERROR (NAS ë³µì› ì‹¤íŒ¨)
folder_storage_objects: availabilityStatus=ERROR

[NAS ìƒíƒœ]
/.trash/.../test/ â† íœ´ì§€í†µì— ì—¬ì „íˆ ìˆìŒ

â€» ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ NAS í´ë” ì´ë™ í›„ ìƒíƒœ ì—…ë°ì´íŠ¸ í•„ìš”
```

---

**Case B: ìƒìœ„ ê²½ë¡œ ì¡´ì¬ + ì¶©ëŒ ìˆìŒ**

1) ì‚¬ìš©ìì—ê²Œ í´ë”ëª… ìˆ˜ì • ì•ˆë‚´
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ ë™ì¼í•œ í´ë”ëª…ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤                          â”‚
â”‚                                                             â”‚
â”‚  ê¸°ì¡´ í´ë”: test (ID: 007)                                  â”‚
â”‚  ë³µêµ¬ í´ë”: test (ID: 006)                                  â”‚
â”‚  ê²½ë¡œ: /root/path                                           â”‚
â”‚                                                             â”‚
â”‚  ìƒˆ í´ë”ëª…: [test (ë³µêµ¬ë¨)        ]                          â”‚
â”‚                                                             â”‚
â”‚  â€» í•˜ìœ„ 4ê°œ íŒŒì¼, 2ê°œ í´ë”ë„ í•¨ê»˜ ë³µêµ¬ë©ë‹ˆë‹¤                  â”‚
â”‚                                                             â”‚
â”‚  [ë³µêµ¬] [ì·¨ì†Œ]                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

2) ì‚¬ìš©ìê°€ ìƒˆ í´ë”ëª… ì…ë ¥ í›„ ë³µêµ¬ ìš”ì²­ (newFolderName = "test (ë³µêµ¬ë¨)")

3) íŠ¸ëœì­ì…˜ ì²˜ë¦¬
```
=== BEGIN TRANSACTION ===
-- ìµœìƒìœ„ í´ë” ì´ë¦„ ë³€ê²½ + ë³µêµ¬
UPDATE folders SET state=ACTIVE, name='test (ë³µêµ¬ë¨)' WHERE id=ëŒ€ìƒí´ë”

-- í•˜ìœ„ ëª¨ë“  í´ë”/íŒŒì¼ ë³µêµ¬ (Case Aì™€ ë™ì¼)
UPDATE folders SET state=ACTIVE WHERE id IN (í•˜ìœ„í´ë”ë“¤)
UPDATE files SET state=ACTIVE WHERE folderId IN (ëŒ€ìƒí´ë” + í•˜ìœ„í´ë”ë“¤)

-- ìƒíƒœ ë³€ê²½
UPDATE file_storage_objects 
SET objectKey='/root/path/test (ë³µêµ¬ë¨)/...', availabilityStatus='MOVING'
WHERE fileId IN (ë³µêµ¬ëœ íŒŒì¼ë“¤) AND storageType='NAS'

UPDATE folder_storage_objects 
SET objectKey='/root/path/test (ë³µêµ¬ë¨)/...', availabilityStatus='MOVING'
WHERE folderId IN (ëŒ€ìƒí´ë” + í•˜ìœ„í´ë”ë“¤) AND storageType='NAS'

INSERT folder_events (eventType='RESTORE', payloadJson={renamed: true, oldName, newName})
=== COMMIT ===
```

4) Bull í ë“±ë¡ â†’ Bull Worker ì²˜ë¦¬ (Case Aì™€ ë™ì¼, ìƒˆ í´ë”ëª…ìœ¼ë¡œ)

**ë³µêµ¬ í›„ êµ¬ì¡°:**
```
/root/path/
â”œâ”€â”€ test/                    â† ê¸°ì¡´ í´ë” (ì¶©ëŒ)
â””â”€â”€ test (ë³µêµ¬ë¨)/            â† ë³µêµ¬ëœ í´ë” (ìƒˆ ì´ë¦„)
    â”œâ”€â”€ file1.txt
    â””â”€â”€ subfolder/
        â””â”€â”€ ...
```

---

**Case C: ìƒìœ„ ê²½ë¡œ ì¡´ì¬ X â†’ ì‚¬ìš©ì ì„ íƒ**

1) ì‚¬ìš©ìì—ê²Œ ì„ íƒ ìš”ì²­
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŒ ì›ë˜ ìƒìœ„ í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤                         â”‚
â”‚                                                             â”‚
â”‚  ë³µêµ¬ í´ë”: test                                             â”‚
â”‚  ì›ë˜ ê²½ë¡œ: /root/path/test                                 â”‚
â”‚                                                             â”‚
â”‚  ë³µêµ¬ ë°©ë²•ì„ ì„ íƒí•´ì£¼ì„¸ìš”:                                    â”‚
â”‚                                                             â”‚
â”‚  â—‹ A: ë‹¤ë¥¸ ìœ„ì¹˜ ì„ íƒ [í´ë” ì„ íƒ]                             â”‚
â”‚  â—‹ B: ì›ë˜ ê²½ë¡œ ìƒì„± (/root/path/test)                       â”‚
â”‚                                                             â”‚
â”‚  â€» í•˜ìœ„ 4ê°œ íŒŒì¼, 2ê°œ í´ë”ë„ í•¨ê»˜ ë³µêµ¬ë©ë‹ˆë‹¤                  â”‚
â”‚                                                             â”‚
â”‚  [ë³µêµ¬] [ì·¨ì†Œ]                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**2-A) CHOOSE_LOCATION ì„ íƒ ì‹œ**

- ì‚¬ìš©ìê°€ targetParentId ì„ íƒ (ì˜ˆ: "/documents" í´ë”)
- í•´ë‹¹ ìœ„ì¹˜ë¡œ í´ë” ë³µêµ¬ + í•˜ìœ„ ì¬ê·€ ë³µêµ¬

```
=== BEGIN TRANSACTION ===
-- í´ë” ë³µêµ¬ (ìƒˆ ìœ„ì¹˜ë¡œ)
UPDATE folders SET state=ACTIVE, parentId=ì„ íƒëœí´ë”ID WHERE id=ëŒ€ìƒí´ë”
UPDATE folders SET state=ACTIVE WHERE id IN (í•˜ìœ„í´ë”ë“¤)
UPDATE files SET state=ACTIVE WHERE folderId IN (ëŒ€ìƒí´ë” + í•˜ìœ„í´ë”ë“¤)

-- ìƒíƒœ ë³€ê²½ (ìƒˆ ê²½ë¡œë¡œ)
UPDATE file_storage_objects 
SET objectKey='/documents/test/...', availabilityStatus='MOVING'
WHERE fileId IN (ë³µêµ¬ëœ íŒŒì¼ë“¤) AND storageType='NAS'

UPDATE folder_storage_objects 
SET objectKey='/documents/test/...', availabilityStatus='MOVING'
WHERE folderId IN (ëŒ€ìƒí´ë” + í•˜ìœ„í´ë”ë“¤) AND storageType='NAS'
=== COMMIT ===
```

Bull í ë“±ë¡:
```typescript
await nasQueue.add('sync', {
  aggregateType: 'TRASH', 
  eventType: 'NAS_RESTORE_FOLDER',
  payload: { 
    trashPath: '/.trash/{trashId}/root/path/test',
    restorePath: '/documents/test',  // ìƒˆ ìœ„ì¹˜
    affectedFileIds, affectedFolderIds
  }
});
```

---

**2-B) RECREATE_PATH ì„ íƒ ì‹œ**

```
=== BEGIN TRANSACTION ===
-- 1. ìƒìœ„ ê²½ë¡œ ì¬ìƒì„± (originalPath ê¸°ì¤€)
-- "/root/path" â†’ ê° í´ë” ì¡´ì¬ í™•ì¸/ìƒì„±
FOR each folder IN parentPath:
  IF folder NOT EXISTS OR folder.state != 'ACTIVE':
    INSERT folders (name, parentId, state='ACTIVE')
    INSERT folder_storage_objects (folderId, storageType='NAS', objectKey=í´ë”ê²½ë¡œ, availabilityStatus='MOVING')

-- 2. í´ë” ë³µêµ¬ (í•˜ìœ„ í¬í•¨)
UPDATE folders SET state=ACTIVE, parentId=ì¬ìƒì„±ëœìƒìœ„í´ë”ID WHERE id=ëŒ€ìƒí´ë”
UPDATE folders SET state=ACTIVE WHERE id IN (í•˜ìœ„í´ë”ë“¤)
UPDATE files SET state=ACTIVE WHERE folderId IN (ëŒ€ìƒí´ë” + í•˜ìœ„í´ë”ë“¤)

-- 3. trash_metadata ì‚­ì œ
DELETE trash_metadata WHERE folderId=ëŒ€ìƒí´ë”

-- 4. ìƒíƒœ ë³€ê²½
UPDATE file_storage_objects 
SET objectKey='/root/path/test/...', availabilityStatus='MOVING'
WHERE fileId IN (ë³µêµ¬ëœ íŒŒì¼ë“¤) AND storageType='NAS'

UPDATE folder_storage_objects 
SET objectKey='/root/path/test/...', availabilityStatus='MOVING'
WHERE folderId IN (ëŒ€ìƒí´ë” + í•˜ìœ„í´ë”ë“¤) AND storageType='NAS'

-- 5. ì´ë²¤íŠ¸ ê¸°ë¡
INSERT folder_events (eventType='RESTORE', payloadJson={pathRecreated: true, ...})
=== COMMIT ===
```

**íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ê²°ê³¼:**
```
[DB ìƒíƒœ ë³€ê²½]
folders:
  - /root: ê¸°ì¡´ ì¡´ì¬ or ìƒì„± (state=ACTIVE)
  - /root/path: ìƒˆë¡œ ìƒì„± (state=ACTIVE)
  - test (ë³µêµ¬ë¨): state TRASHED â†’ ACTIVE
  - subfolder, deep: state TRASHED â†’ ACTIVE

files:
  - file1.txt ~ file4.txt: state TRASHED â†’ ACTIVE

_storage_objects:
  - ëª¨ë‘ availabilityStatus=MOVING
```

Bull í ë“±ë¡ (ê²½ë¡œ ìƒì„± + í´ë” ë³µì›)
```typescript
await nasQueue.add('sync', {
  aggregateType: 'TRASH', 
  eventType: 'NAS_RESTORE_FOLDER_WITH_PATH',
  payload: { 
    trashPath: '/.trash/{trashId}/root/path/test',
    restorePath: '/root/path/test',
    foldersToCreate: ['/root', '/root/path'],
    affectedFileIds, affectedFolderIds
  }
}, { attempts: 3, backoff: { type: 'exponential', delay: 1000 } });
```

---

**Bull Worker ì²˜ë¦¬ (ê²½ë¡œ ìƒì„± + í´ë” ë³µì›)**

```
[NAS ì‘ì—…]
1. í´ë” ìƒì„±: /root (ì¡´ì¬ ì‹œ skip)
2. í´ë” ìƒì„±: /root/path
3. í´ë” í†µì§¸ë¡œ ì´ë™: /.trash/.../test â†’ /root/path/test
```

**ì„±ê³µ ì‹œ:**
```typescript
await db.transaction(async (tx) => {
  // íŒŒì¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  await tx.fileStorageObjects.update(
    { fileId: In(affectedFileIds), storageType: 'NAS' },
    { availabilityStatus: 'AVAILABLE' }
  );
  
  // í´ë” ìƒíƒœ ì—…ë°ì´íŠ¸ (ìƒì„±ëœ í´ë” + ë³µêµ¬ëœ í´ë”)
  await tx.folderStorageObjects.update(
    { folderId: In([...createdFolderIds, ...affectedFolderIds]), storageType: 'NAS' },
    { availabilityStatus: 'AVAILABLE' }
  );
});
```

**ìµœì¢… ìƒíƒœ (ì„±ê³µ ì‹œ):**
```
[DB ìƒíƒœ]
folders: state=ACTIVE (ìƒì„±ëœ í´ë” + ë³µêµ¬ëœ í´ë”)
files: state=ACTIVE
_storage_objects: availabilityStatus=AVAILABLE

[NAS ìƒíƒœ]
/root/path/test/
â”œâ”€â”€ file1.txt âœ“
â”œâ”€â”€ file2.txt âœ“
â””â”€â”€ subfolder/
    â”œâ”€â”€ file3.txt âœ“
    â””â”€â”€ deep/
        â””â”€â”€ file4.txt âœ“
```

---


##### 8.ëª¨ë“  í•­ëª© ë³µì›:íœ´ì§€í†µ ì „ì²´ ë³µì›

---

**ì²˜ë¦¬ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [ëª¨ë“  í•­ëª© ë³µì› í”Œë¡œìš°]                                                  â”‚
â”‚                                                                         â”‚
â”‚  ìœˆë„ìš° íœ´ì§€í†µì˜ "ëª¨ë“  í•­ëª© ë³µì›" ê¸°ëŠ¥ê³¼ ë™ì¼                               â”‚
â”‚                                                                         â”‚
â”‚  [ì²˜ë¦¬ ìˆœì„œ]                                                             â”‚
â”‚  1. íœ´ì§€í†µ ì „ì²´ í•­ëª© ì¡°íšŒ                                                â”‚
â”‚  2. ê° í•­ëª© ë³µêµ¬ ì •ë³´ í™•ì¸ (ê²½ë¡œ ì¡´ì¬/ì¶©ëŒ ì—¬ë¶€)                           â”‚
â”‚  3. ë³µêµ¬ ê°€ëŠ¥í•œ í•­ëª©ë§Œ ìë™ ë³µêµ¬:                                         â”‚
â”‚     - ê²½ë¡œ ì¡´ì¬ + ì¶©ëŒ ì—†ìŒ â†’ ë°”ë¡œ ë³µêµ¬                                   â”‚
â”‚     - ê²½ë¡œ ì—†ìŒ â†’ ê²½ë¡œ ìë™ ìƒì„± í›„ ë³µêµ¬                                  â”‚
â”‚  4. ì¶©ëŒ í•­ëª©ì€ skip (ì‚¬ìš©ì ìˆ˜ë™ ì²˜ë¦¬)                                   â”‚
â”‚                                                                         â”‚
â”‚  â€» ëŒ€ìš©ëŸ‰ ë°ì´í„° ê³ ë ¤í•˜ì—¬ ì²­í¬ ë‹¨ìœ„ ì²˜ë¦¬                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**API: POST /trash/restore-all**

---

**[STEP 1] ì „ì²´ ë³µì› ìš”ì²­**

1)ìœ ì €(ëª¨ë“  í•­ëª© ë³µì›í•´ì¤˜)===> 

---

**[STEP 2] íœ´ì§€í†µ ì „ì²´ í•­ëª© ì¡°íšŒ + ë³µêµ¬ ì •ë³´ í™•ì¸**

```typescript
const trashItems = await trashMetadataRepository.findAll();
const results = { 
  restored: 0, 
  skipped: 0,  // ì¶©ëŒë¡œ skip
  failed: 0 
};
const skippedItems: SkippedItem[] = [];

for (const item of trashItems) {
  try {
    const restoreInfo = item.type === 'FILE' 
      ? await getFileRestoreInfo(item.fileId)
      : await getFolderRestoreInfo(item.folderId);
    
    // ì¶©ëŒ ìˆìœ¼ë©´ skip (ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í•¨)
    if (restoreInfo.hasConflict) {
      results.skipped++;
      skippedItems.push({ 
        id: item.id, 
        name: restoreInfo.name,
        reason: 'CONFLICT',
        conflictWith: restoreInfo.conflictFileName || restoreInfo.conflictFolderName
      });
      continue;
    }
    
    // ë³µêµ¬ ì‹¤í–‰ (ê²½ë¡œ ì—†ìœ¼ë©´ ìë™ ìƒì„±)
    if (item.type === 'FILE') {
      await restoreFile(item.fileId);
    } else {
      await restoreFolder(item.folderId, { restoreStrategy: 'RECREATE_PATH' });
    }
    results.restored++;
    
  } catch (error) {
    results.failed++;
    logger.error(`ë³µì› ì‹¤íŒ¨: ${item.id}`, error);
  }
}
```

---

**[STEP 3] ì‘ë‹µ ë°˜í™˜**

```typescript
interface RestoreAllResponse {
  message: string;
  restored: number;      // ë³µì› ì„±ê³µ
  skipped: number;       // ì¶©ëŒë¡œ skip
  failed: number;        // ì‹¤íŒ¨
  skippedItems: {        // skipëœ í•­ëª© ëª©ë¡ (ì‚¬ìš©ìê°€ ìˆ˜ë™ ì²˜ë¦¬)
    id: string;
    name: string;
    reason: 'CONFLICT';
    conflictWith: string;
  }[];
}
```

---

**ì£¼ì˜ì‚¬í•­**
- **ì¶©ëŒ í•­ëª© skip**: ê°™ì€ ì´ë¦„ íŒŒì¼/í´ë” ì¡´ì¬ ì‹œ ìë™ ë³µì› ë¶ˆê°€ â†’ ì‚¬ìš©ì ìˆ˜ë™ ì²˜ë¦¬
- **ê²½ë¡œ ìë™ ìƒì„±**: ì›ë˜ ê²½ë¡œ ì—†ìœ¼ë©´ `RECREATE_PATH` ì „ëµ ì ìš©
- **ìˆœì°¨ ì²˜ë¦¬**: ê° í•­ëª© ê°œë³„ íŠ¸ëœì­ì…˜
- **skip ëª©ë¡ ë°˜í™˜**: ì‚¬ìš©ìê°€ ì¶©ëŒ í•­ëª© í™•ì¸ ê°€ëŠ¥

---

---

## ì£¼ì˜ì‚¬í•­

**íœ´ì§€í†µ ì´ë™ ì‹œ**
- í´ë” ì‚­ì œ ì‹œ **í•˜ìœ„ ëª¨ë“  í•­ëª© í•¨ê»˜ TRASHED**
- trash_metadataëŠ” **ìµœìƒìœ„ í•­ëª©ë§Œ ê¸°ë¡**
- í•˜ìœ„ íŒŒì¼/í´ë”ëŠ” ê°œë³„ ë³µêµ¬ ë¶ˆê°€ (í´ë” ë‹¨ìœ„ë¡œë§Œ)

**íœ´ì§€í†µ ë³µêµ¬ ì‹œ**
- **originalPath ì €ì¥ í•„ìˆ˜**: ì‚­ì œ ì‹œì ì˜ ì „ì²´ ê²½ë¡œ
- **ê²½ë¡œ ìë™ ìƒì„±**: íŒŒì¼ì€ í•­ìƒ ìë™, í´ë”ëŠ” ì‚¬ìš©ì ì„ íƒ ì‹œ
- **í•˜ìœ„ ì¬ê·€ ë³µêµ¬**: í´ë” ë³µêµ¬ ì‹œ í•˜ìœ„ ëª¨ë“  íŒŒì¼/í´ë” í•¨ê»˜ ë³µêµ¬
- **ì¶©ëŒ ì²˜ë¦¬**: ê°™ì€ ì´ë¦„ ì¡´ì¬ ì‹œ ì‚¬ìš©ìì—ê²Œ ì´ë¦„ ë³€ê²½ ìš”ì²­

**NAS ì²˜ë¦¬**
- í´ë”ëŠ” **í†µì§¸ë¡œ ì´ë™/ë³µì›**: í•˜ìœ„ êµ¬ì¡° ìœ ì§€
- ê²½ë¡œ ìƒì„± ì‹œ **í´ë” ìƒì„± í›„ íŒŒì¼/í´ë” ë³µì›**
- **MOVING ìƒíƒœë¡œ NAS ë™ê¸°í™” ì¶”ì **: DB ì»¤ë°‹ í›„ Bull Workerê°€ NAS ì²˜ë¦¬
- **ë™ê¸°í™” ì™„ë£Œ í™•ì¸**: `availabilityStatus = 'AVAILABLE'`ì¼ ë•Œë§Œ ì¶”ê°€ ì‘ì—… ê°€ëŠ¥
- **ë™ê¸°í™” ì‹¤íŒ¨ ì‹œ**: `availabilityStatus = 'ERROR'` + ê´€ë¦¬ì ì•Œë¦¼