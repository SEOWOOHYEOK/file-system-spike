# 008. 폴더 관리 API

---

## 개요

폴더 생성, 이름 수정, 이동, 삭제, 조회 등 폴더 관련 API의 상세 플로우를 정의합니다.

**참고 문서**
- [001.정의.md](./001.정의.md) - 공통 사항 (로깅, 동시성 제어, NAS 동기화)
- [0011.엔티티.md](./0011.엔티티.md) - 엔티티 정의

---

## API 엔드포인트 목록

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | /folders | 폴더 생성 |P
| GET | /folders/{folderId} | 폴더 정보 조회 |
| GET | /folders/{folderId}/contents | 폴더 내용 조회 (하위 폴더/파일) |
| PUT | /folders/{folderId}/rename | 폴더명 변경 |
| POST | /folders/{folderId}/move | 폴더 이동 |
| DELETE | /folders/{folderId} | 폴더 삭제 (휴지통) |

---

## 공통: 폴더 충돌 처리 전략

```
┌─────────────────────────────────────────────────────────────────────────┐
│  [동일 이름 폴더 충돌 처리]                                                │
│                                                                         │
│  conflictStrategy 옵션:                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │ ERROR (기본값):                                                     ││
│  │   → 409 Conflict + "동일한 이름의 폴더가 존재합니다"                 ││
│  │   → 프론트엔드에서 사용자에게 다른 이름 입력 요청                    ││
│  │                                                                     ││
│  │ RENAME:                                                             ││
│  │   → 폴더명 자동 변경: "folder" → "folder (1)"                       ││
│  │   → 중복 번호 자동 증가: (1), (2), (3)...                           ││
│  │   → 변경된 이름으로 진행                                            ││
│  │                                                                     ││
│  │ SKIP (폴더 이동 시에만):                                             ││
│  │   → 이동하지 않고 건너뛰기                                          ││
│  │   → 200 OK + { skipped: true }                                     ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

# 1. 폴더 생성

## 1-1. POST /folders - 폴더 생성

### Request

```typescript
interface CreateFolderRequest {
  name: string;                     // 폴더 이름
  parentId: string | null;          // 상위 폴더 ID (null = 루트)
  conflictStrategy?: 'ERROR' | 'RENAME';  // 기본값: ERROR
}
```

### Response

```typescript
interface CreateFolderResponse {
  id: string;
  name: string;
  parentId: string | null;
  path: string;                     // 전체 경로 (예: /project/docs)
  storageStatus: {
    nas: 'SYNCING';
  };
  createdAt: string;
}
```

### 처리 플로우

```
┌─────────────────────────────────────────────────────────────────────────┐
│  [POST /folders 처리 플로우]                                              │
│                                                                         │
│  1. 요청 검증                                                            │
│     └─ 폴더명 유효성 검사 (특수문자, 길이 등)                            │
│                                                                         │
│  2. UUID 미리 생성                                                       │
│     └─ folderId = uuid.v4()                                             │
│                                                                         │
│  3. === BEGIN TRANSACTION ===                                           │
│                                                                         │
│  4. 상위 폴더 존재 확인 (parentId가 있는 경우)                           │
│     SELECT * FROM folders WHERE id = :parentId AND state = 'ACTIVE';    │
│     └─ 없으면 404 (PARENT_FOLDER_NOT_FOUND)                             │
│                                                                         │
│  5. ★동일 이름 폴더 존재 확인★                                          │
│     SELECT * FROM folders                                               │
│     WHERE parentId = :parentId AND name = :name AND state = 'ACTIVE';   │
│     ├─ 충돌 + ERROR → 409 (DUPLICATE_FOLDER_EXISTS)                     │
│     └─ 충돌 + RENAME → 자동 이름 변경                                   │
│                                                                         │
│  6. 폴더 생성                                                            │
│     INSERT folders (id, name, parentId, path, state=ACTIVE)             │
│                                                                         │
│  7. NAS 저장소 객체 생성                                                 │
│     INSERT folder_storage_objects (folderId, NAS, SYNCING)              │
│                                                                         │
│  8. 이벤트 기록                                                          │
│     INSERT folder_events (CREATE, { name, path })                       │
│                                                                         │
│  9. === COMMIT ===                                                      │
│                                                                         │
│  10. Bull 큐 등록                                                        │
│      NAS_SYNC_MKDIR 작업 (3회 재시도)                                   │
│                                                                         │
│  11. 응답 반환                                                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### SQL

```sql
-- 상위 폴더 확인
SELECT * FROM folders WHERE id = :parentId AND state = 'ACTIVE';

-- 동일 이름 폴더 확인
SELECT * FROM folders 
WHERE parentId = :parentId 
  AND name = :folderName 
  AND state = 'ACTIVE';

-- 자동 이름 생성 시 기존 번호 조회
SELECT name FROM folders 
WHERE parentId = :parentId 
  AND name LIKE :baseName || ' (%)' 
  AND state = 'ACTIVE';

-- 폴더 생성
INSERT INTO folders (id, name, parentId, path, state, createdAt, updatedAt)
VALUES (:folderId, :finalName, :parentId, :path, 'ACTIVE', NOW(), NOW());

-- NAS 저장소 객체 생성
INSERT INTO folder_storage_objects (
  id, folderId, storageType, objectKey, availabilityStatus, createdAt
) VALUES (
  :id, :folderId, 'NAS', :nasPath, 'SYNCING', NOW()
);

-- 이벤트 기록
INSERT INTO folder_events (id, folderId, eventType, traceId, payloadJson, occurredAt)
VALUES (:id, :folderId, 'CREATE', :traceId, '{"name": "...", "path": "..."}', NOW());
```

### 에러 처리

| 상황 | HTTP Status | 에러 코드 |
|------|-------------|----------|
| 상위 폴더 없음 | 404 | PARENT_FOLDER_NOT_FOUND |
| 동일 이름 폴더 존재 | 409 | DUPLICATE_FOLDER_EXISTS |
| 폴더명 유효하지 않음 | 400 | INVALID_FOLDER_NAME |

---

# 2. 폴더 조회

## 2-1. GET /folders/{folderId} - 폴더 정보 조회

### Response

```typescript
interface FolderInfoResponse {
  id: string;
  name: string;
  parentId: string | null;
  path: string;
  state: 'ACTIVE' | 'TRASHED';
  storageStatus: {
    nas: 'AVAILABLE' | 'SYNCING' | 'ERROR' | null;
  };
  // 통계
  fileCount: number;                // 직계 파일 수
  folderCount: number;              // 직계 폴더 수
  totalSize: number;                // 하위 전체 파일 크기 합
  createdAt: string;
  updatedAt: string;
}
```

### 처리 플로우

```
┌─────────────────────────────────────────────────────────────────────────┐
│  [GET /folders/{folderId} 처리 플로우]                                    │
│                                                                         │
│  1. 폴더 조회                                                            │
│     └─ folders + folder_storage_objects JOIN                            │
│                                                                         │
│  2. 통계 계산                                                            │
│     ├─ 직계 파일 수: COUNT(files WHERE folderId = ?)                    │
│     ├─ 직계 폴더 수: COUNT(folders WHERE parentId = ?)                  │
│     └─ 전체 크기: SUM(files.sizeBytes) - 재귀 또는 캐싱                 │
│                                                                         │
│  3. 응답 반환                                                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### SQL

```sql
-- 폴더 정보 조회
SELECT 
  fo.*,
  fso.availabilityStatus as nasStatus,
  (SELECT COUNT(*) FROM files f WHERE f.folderId = fo.id AND f.state = 'ACTIVE') as fileCount,
  (SELECT COUNT(*) FROM folders sub WHERE sub.parentId = fo.id AND sub.state = 'ACTIVE') as folderCount
FROM folders fo
LEFT JOIN folder_storage_objects fso 
  ON fo.id = fso.folderId AND fso.storageType = 'NAS'
WHERE fo.id = :folderId;
```

---

## 2-2. GET /folders/{folderId}/contents - 폴더 내용 조회

### Request (Query Parameters)

```typescript
interface GetFolderContentsQuery {
  sortBy?: 'name' | 'createdAt' | 'updatedAt' | 'size';
  sortOrder?: 'asc' | 'desc';
  page?: number;                    // 기본값: 1
  limit?: number;                   // 기본값: 50
}
```

### Response

```typescript
interface FolderContentsResponse {
  folderId: string;
  path: string;
  
  // 브레드크럼 (상위 폴더 목록)
  breadcrumbs: {
    id: string;
    name: string;
  }[];
  
  // 하위 폴더 목록
  folders: {
    id: string;
    name: string;
    path: string;
    storageStatus: {
      nas: 'AVAILABLE' | 'SYNCING' | 'ERROR' | null;
    };
    fileCount: number;
    folderCount: number;
    updatedAt: string;
  }[];
  
  // 파일 목록
  files: {
    id: string;
    name: string;
    size: number;
    mimeType: string;
    storageStatus: {
      cache: 'AVAILABLE' | 'MISSING' | null;
      nas: 'AVAILABLE' | 'SYNCING' | 'ERROR' | null;
    };
    updatedAt: string;
  }[];
  
  pagination: {
    page: number;
    limit: number;
    totalFolders: number;
    totalFiles: number;
  };
}
```

### 처리 플로우

```
┌─────────────────────────────────────────────────────────────────────────┐
│  [GET /folders/{folderId}/contents 처리 플로우]                           │
│                                                                         │
│  1. 폴더 존재 확인                                                       │
│     └─ 없거나 TRASHED → 404                                             │
│                                                                         │
│  2. 브레드크럼 생성                                                      │
│     └─ 상위 폴더 체인 조회 (재귀 CTE)                                   │
│                                                                         │
│  3. 하위 폴더 조회                                                       │
│     ├─ folders WHERE parentId = :folderId AND state = 'ACTIVE'          │
│     ├─ folder_storage_objects JOIN                                      │
│     └─ 정렬 및 페이지네이션                                              │
│                                                                         │
│  4. 파일 조회                                                            │
│     ├─ files WHERE folderId = :folderId AND state = 'ACTIVE'            │
│     ├─ file_storage_objects JOIN                                        │
│     └─ 정렬 및 페이지네이션                                              │
│                                                                         │
│  5. 응답 반환                                                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### SQL

```sql
-- 브레드크럼 조회 (재귀 CTE)
WITH RECURSIVE folder_path AS (
  SELECT id, name, parentId, 0 as depth
  FROM folders
  WHERE id = :folderId
  
  UNION ALL
  
  SELECT f.id, f.name, f.parentId, fp.depth + 1
  FROM folders f
  JOIN folder_path fp ON f.id = fp.parentId
  WHERE fp.depth < 100  -- 무한 루프 방지
)
SELECT id, name FROM folder_path ORDER BY depth DESC;

-- 하위 폴더 조회
SELECT 
  fo.id, fo.name, fo.path, fo.updatedAt,
  fso.availabilityStatus as nasStatus,
  (SELECT COUNT(*) FROM files f WHERE f.folderId = fo.id AND f.state = 'ACTIVE') as fileCount,
  (SELECT COUNT(*) FROM folders sub WHERE sub.parentId = fo.id AND sub.state = 'ACTIVE') as folderCount
FROM folders fo
LEFT JOIN folder_storage_objects fso 
  ON fo.id = fso.folderId AND fso.storageType = 'NAS'
WHERE fo.parentId = :folderId AND fo.state = 'ACTIVE'
ORDER BY fo.name ASC
LIMIT :limit OFFSET :offset;

-- 파일 조회
SELECT 
  f.id, f.name, f.sizeBytes as size, f.mimeType, f.updatedAt,
  fso_cache.availabilityStatus as cacheStatus,
  fso_nas.availabilityStatus as nasStatus
FROM files f
LEFT JOIN file_storage_objects fso_cache 
  ON f.id = fso_cache.fileId AND fso_cache.storageType = 'CACHE_SEAWEED'
LEFT JOIN file_storage_objects fso_nas 
  ON f.id = fso_nas.fileId AND fso_nas.storageType = 'NAS'
WHERE f.folderId = :folderId AND f.state = 'ACTIVE'
ORDER BY f.name ASC
LIMIT :limit OFFSET :offset;
```

---

# 3. 폴더 수정

## 3-1. PUT /folders/{folderId}/rename - 폴더명 변경

### Request

```typescript
interface RenameFolderRequest {
  newName: string;
  conflictStrategy?: 'ERROR' | 'RENAME';  // 기본값: ERROR
}
```

### Response

```typescript
interface RenameFolderResponse {
  id: string;
  name: string;                     // 최종 폴더명
  path: string;                     // 새 경로
  storageStatus: {
    nas: 'SYNCING';
  };
  updatedAt: string;
}
```

### 처리 플로우

```
┌─────────────────────────────────────────────────────────────────────────┐
│  [PUT /folders/{folderId}/rename 처리 플로우]                             │
│                                                                         │
│  1. === BEGIN TRANSACTION ===                                           │
│                                                                         │
│  2. ★폴더 락 획득★ (Race Condition 방지)                                │
│     SELECT * FROM folders WHERE id = :folderId FOR UPDATE;              │
│     └─ 없으면 404 반환                                                  │
│                                                                         │
│  3. NAS 동기화 상태 체크                                                 │
│     SELECT * FROM folder_storage_objects                                │
│     WHERE folderId = :folderId AND storageType = 'NAS' FOR UPDATE;      │
│     └─ SYNCING이면 409 Conflict (FOLDER_SYNCING)                        │
│                                                                         │
│  4. ★동일 이름 폴더 존재 확인★                                          │
│     SELECT * FROM folders                                               │
│     WHERE parentId = :currentParentId AND name = :newName               │
│       AND id != :folderId AND state = 'ACTIVE';                         │
│     ├─ 충돌 + ERROR → 409 (DUPLICATE_FOLDER_EXISTS)                     │
│     └─ 충돌 + RENAME → 자동 이름 변경                                   │
│                                                                         │
│  5. 폴더명 업데이트                                                      │
│     UPDATE folders SET name = :finalName, path = :newPath               │
│     WHERE id = :folderId;                                               │
│                                                                         │
│  6. ★하위 폴더/파일 path 일괄 업데이트★ (재귀적)                        │
│     UPDATE folders SET path = REPLACE(path, :oldPath, :newPath)         │
│     WHERE path LIKE :oldPath || '/%';                                   │
│                                                                         │
│  7. NAS 경로 + 동기화 상태 업데이트                                      │
│     UPDATE folder_storage_objects                                       │
│     SET objectKey = :newNasPath, availabilityStatus = 'SYNCING';        │
│                                                                         │
│  8. 하위 폴더/파일 NAS 경로 업데이트 (선택적)                            │
│     -- NAS에서 폴더 이름변경은 한 번에 처리되므로                        │
│     -- 하위 항목의 DB 경로만 업데이트                                    │
│                                                                         │
│  9. 이벤트 기록                                                          │
│     INSERT folder_events (RENAME, { oldName, newName, oldPath, newPath })│
│                                                                         │
│  10. === COMMIT ===                                                     │
│                                                                         │
│  11. Bull 큐 등록                                                        │
│      NAS_SYNC_RENAME_DIR 작업 (3회 재시도)                              │
│                                                                         │
│  12. 응답 반환                                                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### SQL

```sql
-- 폴더 락 획득
SELECT * FROM folders WHERE id = :folderId FOR UPDATE;

-- NAS 상태 체크
SELECT * FROM folder_storage_objects 
WHERE folderId = :folderId AND storageType = 'NAS' FOR UPDATE;

-- 동일 이름 폴더 확인
SELECT * FROM folders 
WHERE parentId = :currentParentId 
  AND name = :newName 
  AND id != :folderId 
  AND state = 'ACTIVE';

-- 폴더명 업데이트
UPDATE folders SET name = :finalName, path = :newPath, updatedAt = NOW()
WHERE id = :folderId;

-- 하위 폴더 path 일괄 업데이트
UPDATE folders SET path = REPLACE(path, :oldPath, :newPath), updatedAt = NOW()
WHERE path LIKE :oldPath || '/%';

-- NAS 경로 업데이트
UPDATE folder_storage_objects 
SET objectKey = :newNasPath, availabilityStatus = 'SYNCING', updatedAt = NOW()
WHERE folderId = :folderId AND storageType = 'NAS';

-- 이벤트 기록
INSERT INTO folder_events (id, folderId, eventType, traceId, payloadJson, occurredAt)
VALUES (:id, :folderId, 'RENAME', :traceId, 
  '{"oldName": "...", "newName": "...", "oldPath": "...", "newPath": "..."}', NOW());
```

### 에러 처리

| 상황 | HTTP Status | 에러 코드 |
|------|-------------|----------|
| 폴더 없음 | 404 | FOLDER_NOT_FOUND |
| NAS 동기화 중 | 409 | FOLDER_SYNCING |
| 동일 이름 폴더 존재 | 409 | DUPLICATE_FOLDER_EXISTS |

---

## 3-2. POST /folders/{folderId}/move - 폴더 이동

### Request

```typescript
interface MoveFolderRequest {
  targetParentId: string;           // 대상 상위 폴더 ID
  conflictStrategy?: 'ERROR' | 'RENAME' | 'SKIP';  // 기본값: ERROR
}
```

### Response

```typescript
interface MoveFolderResponse {
  id: string;
  name: string;
  parentId: string;                 // 새 상위 폴더 ID
  path: string;                     // 새 경로
  skipped?: boolean;                // SKIP인 경우
  reason?: string;
  storageStatus: {
    nas: 'SYNCING';
  };
  updatedAt: string;
}
```

### 처리 플로우

```
┌─────────────────────────────────────────────────────────────────────────┐
│  [POST /folders/{folderId}/move 처리 플로우]                              │
│                                                                         │
│  1. === BEGIN TRANSACTION ===                                           │
│                                                                         │
│  2. 대상 상위 폴더 존재 확인                                             │
│     SELECT * FROM folders WHERE id = :targetParentId AND state='ACTIVE';│
│     └─ 없으면 404 (TARGET_FOLDER_NOT_FOUND)                             │
│                                                                         │
│  3. ★이동할 폴더 락 획득★                                               │
│     SELECT * FROM folders WHERE id = :folderId FOR UPDATE;              │
│     └─ 없으면 404 반환                                                  │
│                                                                         │
│  4. ★순환 이동 방지 체크★                                               │
│     -- targetParentId가 folderId의 하위 폴더인지 확인                   │
│     SELECT * FROM folders                                               │
│     WHERE id = :targetParentId                                          │
│       AND path LIKE (SELECT path FROM folders WHERE id = :folderId)||'/%';│
│     └─ 결과 있으면 409 (CIRCULAR_MOVE)                                  │
│                                                                         │
│  5. NAS 동기화 상태 체크                                                 │
│     SELECT * FROM folder_storage_objects                                │
│     WHERE folderId = :folderId AND storageType = 'NAS' FOR UPDATE;      │
│     └─ SYNCING이면 409 (FOLDER_SYNCING)                                 │
│                                                                         │
│  6. ★동일 이름 폴더 존재 확인★ (대상 폴더에서)                          │
│     SELECT * FROM folders                                               │
│     WHERE parentId = :targetParentId AND name = :folderName             │
│       AND state = 'ACTIVE';                                             │
│     ├─ 충돌 + ERROR → 409 (DUPLICATE_FOLDER_EXISTS)                     │
│     ├─ 충돌 + RENAME → 자동 이름 변경                                   │
│     └─ 충돌 + SKIP → ROLLBACK + 200 OK (skipped: true)                 │
│                                                                         │
│  7. 폴더 이동 (부모 변경)                                                │
│     UPDATE folders                                                      │
│     SET parentId = :targetParentId, name = :finalName, path = :newPath  │
│     WHERE id = :folderId;                                               │
│                                                                         │
│  8. ★하위 폴더/파일 path 일괄 업데이트★ (재귀적)                        │
│     UPDATE folders SET path = REPLACE(path, :oldPath, :newPath)         │
│     WHERE path LIKE :oldPath || '/%';                                   │
│                                                                         │
│  9. NAS 경로 + 동기화 상태 업데이트                                      │
│     UPDATE folder_storage_objects                                       │
│     SET objectKey = :newNasPath, availabilityStatus = 'SYNCING';        │
│                                                                         │
│  10. 이벤트 기록                                                         │
│      INSERT folder_events (MOVE, { sourceParent, targetParent })        │
│                                                                         │
│  11. === COMMIT ===                                                     │
│                                                                         │
│  12. Bull 큐 등록                                                        │
│      NAS_SYNC_MOVE_DIR 작업 (3회 재시도)                                │
│                                                                         │
│  13. 응답 반환                                                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### SQL

```sql
-- 대상 폴더 확인
SELECT * FROM folders WHERE id = :targetParentId AND state = 'ACTIVE';

-- 이동할 폴더 락 획득
SELECT * FROM folders WHERE id = :folderId FOR UPDATE;

-- 순환 이동 방지 체크
SELECT * FROM folders 
WHERE id = :targetParentId 
  AND path LIKE (SELECT path FROM folders WHERE id = :folderId) || '/%';

-- NAS 상태 체크
SELECT * FROM folder_storage_objects 
WHERE folderId = :folderId AND storageType = 'NAS' FOR UPDATE;

-- 동일 이름 폴더 확인
SELECT * FROM folders 
WHERE parentId = :targetParentId 
  AND name = :folderName 
  AND state = 'ACTIVE';

-- 폴더 이동
UPDATE folders 
SET parentId = :targetParentId, name = :finalName, path = :newPath, updatedAt = NOW()
WHERE id = :folderId;

-- 하위 폴더 path 일괄 업데이트
UPDATE folders SET path = REPLACE(path, :oldPath, :newPath), updatedAt = NOW()
WHERE path LIKE :oldPath || '/%';

-- NAS 경로 업데이트
UPDATE folder_storage_objects 
SET objectKey = :newNasPath, availabilityStatus = 'SYNCING', updatedAt = NOW()
WHERE folderId = :folderId AND storageType = 'NAS';
```

### 에러 처리

| 상황 | HTTP Status | 에러 코드 |
|------|-------------|----------|
| 이동할 폴더 없음 | 404 | FOLDER_NOT_FOUND |
| 대상 폴더 없음 | 404 | TARGET_FOLDER_NOT_FOUND |
| 순환 이동 | 409 | CIRCULAR_MOVE |
| NAS 동기화 중 | 409 | FOLDER_SYNCING |
| 동일 이름 폴더 존재 | 409 | DUPLICATE_FOLDER_EXISTS |

---

# 4. 폴더 삭제

## 4-1. DELETE /folders/{folderId} - 폴더 삭제 (휴지통)

### Response

```typescript
interface DeleteFolderResponse {
  id: string;
  name: string;
  state: 'TRASHED';
  deletedChildCount: number;        // 함께 삭제된 하위 항목 수
  trashedAt: string;
}
```

### 처리 플로우

```
┌─────────────────────────────────────────────────────────────────────────┐
│  [DELETE /folders/{folderId} 처리 플로우]                                 │
│                                                                         │
│  1. === BEGIN TRANSACTION ===                                           │
│                                                                         │
│  2. ★폴더 락 획득★                                                      │
│     SELECT * FROM folders WHERE id = :folderId AND state='ACTIVE'       │
│     FOR UPDATE;                                                         │
│     └─ 없거나 이미 삭제됨 → 404 반환                                    │
│                                                                         │
│  3. NAS 동기화 상태 체크                                                 │
│     SELECT * FROM folder_storage_objects                                │
│     WHERE folderId = :folderId AND storageType = 'NAS' FOR UPDATE;      │
│     └─ SYNCING이면 409 (FOLDER_SYNCING)                                 │
│                                                                         │
│  4. ★하위 파일들 락 획득★                                               │
│     SELECT * FROM files WHERE folderId = :folderId FOR UPDATE;          │
│                                                                         │
│  5. 하위 파일들의 NAS 동기화 상태 체크                                   │
│     SELECT f.id, f.name FROM files f                                    │
│     JOIN file_storage_objects fso ON f.id = fso.fileId                  │
│     WHERE f.folderId = :folderId                                        │
│       AND fso.storageType = 'NAS'                                       │
│       AND fso.availabilityStatus = 'SYNCING';                           │
│     └─ 동기화 중인 파일 있으면 409 (CHILD_FILES_SYNCING)                │
│                                                                         │
│  6. 하위 폴더 재귀 조회                                                  │
│     WITH RECURSIVE subfolders AS (...)                                  │
│     SELECT id FROM subfolders;                                          │
│                                                                         │
│  7. 폴더 휴지통 이동                                                     │
│     UPDATE folders SET state = 'TRASHED' WHERE id = :folderId;          │
│                                                                         │
│  8. trash_metadata 생성                                                 │
│     INSERT trash_metadata (folderId, originalPath, deletedBy, ...)      │
│                                                                         │
│  9. NAS 동기화 상태 업데이트                                             │
│     UPDATE folder_storage_objects SET availabilityStatus = 'MOVING';    │
│                                                                         │
│  10. 하위 폴더 일괄 휴지통 이동                                          │
│      UPDATE folders SET state = 'TRASHED'                               │
│      WHERE id IN (SELECT id FROM subfolders);                           │
│                                                                         │
│  11. 하위 파일 일괄 휴지통 이동                                          │
│      UPDATE files SET state = 'TRASHED'                                 │
│      WHERE folderId IN (:folderId, ...subfolderIds);                    │
│                                                                         │
│  12. 하위 항목 NAS 상태 업데이트                                         │
│      UPDATE file_storage_objects SET availabilityStatus = 'MOVING'      │
│      WHERE fileId IN (...) AND storageType = 'NAS';                     │
│                                                                         │
│  13. 이벤트 기록                                                         │
│      INSERT folder_events (TRASH, { path, childCount })                 │
│                                                                         │
│  14. === COMMIT ===                                                     │
│                                                                         │
│  15. Bull 큐 등록                                                        │
│      NAS_MOVE_FOLDER_TO_TRASH 작업                                      │
│      (폴더 통째로 이동, 하위 포함)                                       │
│                                                                         │
│  16. 응답 반환                                                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### SQL

```sql
-- 폴더 락 획득
SELECT * FROM folders WHERE id = :folderId AND state = 'ACTIVE' FOR UPDATE;

-- NAS 상태 체크
SELECT * FROM folder_storage_objects 
WHERE folderId = :folderId AND storageType = 'NAS' FOR UPDATE;

-- 하위 파일 락 획득
SELECT * FROM files WHERE folderId = :folderId FOR UPDATE;

-- 하위 파일 NAS 상태 체크
SELECT f.id, f.name FROM files f
JOIN file_storage_objects fso ON f.id = fso.fileId
WHERE f.folderId = :folderId 
  AND fso.storageType = 'NAS' 
  AND fso.availabilityStatus = 'SYNCING';

-- 하위 폴더 재귀 조회
WITH RECURSIVE subfolders AS (
  SELECT id, name FROM folders WHERE parentId = :folderId AND state = 'ACTIVE'
  UNION ALL
  SELECT f.id, f.name FROM folders f
  JOIN subfolders sf ON f.parentId = sf.id
  WHERE f.state = 'ACTIVE'
)
SELECT id FROM subfolders;

-- 폴더 휴지통 이동
UPDATE folders SET state = 'TRASHED', updatedAt = NOW() WHERE id = :folderId;

-- 휴지통 메타데이터 생성
INSERT INTO trash_metadata (
  id, folderId, deletedAt, deletedBy, originalPath, originalParentId, expiresAt
) VALUES (
  :id, :folderId, NOW(), :userId, :originalPath, :parentId, NOW() + INTERVAL '30 days'
);

-- NAS 상태 업데이트
UPDATE folder_storage_objects 
SET availabilityStatus = 'MOVING', updatedAt = NOW()
WHERE folderId = :folderId AND storageType = 'NAS';

-- 하위 폴더 일괄 휴지통 이동
UPDATE folders SET state = 'TRASHED', updatedAt = NOW()
WHERE id IN (SELECT id FROM subfolders);

-- 하위 파일 일괄 휴지통 이동
UPDATE files SET state = 'TRASHED', updatedAt = NOW()
WHERE folderId IN (:folderId, ...subfolderIds);

-- 하위 파일 NAS 상태 업데이트
UPDATE file_storage_objects 
SET availabilityStatus = 'MOVING', updatedAt = NOW()
WHERE fileId IN (SELECT id FROM files WHERE folderId IN (:folderId, ...subfolderIds))
  AND storageType = 'NAS';
```

### 에러 처리

| 상황 | HTTP Status | 에러 코드 |
|------|-------------|----------|
| 폴더 없음 | 404 | FOLDER_NOT_FOUND |
| NAS 동기화 중 | 409 | FOLDER_SYNCING |
| 하위 파일 동기화 중 | 409 | CHILD_FILES_SYNCING |
| 이미 휴지통 | 400 | FOLDER_ALREADY_TRASHED |

---

## Bull Worker 처리 (공통)

```
┌─────────────────────────────────────────────────────────────────────────┐
│  [Bull Worker - 폴더 NAS 동기화 처리]                                     │
│                                                                         │
│  이벤트 타입별 처리:                                                     │
│                                                                         │
│  NAS_SYNC_MKDIR:                                                        │
│  - NAS에 폴더 생성                                                       │
│  - 성공: availabilityStatus = 'AVAILABLE'                               │
│                                                                         │
│  NAS_SYNC_RENAME_DIR:                                                   │
│  - NAS 폴더 이름 변경 (mv 명령)                                         │
│  - 하위 구조 자동 유지                                                   │
│  - 성공: availabilityStatus = 'AVAILABLE'                               │
│                                                                         │
│  NAS_SYNC_MOVE_DIR:                                                     │
│  - NAS 폴더 이동 (mv 명령)                                              │
│  - 하위 구조 자동 유지                                                   │
│  - 성공: availabilityStatus = 'AVAILABLE'                               │
│                                                                         │
│  NAS_MOVE_FOLDER_TO_TRASH:                                              │
│  - NAS 폴더를 /.trash/ 경로로 이동                                      │
│  - 하위 파일/폴더 모두 함께 이동                                         │
│  - 성공: 폴더 + 하위 항목 모두 'AVAILABLE'                               │
│                                                                         │
│  공통:                                                                   │
│  - 최대 3회 재시도 (지수 백오프)                                         │
│  - 최종 실패: availabilityStatus = 'ERROR' + Alert                      │
│                                                                         │
│  참고: [050.큐관리.md](./050.큐관리.md)                                  │
│       [061.휴지통_비동기처리.md](./061.휴지통_비동기처리.md)              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 프론트엔드 상태 표시

```typescript
// API 응답에 storageStatus 포함
{
  "folders": [
    {
      "id": "folder-uuid",
      "name": "documents",
      "storageStatus": {
        "nas": "AVAILABLE"  // ← 수정 가능
      }
    },
    {
      "id": "folder-uuid-2",
      "name": "new-folder",
      "storageStatus": {
        "nas": "SYNCING"    // ← 수정 버튼 비활성화
      }
    }
  ],
  "files": [...]
}

// 프론트엔드 처리
// nas = AVAILABLE     → 수정 버튼 활성화
// nas = SYNCING       → 수정 버튼 비활성화 + "동기화 중" 표시
// nas = ERROR         → 경고 아이콘 + "동기화 실패" 표시
```

---

## 참고 문서

- [001.정의.md](./001.정의.md) - 공통 사항 (로깅, 동시성 제어)
- [005.파일.md](./005.파일.md) - 파일 관리 API
- [0011.엔티티.md](./0011.엔티티.md) - 엔티티 정의
- [050.큐관리.md](./050.큐관리.md) - Bull 큐 관리
- [060.휴지통.md](./060.휴지통.md) - 휴지통 상세 플로우
- [061.휴지통_비동기처리.md](./061.휴지통_비동기처리.md) - 휴지통 비동기 처리

