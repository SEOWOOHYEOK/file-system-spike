# 999. 엔티티 정의

파일 서버 시스템의 모든 엔티티(테이블) 및 상태 Enum 정의

---

## 목차

1. [files - 파일](#1-files---파일)
2. [folders - 폴더](#2-folders---폴더)
3. [file_storage_objects - 파일 저장소 객체](#3-file_storage_objects---파일-저장소-객체)
4. [folder_storage_objects - 폴더 저장소 객체](#4-folder_storage_objects---폴더-저장소-객체)
5. [upload_sessions - 업로드 세션](#5-upload_sessions---업로드-세션)
6. [upload_parts - 업로드 파트](#6-upload_parts---업로드-파트)
7. [sync_events - 동기화 이벤트](#7-sync_events---동기화-이벤트)
8. [file_events - 파일 이벤트](#8-file_events---파일-이벤트)
9. [folder_events - 폴더 이벤트](#9-folder_events---폴더-이벤트)
10. [trash_metadata - 휴지통 메타데이터](#10-trash_metadata---휴지통-메타데이터)
11. [file_sync_queue - 파일 동기화 큐](#11-file_sync_queue---파일-동기화-큐)
12. [Enum 정의 종합](#12-enum-정의-종합)
13. [ERD 관계도](#13-erd-관계도)

---

## 1. files - 파일

### 설명
시스템에서 관리하는 모든 파일의 메타데이터를 저장하는 핵심 테이블

### 필드 정의

| 필드명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| `id` | UUID | NOT NULL | gen_random_uuid() | 파일 고유 식별자 (PK). 업로드 시 미리 생성하여 objectKey로도 사용 |
| `folderId` | UUID | NOT NULL | - | 파일이 속한 폴더 ID (FK → folders.id) |
| `name` | VARCHAR(255) | NOT NULL | - | 파일 이름 (확장자 포함). 같은 폴더 내 동일 name+mimeType+등록시간으로 파일 구분 |
| `sizeBytes` | BIGINT | NOT NULL | - | 파일 크기 (바이트 단위) |
| `mimeType` | VARCHAR(100) | NOT NULL | - | 파일 MIME 타입 (예: 'image/png', 'application/pdf') |
| `state` | VARCHAR(20) | NOT NULL | 'ACTIVE' | 파일 상태 (FileState Enum) |
| `createdAt` | TIMESTAMP | NOT NULL | NOW() | 파일 생성(업로드) 시각. 파일 유니크 판단에 사용됨 |
| `updatedAt` | TIMESTAMP | NOT NULL | NOW() | 마지막 수정 시각 |

### 인덱스

```sql
-- Primary Key
PRIMARY KEY (id)

-- 폴더 내 파일 조회용
CREATE INDEX idx_files_folder_state ON files(folderId, state);

-- 파일명 검색용
CREATE INDEX idx_files_name ON files(name);

-- 상태별 조회용
CREATE INDEX idx_files_state ON files(state);
```

### FileState Enum (files.state)

| 값 | 설명 | 전환 조건 |
|----|------|----------|
| `ACTIVE` | 정상 상태. 조회/다운로드/수정 가능 | 초기 생성 시, 복구 시 |
| `TRASHED` | 휴지통 상태. 조회 가능하나 다운로드 불가 | DELETE 요청 시 ACTIVE → TRASHED |
| `DELETED` | 영구 삭제 상태. 논리 삭제 완료 | 휴지통에서 영구삭제 시 TRASHED → DELETED |

### 상태 전이 다이어그램

```
┌─────────┐    DELETE /files/{id}    ┌──────────┐    영구삭제     ┌──────────┐
│  ACTIVE │ ─────────────────────────▶│  TRASHED │ ──────────────▶│  DELETED │
└─────────┘                          └──────────┘                └──────────┘
     ▲                                    │
     │           복구 (RESTORE)           │
     └────────────────────────────────────┘
```

---

## 2. folders - 폴더

### 설명
폴더 구조 및 계층 정보를 저장하는 테이블. 재귀적 부모-자식 관계로 트리 구조 표현

### 필드 정의

| 필드명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| `id` | UUID | NOT NULL | gen_random_uuid() | 폴더 고유 식별자 (PK) |
| `name` | VARCHAR(255) | NOT NULL | - | 폴더 이름. 같은 부모 폴더 내 유니크 |
| `parentId` | UUID | NULL | NULL | 상위 폴더 ID (FK → folders.id). NULL이면 루트 폴더 |
| `path` | VARCHAR(1000) | NOT NULL | - | 전체 경로 (예: '/project/docs/api'). 브레드크럼 및 검색에 사용 |
| `state` | VARCHAR(20) | NOT NULL | 'ACTIVE' | 폴더 상태 (FolderState Enum) |
| `createdAt` | TIMESTAMP | NOT NULL | NOW() | 폴더 생성 시각 |
| `updatedAt` | TIMESTAMP | NOT NULL | NOW() | 마지막 수정 시각 |

### 인덱스

```sql
-- Primary Key
PRIMARY KEY (id)

-- 부모 폴더 내 하위 조회용
CREATE INDEX idx_folders_parent_state ON folders(parentId, state);

-- 경로 검색용 (LIKE 쿼리)
CREATE INDEX idx_folders_path ON folders(path);

-- 경로명 기준 폴더 조회 (복구 시 사용)
CREATE INDEX idx_folders_path_state ON folders(path, state);
```

### FolderState Enum (folders.state)

| 값 | 설명 | 전환 조건 |
|----|------|----------|
| `ACTIVE` | 정상 상태. 파일 업로드 및 하위 폴더 생성 가능 | 초기 생성 시, 복구 시 |
| `TRASHED` | 휴지통 상태. 폴더 삭제 시 하위 모든 항목도 함께 TRASHED (현재 빈 폴더만 삭제 가능) | DELETE 요청 시 |
| `DELETED` | 영구 삭제 상태 | 휴지통에서 영구삭제 시 |

### 폴더 삭제 정책

```
※ 현재 정책: 빈 폴더만 삭제 가능

폴더 삭제 요청 시:
├── 하위 파일 존재 → 409 FOLDER_NOT_EMPTY
├── 하위 폴더 존재 → 409 FOLDER_NOT_EMPTY
└── 비어있음 → 삭제 진행 (NAS에서 폴더 이동)
```

---

## 3. file_storage_objects - 파일 저장소 객체

### 설명
파일의 물리적 저장 위치 및 상태를 관리하는 테이블. 하나의 파일은 여러 저장소(캐시, NAS)에 저장될 수 있음

### 필드 정의

| 필드명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| `id` | UUID | NOT NULL | gen_random_uuid() | 저장소 객체 고유 식별자 (PK) |
| `fileId` | UUID | NOT NULL | - | 파일 ID (FK → files.id) |
| `storageType` | VARCHAR(20) | NOT NULL | - | 저장소 타입 (StorageType Enum) |
| `objectKey` | VARCHAR(500) | NOT NULL | - | 저장소 내 객체 키/경로. CACHE: fileId, NAS: 실제 파일 경로 또는 휴지통 경로 |
| `availabilityStatus` | VARCHAR(20) | NOT NULL | 'PENDING' | 가용성 상태 (AvailabilityStatus Enum) |
| `activeSyncEventId` | UUID | NULL | NULL | 현재 진행 중인 동기화 이벤트 ID (FK → sync_events.id). 값이 있으면 BUSY 상태 |
| `lastAccessed` | TIMESTAMP | NULL | NULL | 마지막 접근 시각 (캐시 eviction 정책에 사용) |
| `accessCount` | INTEGER | NOT NULL | 0 | 총 접근 횟수 (핫 파일 판별용) |
| `leaseCount` | INTEGER | NOT NULL | 0 | 현재 다운로드 중인 세션 수. 0보다 크면 삭제/이동 불가 |
| `createdAt` | TIMESTAMP | NOT NULL | NOW() | 레코드 생성 시각 |
| `updatedAt` | TIMESTAMP | NULL | NULL | 마지막 수정 시각 |

### 인덱스

```sql
-- Primary Key
PRIMARY KEY (id)

-- 파일별 저장소 조회 (UNIQUE)
CREATE UNIQUE INDEX idx_fso_file_storage ON file_storage_objects(fileId, storageType);

-- 가용성 상태별 조회
CREATE INDEX idx_fso_availability ON file_storage_objects(availabilityStatus);

-- 캐시 eviction 후보 조회 (LRU)
CREATE INDEX idx_fso_cache_lru ON file_storage_objects(lastAccessed) 
WHERE storageType = 'CACHE_SEAWEED';

-- 동기화 진행 중 조회
CREATE INDEX idx_fso_sync ON file_storage_objects(activeSyncEventId) 
WHERE activeSyncEventId IS NOT NULL;
```

### StorageType Enum (file_storage_objects.storageType)

| 값 | 설명 | objectKey 형식 |
|----|------|---------------|
| `CACHE_SEAWEED` | SeaweedFS 캐시 저장소. 빠른 접근용 | `{fileId}` (UUID) |
| `NAS` | NAS 영구 저장소. 원본 보관용 | 정상: `/{folderPath}/{timestamp}__{fileName}` 휴지통: `/.trash/{trashMetadataId}/{originalPath}` |

### AvailabilityStatus Enum (file_storage_objects.availabilityStatus)

| 값 | 설명 | 발생 상황 | 허용 작업 |
|----|------|----------|----------|
| `AVAILABLE` | 정상. 파일 접근 가능 | 업로드 완료, 동기화 완료, 복구 완료 | 다운로드, 수정, 삭제 |
| `SYNCING` | NAS 동기화 중 | 업로드 직후, 수정 직후 | 다운로드만 (캐시에서) |
| `PENDING` | 작업 대기 중 | 삭제 대기 (캐시), 배치 처리 대기 | 없음 |
| `MOVING` | 이동 중 | 휴지통 이동, 복구 중 | 없음 |
| `BUSY` | 다른 작업 진행 중 | activeSyncEventId != NULL | 없음 (409 반환) |
| `ERROR` | 동기화/작업 실패 | 최대 재시도 초과 후 | 관리자 개입 필요 |
| `MISSING` | 캐시에서 eviction됨 | 캐시 정리 후 | NAS에서 복원 후 다운로드 |
| `EVICTING` | 캐시 정리 중 | 캐시 용량 부족 시 | 없음 |

### leaseCount 사용법

```
다운로드 시작:
  UPDATE SET leaseCount = leaseCount + 1

다운로드 완료/실패/중단 (finally):
  UPDATE SET leaseCount = GREATEST(leaseCount - 1, 0)

삭제/이동 전 체크:
  IF leaseCount > 0 THEN
    RETURN 409 FILE_IN_USE ("파일을 사용 중인 사용자가 있어 처리할 수 없습니다")
  END IF
```

---

## 4. folder_storage_objects - 폴더 저장소 객체

### 설명
폴더의 NAS 저장 상태를 관리하는 테이블

### 필드 정의

| 필드명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| `id` | UUID | NOT NULL | gen_random_uuid() | 저장소 객체 고유 식별자 (PK) |
| `folderId` | UUID | NOT NULL | - | 폴더 ID (FK → folders.id) |
| `storageType` | VARCHAR(20) | NOT NULL | 'NAS' | 저장소 타입. 현재 NAS만 사용 |
| `objectKey` | VARCHAR(500) | NOT NULL | - | NAS 내 폴더 경로 |
| `availabilityStatus` | VARCHAR(20) | NOT NULL | 'PENDING' | 가용성 상태 (FolderAvailabilityStatus Enum) |
| `activeSyncEventId` | UUID | NULL | NULL | 현재 진행 중인 동기화 이벤트 ID |
| `createdAt` | TIMESTAMP | NOT NULL | NOW() | 레코드 생성 시각 |
| `updatedAt` | TIMESTAMP | NULL | NULL | 마지막 수정 시각 |

### 인덱스

```sql
-- Primary Key
PRIMARY KEY (id)

-- 폴더별 저장소 조회 (UNIQUE)
CREATE UNIQUE INDEX idx_fso_folder_storage ON folder_storage_objects(folderId, storageType);

-- 동기화 진행 중 조회
CREATE INDEX idx_folder_so_sync ON folder_storage_objects(activeSyncEventId) 
WHERE activeSyncEventId IS NOT NULL;
```

### FolderAvailabilityStatus Enum (folder_storage_objects.availabilityStatus)

| 값 | 설명 | 발생 상황 |
|----|------|----------|
| `AVAILABLE` | 정상. 폴더 작업 가능 | 생성 완료, 동기화 완료 |
| `SYNCING` | NAS 동기화 중 | 생성 직후 (폴더 생성 시) |
| `PENDING` | 작업 대기 중 | 초기 생성 시 |
| `MOVING` | 이동 중 | 폴더 이동, 휴지통 이동 중 |
| `BUSY` | 다른 작업 진행 중 | activeSyncEventId != NULL |
| `ERROR` | 동기화/작업 실패 | 최대 재시도 초과 |

---

## 5. upload_sessions - 업로드 세션

### 설명
멀티파트 업로드 세션 정보를 저장하는 테이블. 100MB 이상 파일의 분할 업로드 관리

### 필드 정의

| 필드명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| `id` | UUID | NOT NULL | gen_random_uuid() | 세션 고유 식별자 (PK, sessionId) |
| `traceId` | VARCHAR(100) | NULL | NULL | 요청 추적 ID (로깅/디버깅용) |
| `uploaderId` | VARCHAR(100) | NOT NULL | - | 업로더 사용자 ID |
| `targetFolderId` | UUID | NOT NULL | - | 대상 폴더 ID (FK → folders.id) |
| `fileName` | VARCHAR(255) | NOT NULL | - | 업로드할 파일 이름 |
| `mimeType` | VARCHAR(100) | NOT NULL | - | 파일 MIME 타입 |
| `totalBytes` | BIGINT | NOT NULL | - | 전체 파일 크기 (바이트) |
| `strategy` | VARCHAR(20) | NOT NULL | 'MULTIPART' | 업로드 전략 |
| `status` | VARCHAR(20) | NOT NULL | 'INIT' | 세션 상태 (UploadSessionStatus Enum) |
| `uploadId` | VARCHAR(200) | NOT NULL | - | SeaweedFS 멀티파트 업로드 ID |
| `expiresAt` | TIMESTAMP | NOT NULL | NOW() + 24h | 세션 만료 시각 |
| `completedAt` | TIMESTAMP | NULL | NULL | 업로드 완료 시각 |
| `createdAt` | TIMESTAMP | NOT NULL | NOW() | 세션 생성 시각 |
| `updatedAt` | TIMESTAMP | NULL | NULL | 마지막 수정 시각 |

### 인덱스

```sql
-- Primary Key
PRIMARY KEY (id)

-- 상태별 조회
CREATE INDEX idx_upload_session_status ON upload_sessions(status);

-- 만료 세션 정리용
CREATE INDEX idx_upload_session_expires ON upload_sessions(expiresAt) 
WHERE status IN ('INIT', 'UPLOADING');
```

### UploadSessionStatus Enum (upload_sessions.status)

| 값 | 설명 | 전환 조건 |
|----|------|----------|
| `INIT` | 초기화됨. 파트 업로드 대기 | POST /multipart/initiate 호출 시 |
| `UPLOADING` | 파트 업로드 진행 중 | 첫 번째 파트 업로드 완료 시 INIT → UPLOADING |
| `COMPLETED` | 업로드 완료. 파일 생성됨 | POST /multipart/complete 성공 시 |
| `ABORTED` | 사용자에 의해 취소됨 | DELETE /multipart/{sessionId} 호출 시 |
| `EXPIRED` | 만료됨. 배치에 의해 정리 | expiresAt < NOW() && status IN (INIT, UPLOADING) |

### 상태 전이 다이어그램

```
                              첫 파트 업로드
┌──────┐                       완료           ┌─────────────┐
│ INIT │ ────────────────────────────────────▶│  UPLOADING  │
└──────┘                                      └─────────────┘
   │                                                │
   │  사용자 취소                        모든 파트 │  사용자 취소
   │  (DELETE)                          완료 후    │  (DELETE)
   ▼                                    complete   ▼
┌─────────┐                               │    ┌─────────┐
│ ABORTED │◀──────────────────────────────┼────│ ABORTED │
└─────────┘                               │    └─────────┘
   ▲                                      │
   │  만료 (배치)                         ▼
┌─────────┐                          ┌───────────┐
│ EXPIRED │◀─ 만료 (배치)            │ COMPLETED │
└─────────┘                          └───────────┘
```

---

## 6. upload_parts - 업로드 파트

### 설명
멀티파트 업로드의 개별 파트 정보를 저장하는 테이블

### 필드 정의

| 필드명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| `id` | UUID | NOT NULL | gen_random_uuid() | 파트 고유 식별자 (PK) |
| `sessionId` | UUID | NOT NULL | - | 세션 ID (FK → upload_sessions.id) |
| `partNumber` | INTEGER | NOT NULL | - | 파트 번호 (1부터 시작) |
| `bytes` | BIGINT | NOT NULL | - | 파트 크기 (바이트) |
| `etag` | VARCHAR(100) | NOT NULL | - | 파트 ETag (무결성 검증용) |
| `status` | VARCHAR(20) | NOT NULL | 'COMPLETED' | 파트 상태 (UploadPartStatus Enum) |
| `createdAt` | TIMESTAMP | NOT NULL | NOW() | 파트 업로드 시각 |
| `updatedAt` | TIMESTAMP | NULL | NULL | 재업로드 시 수정 시각 |

### 인덱스

```sql
-- Primary Key
PRIMARY KEY (id)

-- 세션별 파트 조회 (UNIQUE)
CREATE UNIQUE INDEX idx_upload_parts_session_part ON upload_parts(sessionId, partNumber);

-- 완료된 파트 수 계산용
CREATE INDEX idx_upload_parts_status ON upload_parts(sessionId, status);
```

### UploadPartStatus Enum (upload_parts.status)

| 값 | 설명 |
|----|------|
| `COMPLETED` | 파트 업로드 완료 |

---

## 7. sync_events - 동기화 이벤트

### 설명
NAS 동기화 작업의 이벤트 및 상태를 관리하는 테이블. Bull Queue와 연동하여 비동기 처리 추적

### 필드 정의

| 필드명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| `id` | UUID | NOT NULL | gen_random_uuid() | 이벤트 고유 식별자 (PK, syncEventId) |
| `fileId` | UUID | NULL | NULL | 파일 ID (FK → files.id). 파일 작업인 경우 |
| `folderId` | UUID | NULL | NULL | 폴더 ID (FK → folders.id). 폴더 작업인 경우 |
| `eventType` | VARCHAR(30) | NOT NULL | - | 이벤트 타입 (SyncEventType Enum) |
| `status` | VARCHAR(20) | NOT NULL | 'PENDING' | 이벤트 상태 (SyncEventStatus Enum) |
| `sourcePath` | VARCHAR(500) | NULL | NULL | 원본 경로 (이동/이름변경 시) |
| `targetPath` | VARCHAR(500) | NULL | NULL | 대상 경로 (이동/이름변경 시) |
| `metadata` | JSONB | NULL | NULL | 추가 메타데이터 (작업별 상세 정보) |
| `retryCount` | INTEGER | NOT NULL | 0 | 재시도 횟수 |
| `maxRetries` | INTEGER | NOT NULL | 3 | 최대 재시도 횟수 |
| `errorMessage` | TEXT | NULL | NULL | 실패 시 에러 메시지 |
| `createdAt` | TIMESTAMP | NOT NULL | NOW() | 이벤트 생성 시각 |
| `processedAt` | TIMESTAMP | NULL | NULL | 처리 완료 시각 |
| `scheduledAt` | TIMESTAMP | NULL | NULL | 예약 실행 시각 (재시도 대기 시) |

### 인덱스

```sql
-- Primary Key
PRIMARY KEY (id)

-- 파일별 이벤트 조회
CREATE INDEX idx_sync_events_file ON sync_events(fileId);

-- 폴더별 이벤트 조회
CREATE INDEX idx_sync_events_folder ON sync_events(folderId);

-- 상태별 조회 (대기 중 작업)
CREATE INDEX idx_sync_events_status ON sync_events(status) WHERE status = 'PENDING';

-- 스케줄된 작업 조회
CREATE INDEX idx_sync_events_scheduled ON sync_events(scheduledAt) 
WHERE scheduledAt IS NOT NULL AND status = 'PENDING';
```

### SyncEventType Enum (sync_events.eventType)

| 값 | 설명 | 대상 | metadata 예시 |
|----|------|------|--------------|
| `SYNC` | 파일 업로드 후 NAS 동기화 | 파일 | `{}` |
| `RENAME` | 파일 이름 변경 | 파일 | `{ "oldName": "a.txt", "newName": "b.txt" }` |
| `MOVE` | 파일 이동 | 파일 | `{ "originalFolderId": "uuid", "targetFolderId": "uuid" }` |
| `TRASH` | 파일 휴지통 이동 | 파일 | `{ "originalPath": "/path", "trashMetadataId": "uuid" }` |
| `RESTORE` | 파일 복구 | 파일 | `{ "trashPath": "/.trash/...", "restorePath": "/path" }` |
| `PURGE` | 파일 영구 삭제 | 파일 | `{ "trashPath": "/.trash/..." }` |
| `MKDIR` | 폴더 생성 | 폴더 | `{ "name": "folder_name" }` |
| `RENAME_DIR` | 폴더 이름 변경 | 폴더 | `{ "oldName": "a", "newName": "b", "oldPath": "/old" }` |
| `MOVE_DIR` | 폴더 이동 | 폴더 | `{ "originalParentId": "uuid", "targetParentId": "uuid", "originalPath": "/path" }` |
| `MOVE_TO_TRASH` | 폴더 휴지통 이동 | 폴더 | `{ "originalPath": "/path" }` |

### SyncEventStatus Enum (sync_events.status)

| 값 | 설명 | 전환 조건 |
|----|------|----------|
| `PENDING` | 대기 중. Bull Queue에 등록됨 | API에서 생성 시 |
| `PROCESSING` | 처리 중. Worker가 작업 수행 중 | Worker가 job 수신 시 |
| `DONE` | 완료. NAS 동기화 성공 | NAS 작업 성공 시 |
| `FAILED` | 실패. 최대 재시도 초과 | maxRetries 초과 시 |

### 상태 전이 다이어그램

```
┌─────────┐    Worker 수신     ┌────────────┐    NAS 성공    ┌──────┐
│ PENDING │ ─────────────────▶│ PROCESSING │ ─────────────▶│ DONE │
└─────────┘                   └────────────┘               └──────┘
     ▲                              │
     │                              │ NAS 실패
     │                              │ (retryCount < maxRetries)
     │                              ▼
     └────── 재시도 대기 (backoff) ───┤
                                    │
                                    │ NAS 실패
                                    │ (retryCount >= maxRetries)
                                    ▼
                               ┌─────────┐
                               │ FAILED  │ → 관리자 알림
                               └─────────┘
```

---

## 8. file_events - 파일 이벤트

### 설명
파일에 대한 모든 이벤트를 기록하는 이력 테이블. 감사(Audit) 및 디버깅용

### 필드 정의

| 필드명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| `id` | UUID | NOT NULL | gen_random_uuid() | 이벤트 고유 식별자 (PK) |
| `fileId` | UUID | NOT NULL | - | 파일 ID (FK → files.id) |
| `eventType` | VARCHAR(30) | NOT NULL | - | 이벤트 타입 (FileEventType Enum) |
| `traceId` | VARCHAR(100) | NULL | NULL | 요청 추적 ID |
| `payloadJson` | JSONB | NULL | NULL | 이벤트 상세 정보 (JSON) |
| `occurredAt` | TIMESTAMP | NOT NULL | NOW() | 이벤트 발생 시각 |

### 인덱스

```sql
-- Primary Key
PRIMARY KEY (id)

-- 파일별 이벤트 이력 조회
CREATE INDEX idx_file_events_file ON file_events(fileId, occurredAt DESC);

-- 이벤트 타입별 조회
CREATE INDEX idx_file_events_type ON file_events(eventType);
```

### FileEventType Enum (file_events.eventType)

| 값 | 설명 | payloadJson 예시 |
|----|------|-----------------|
| `UPLOAD` | 파일 업로드 완료 | `{ "originalName": "file.txt", "size": 1024 }` |
| `RENAME` | 파일 이름 변경 | `{ "oldName": "a.txt", "newName": "b.txt" }` |
| `MOVE` | 파일 이동 | `{ "sourceFolder": "uuid", "targetFolder": "uuid" }` |
| `TRASH` | 휴지통 이동 | `{ "originalPath": "/path/file.txt" }` |
| `RESTORE` | 휴지통에서 복구 | `{ "restorePath": "/path/file.txt" }` |
| `PURGE` | 영구 삭제 | `{ "trashPath": "/.trash/..." }` |

---

## 9. folder_events - 폴더 이벤트

### 설명
폴더에 대한 모든 이벤트를 기록하는 이력 테이블

### 필드 정의

| 필드명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| `id` | UUID | NOT NULL | gen_random_uuid() | 이벤트 고유 식별자 (PK) |
| `folderId` | UUID | NOT NULL | - | 폴더 ID (FK → folders.id) |
| `eventType` | VARCHAR(30) | NOT NULL | - | 이벤트 타입 (FolderEventType Enum) |
| `traceId` | VARCHAR(100) | NULL | NULL | 요청 추적 ID |
| `payloadJson` | JSONB | NULL | NULL | 이벤트 상세 정보 (JSON) |
| `occurredAt` | TIMESTAMP | NOT NULL | NOW() | 이벤트 발생 시각 |

### 인덱스

```sql
-- Primary Key
PRIMARY KEY (id)

-- 폴더별 이벤트 이력 조회
CREATE INDEX idx_folder_events_folder ON folder_events(folderId, occurredAt DESC);
```

### FolderEventType Enum (folder_events.eventType)

| 값 | 설명 | payloadJson 예시 |
|----|------|-----------------|
| `CREATE` | 폴더 생성 | `{ "name": "docs", "path": "/project/docs" }` |
| `RENAME` | 폴더 이름 변경 | `{ "oldName": "a", "newName": "b", "oldPath": "/old", "newPath": "/new" }` |
| `MOVE` | 폴더 이동 | `{ "sourceParent": "uuid", "targetParent": "uuid" }` |
| `TRASH` | 휴지통 이동 | `{ "path": "/path", "childCount": 5 }` |
| `RESTORE` | 휴지통에서 복구 | `{ "pathRecreated": true }` |
| `PURGE` | 영구 삭제 | `{ "affectedFolderCount": 3, "affectedFileCount": 10 }` |

---

## 10. trash_metadata - 휴지통 메타데이터

### 설명
휴지통에 있는 파일의 원래 위치 및 삭제 정보를 저장하는 테이블. 파일:trash_metadata = 1:1 관계

### 필드 정의

| 필드명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| `id` | UUID | NOT NULL | gen_random_uuid() | 휴지통 메타 고유 식별자 (PK, trashMetadataId). NAS 휴지통 경로에 사용 |
| `fileId` | UUID | NOT NULL | - | 파일 ID (FK → files.id, UNIQUE). 1:1 관계 보장 |
| `originalPath` | VARCHAR(500) | NOT NULL | - | 삭제 시점의 파일 경로 (폴더 경로). 복구 시 경로 확인에 사용 |
| `originalFolderId` | UUID | NOT NULL | - | 삭제 시점의 폴더 ID. 참고용 (복구는 경로명 기준) |
| `deletedAt` | TIMESTAMP | NOT NULL | NOW() | 삭제 시각 |
| `deletedBy` | VARCHAR(100) | NOT NULL | - | 삭제한 사용자 ID |
| `expiresAt` | TIMESTAMP | NOT NULL | NOW() + 30일 | 자동 영구삭제 예정 시각 |

### 인덱스

```sql
-- Primary Key
PRIMARY KEY (id)

-- 파일 ID (UNIQUE - 1:1 관계 보장)
CREATE UNIQUE INDEX idx_trash_file ON trash_metadata(fileId);

-- 만료 시각 (자동 삭제 배치용)
CREATE INDEX idx_trash_expires ON trash_metadata(expiresAt);

-- 삭제자별 조회
CREATE INDEX idx_trash_deleted_by ON trash_metadata(deletedBy);

-- 원래 폴더별 조회
CREATE INDEX idx_trash_original_folder ON trash_metadata(originalFolderId);
```

### NAS 휴지통 경로 규칙

```
원본 경로: /documents/project/report.pdf
휴지통 경로: /.trash/{trashMetadataId}/documents/project/report.pdf

※ trashMetadataId를 경로에 포함하여 동일 경로/파일명의 여러 삭제 파일 구분
```

### 관계도

```
┌─────────────┐         ┌──────────────────┐
│   files     │   1:1   │  trash_metadata  │
│─────────────│◄────────│──────────────────│
│ id (PK)     │         │ id (PK)          │
│ name        │         │ fileId (FK, UQ)  │  ← UNIQUE 제약
│ state       │         │ originalPath     │
│ folderId    │         │ originalFolderId │
│ ...         │         │ deletedAt        │
└─────────────┘         │ deletedBy        │
                        │ expiresAt        │
                        └──────────────────┘

※ fileId에 UNIQUE 제약 → 파일당 trash_metadata 1개만 존재
※ 파일 영구삭제 시 trash_metadata도 함께 삭제
```

---

## 11. file_sync_queue - 파일 동기화 큐

### 설명
파일 단위 큐 방식의 NAS 동기화 관리 테이블. 파일별 작업 순서 보장 및 동시성 제어

### 필드 정의

| 필드명 | 타입 | NULL | 기본값 | 설명 |
|--------|------|------|--------|------|
| `id` | UUID | NOT NULL | gen_random_uuid() | 큐 항목 고유 식별자 (PK) |
| `fileId` | UUID | NOT NULL | - | 파일 ID (FK → files.id) |
| `folderId` | UUID | NULL | NULL | 폴더 ID (폴더 작업용) |
| `operationType` | VARCHAR(20) | NOT NULL | - | 작업 타입 (SyncOperationType Enum) |
| `seq` | INTEGER | NOT NULL | - | 파일별 작업 순서 번호 (파일 내에서 유니크) |
| `metadata` | JSONB | NULL | NULL | 작업별 메타데이터 (경로 정보 등) |
| `status` | VARCHAR(20) | NOT NULL | 'PENDING' | 작업 상태 (QueueStatus Enum) |
| `retryCount` | INTEGER | NOT NULL | 0 | 재시도 횟수 |
| `maxRetries` | INTEGER | NOT NULL | 5 | 최대 재시도 횟수 |
| `errorMessage` | TEXT | NULL | NULL | 실패 시 에러 메시지 |
| `createdAt` | TIMESTAMP | NOT NULL | NOW() | 큐 등록 시각 |
| `startedAt` | TIMESTAMP | NULL | NULL | 작업 시작 시각 |
| `completedAt` | TIMESTAMP | NULL | NULL | 작업 완료 시각 |

### 인덱스

```sql
-- Primary Key
PRIMARY KEY (id)

-- 파일별 작업 순서 (UNIQUE)
CREATE UNIQUE INDEX idx_sync_queue_file_seq ON file_sync_queue(fileId, seq);

-- 파일별 상태 조회
CREATE INDEX idx_sync_queue_file_status ON file_sync_queue(fileId, status);

-- 대기 중 작업 조회 (Worker 폴링)
CREATE INDEX idx_sync_queue_pending ON file_sync_queue(status) WHERE status = 'PENDING';
```

### SyncOperationType Enum (file_sync_queue.operationType)

| 값 | 설명 | metadata 예시 |
|----|------|--------------|
| `UPLOAD` | 파일 업로드 후 NAS 동기화 | `{ "sourcePath": "seaweedfs://fileId" }` |
| `RENAME` | 파일 이름 변경 | `{ "oldPath": "/path/old.txt", "newPath": "/path/new.txt" }` |
| `MOVE` | 파일 이동 | `{ "sourcePath": "/old/file.txt", "targetPath": "/new/file.txt" }` |
| `TRASH` | 휴지통 이동 | `{ "sourcePath": "/path/file.txt", "trashPath": "/.trash/..." }` |
| `DELETE` | 영구 삭제 | `{ "trashPath": "/.trash/..." }` |
| `RESTORE` | 휴지통에서 복구 | `{ "trashPath": "/.trash/...", "restorePath": "/path/file.txt" }` |

### QueueStatus Enum (file_sync_queue.status)

| 값 | 설명 | 전환 조건 |
|----|------|----------|
| `PENDING` | 대기 중 | API에서 생성 시 |
| `PROCESSING` | 처리 중 | Worker가 작업 시작 시 |
| `DONE` | 완료 | NAS 작업 성공 시 |
| `FAILED` | 실패 | 최대 재시도 초과 시 |
| `CANCELLED` | 취소됨 | 선행 작업 실패로 취소 시 |

### 파일 단위 큐 처리 흐름

```
기존 방식 (작업 레벨):
  sync_events: [MOVE(a,1→2), DELETE(a,2), MOVE(b,1→3)]
  → 순서 보장 어려움, 락 경합 발생 가능

파일 단위 큐 방식:
  queue(fileId=a): MOVE(1→2, seq=1) → DELETE(seq=2)
  queue(fileId=b): MOVE(1→3, seq=1)
  → 파일별 순차 처리, 파일 간 병렬 처리
```

---

## 12. Enum 정의 종합

### 상태 관련 Enum

| Enum 이름 | 사용 테이블.필드 | 값 목록 |
|-----------|-----------------|--------|
| FileState | files.state | ACTIVE, TRASHED, DELETED |
| FolderState | folders.state | ACTIVE, TRASHED, DELETED |
| UploadSessionStatus | upload_sessions.status | INIT, UPLOADING, COMPLETED, ABORTED, EXPIRED |
| UploadPartStatus | upload_parts.status | COMPLETED |
| AvailabilityStatus | file_storage_objects.availabilityStatus | AVAILABLE, SYNCING, PENDING, MOVING, BUSY, ERROR, MISSING, EVICTING |
| FolderAvailabilityStatus | folder_storage_objects.availabilityStatus | AVAILABLE, SYNCING, PENDING, MOVING, BUSY, ERROR |
| SyncEventStatus | sync_events.status | PENDING, PROCESSING, DONE, FAILED |
| QueueStatus | file_sync_queue.status | PENDING, PROCESSING, DONE, FAILED, CANCELLED |

### 타입 관련 Enum

| Enum 이름 | 사용 테이블.필드 | 값 목록 |
|-----------|-----------------|--------|
| StorageType | file_storage_objects.storageType | CACHE_SEAWEED, NAS |
| SyncEventType | sync_events.eventType | SYNC, RENAME, MOVE, TRASH, RESTORE, PURGE, MKDIR, RENAME_DIR, MOVE_DIR, MOVE_TO_TRASH |
| FileEventType | file_events.eventType | UPLOAD, RENAME, MOVE, TRASH, RESTORE, PURGE |
| FolderEventType | folder_events.eventType | CREATE, RENAME, MOVE, TRASH, RESTORE, PURGE |
| SyncOperationType | file_sync_queue.operationType | UPLOAD, RENAME, MOVE, TRASH, DELETE, RESTORE |

---

## 13. ERD 관계도

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              FILE SERVER ERD                                     │
└─────────────────────────────────────────────────────────────────────────────────┘

                    ┌───────────────────┐
                    │     folders       │
                    │───────────────────│
                    │ id (PK)           │◄──────────────────┐
                    │ name              │                   │
                    │ parentId (FK) ────┼───────────────────┘ (자기 참조)
                    │ path              │
                    │ state             │
                    └─────────┬─────────┘
                              │
                              │ 1:N
                              ▼
                    ┌───────────────────┐         ┌───────────────────────────┐
                    │      files        │         │   file_storage_objects    │
                    │───────────────────│    1:N  │───────────────────────────│
                    │ id (PK)           │◄───────▶│ id (PK)                   │
                    │ folderId (FK)     │         │ fileId (FK)               │
                    │ name              │         │ storageType               │
                    │ sizeBytes         │         │ objectKey                 │
                    │ mimeType          │         │ availabilityStatus        │
                    │ state             │         │ activeSyncEventId (FK)    │
                    │ createdAt         │         │ leaseCount                │
                    └─────────┬─────────┘         └───────────────────────────┘
                              │
           ┌──────────────────┼──────────────────┬──────────────────┐
           │                  │                  │                  │
           │ 1:1              │ 1:N              │ 1:N              │ 1:N
           ▼                  ▼                  ▼                  ▼
┌───────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  trash_metadata   │  │   file_events   │  │   sync_events   │  │ file_sync_queue │
│───────────────────│  │─────────────────│  │─────────────────│  │─────────────────│
│ id (PK)           │  │ id (PK)         │  │ id (PK)         │  │ id (PK)         │
│ fileId (FK, UQ)   │  │ fileId (FK)     │  │ fileId (FK)     │  │ fileId (FK)     │
│ originalPath      │  │ eventType       │  │ folderId (FK)   │  │ operationType   │
│ originalFolderId  │  │ payloadJson     │  │ eventType       │  │ seq             │
│ deletedAt         │  │ occurredAt      │  │ status          │  │ status          │
│ deletedBy         │  └─────────────────┘  │ metadata        │  │ metadata        │
│ expiresAt         │                       │ retryCount      │  └─────────────────┘
└───────────────────┘                       └─────────────────┘


┌───────────────────┐         ┌───────────────────────────┐
│     folders       │    1:N  │  folder_storage_objects   │
│───────────────────│◄───────▶│───────────────────────────│
│ id (PK)           │         │ id (PK)                   │
│ ...               │         │ folderId (FK)             │
└─────────┬─────────┘         │ storageType               │
          │                   │ availabilityStatus        │
          │ 1:N               │ activeSyncEventId (FK)    │
          ▼                   └───────────────────────────┘
┌─────────────────┐
│  folder_events  │
│─────────────────│
│ id (PK)         │
│ folderId (FK)   │
│ eventType       │
│ payloadJson     │
│ occurredAt      │
└─────────────────┘


┌───────────────────┐         ┌─────────────────┐
│  upload_sessions  │    1:N  │  upload_parts   │
│───────────────────│◄───────▶│─────────────────│
│ id (PK)           │         │ id (PK)         │
│ targetFolderId    │         │ sessionId (FK)  │
│ fileName          │         │ partNumber      │
│ status            │         │ bytes           │
│ uploadId          │         │ etag            │
│ expiresAt         │         │ status          │
└───────────────────┘         └─────────────────┘
```

---

## 참고 문서

- [005.파일.md](./파일/005.파일.md) - 파일 관리 API
- [005-1.파일_처리_FLOW.md](./파일/005-1.파일_처리_FLOW.md) - 파일 처리 시퀀스 다이어그램
- [005-3.파일단위_큐_NAS동기화.md](./파일/005-3.파일단위_큐_NAS동기화.md) - 파일 단위 큐 처리
- [008.폴더.md](./폴더/008.폴더.md) - 폴더 관리 API
- [008-1.폴더_처리_FLOW.md](./폴더/008-1.폴더_처리_FLOW.md) - 폴더 처리 시퀀스 다이어그램
- [060.휴지통_version0.0.1.md](./휴지통/060.휴지통_version0.0.1.md) - 휴지통 상세
- [060-1.휴지통_처리_FLOW.md](./휴지통/060-1.휴지통_처리_FLOW.md) - 휴지통 처리 시퀀스 다이어그램
