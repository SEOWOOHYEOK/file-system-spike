/**
 * ============================================================
 * ğŸ“¦ NAS Health Check ë„ë©”ì¸ ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸
 * ============================================================
 *
 * ğŸ¯ í…ŒìŠ¤íŠ¸ ëŒ€ìƒ:
 *   - NasHealthCheckDomainService
 *
 * ğŸ“‹ ë¹„ì¦ˆë‹ˆìŠ¤ ë§¥ë½:
 *   - Windows UNC ê²½ë¡œë¥¼ í†µí•œ NAS ì—°ê²° ìƒíƒœ í™•ì¸
 *   - PowerShellì„ ì‚¬ìš©í•˜ì—¬ ë§¤í•‘ëœ ë“œë¼ì´ë¸Œì˜ ìš©ëŸ‰ ì •ë³´ ì¡°íšŒ
 *   - ì´ ìš©ëŸ‰, ì‚¬ìš© ìš©ëŸ‰, ì—¬ìœ  ìš©ëŸ‰ ì •ë³´ ì œê³µ
 *
 * âš ï¸ ì¤‘ìš” ê³ ë ¤ì‚¬í•­:
 *   - Windows í™˜ê²½ì—ì„œë§Œ ì •ìƒ ë™ì‘
 *   - UNC ê²½ë¡œê°€ ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë¸Œë¡œ ë§¤í•‘ë˜ì–´ ìˆì–´ì•¼ í•¨
 *   - PowerShell ì‹¤í–‰ ì‹¤íŒ¨ ì‹œ unhealthy ìƒíƒœ ë°˜í™˜
 * ============================================================
 */
import { Test, TestingModule } from '@nestjs/testing';
import { ConfigService } from '@nestjs/config';
import { NasHealthCheckDomainService, NasHealthResult, NasCapacity } from './nas-health-check-domain.service';

describe('NasHealthCheckDomainService', () => {
  let service: NasHealthCheckDomainService;
  let configService: jest.Mocked<ConfigService>;

  /**
   * ğŸ­ Mock ì„¤ì •
   * ğŸ“ configService.get('NAS_MOUNT_PATH'):
   *   - ì‹¤ì œ ë™ì‘: í™˜ê²½ë³€ìˆ˜ì—ì„œ NAS UNC ê²½ë¡œ ì¡°íšŒ
   *   - Mock ì´ìœ : í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ì‹¤ì œ NAS ì—°ê²° ì—†ì´ ê²½ë¡œ ì„¤ì •
   */
  beforeEach(async () => {
    configService = {
      get: jest.fn(),
    } as any;

    const module: TestingModule = await Test.createTestingModule({
      providers: [
        NasHealthCheckDomainService,
        {
          provide: ConfigService,
          useValue: configService,
        },
      ],
    }).compile();

    service = module.get<NasHealthCheckDomainService>(
      NasHealthCheckDomainService,
    );
  });

  describe('checkHealth', () => {
    /**
     * ğŸ“Œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤: ì •ìƒ íë¦„ - NAS ì—°ê²° ì„±ê³µ ë° ìš©ëŸ‰ ì •ë³´ ë°˜í™˜
     *
     * ğŸ¯ ê²€ì¦ ëª©ì :
     *   NASê°€ ì •ìƒ ì—°ê²°ë˜ë©´ healthy ìƒíƒœì™€ í•¨ê»˜ ìš©ëŸ‰ ì •ë³´ë¥¼ ë°˜í™˜í•´ì•¼ í•œë‹¤.
     *   PowerShellì„ í†µí•´ ë§¤í•‘ëœ ë“œë¼ì´ë¸Œì˜ ìš©ëŸ‰ì„ ì¡°íšŒí•œë‹¤.
     *
     * âœ… ê¸°ëŒ€ ê²°ê³¼:
     *   - status = 'healthy'
     *   - capacityì— total, used, free ì •ë³´ í¬í•¨
     *   - checkedAtì´ ìœ íš¨í•œ Date
     */
    it('should return healthy status with capacity when NAS is connected', async () => {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¥ GIVEN (ì‚¬ì „ ì¡°ê±´ ì„¤ì •)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      configService.get.mockReturnValue('\\\\192.168.10.249\\Web');

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ¬ WHEN (í…ŒìŠ¤íŠ¸ ì‹¤í–‰)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const result = await service.checkHealth();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âœ… THEN (ê²°ê³¼ ê²€ì¦)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ì‹¤ì œ NAS ì—°ê²°ì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì§
      // healthy ë˜ëŠ” unhealthy ë‘˜ ì¤‘ í•˜ë‚˜
      expect(['healthy', 'degraded', 'unhealthy']).toContain(result.status);
      expect(result.checkedAt).toBeInstanceOf(Date);
      expect(result.responseTimeMs).toBeGreaterThanOrEqual(0);
    });

    /**
     * ğŸ“Œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤: ì—ëŸ¬ ì¼€ì´ìŠ¤ - NAS ê²½ë¡œ ë¯¸ì„¤ì •
     *
     * ğŸ¯ ê²€ì¦ ëª©ì :
     *   NAS_MOUNT_PATHê°€ ì„¤ì •ë˜ì§€ ì•Šìœ¼ë©´ unhealthy ìƒíƒœë¥¼ ë°˜í™˜í•´ì•¼ í•œë‹¤.
     *   ì—ëŸ¬ ë©”ì‹œì§€ë¡œ ì›ì¸ì„ ì•Œ ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.
     *
     * âœ… ê¸°ëŒ€ ê²°ê³¼:
     *   - status = 'unhealthy'
     *   - errorì— ì›ì¸ ë©”ì‹œì§€ í¬í•¨
     */
    it('should return unhealthy status when NAS_MOUNT_PATH is not configured', async () => {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¥ GIVEN (ì‚¬ì „ ì¡°ê±´ ì„¤ì •)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      configService.get.mockReturnValue(undefined);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ¬ WHEN (í…ŒìŠ¤íŠ¸ ì‹¤í–‰)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const result = await service.checkHealth();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âœ… THEN (ê²°ê³¼ ê²€ì¦)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      expect(result.status).toBe('unhealthy');
      expect(result.error).toContain('NAS_MOUNT_PATH');
    });

    /**
     * ğŸ“Œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤: ì—ëŸ¬ ì¼€ì´ìŠ¤ - ì˜ëª»ëœ UNC ê²½ë¡œ
     *
     * ğŸ¯ ê²€ì¦ ëª©ì :
     *   ìœ íš¨í•˜ì§€ ì•Šì€ UNC ê²½ë¡œê°€ ì„¤ì •ë˜ë©´ unhealthy ìƒíƒœë¥¼ ë°˜í™˜í•´ì•¼ í•œë‹¤.
     *
     * âœ… ê¸°ëŒ€ ê²°ê³¼:
     *   - status = 'unhealthy'
     *   - errorì— ì›ì¸ ë©”ì‹œì§€ í¬í•¨
     */
    it('should return unhealthy status when UNC path is invalid', async () => {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¥ GIVEN (ì‚¬ì „ ì¡°ê±´ ì„¤ì •)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      configService.get.mockReturnValue('invalid-path');

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ¬ WHEN (í…ŒìŠ¤íŠ¸ ì‹¤í–‰)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const result = await service.checkHealth();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âœ… THEN (ê²°ê³¼ ê²€ì¦)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      expect(result.status).toBe('unhealthy');
    });
  });

  describe('NasHealthResult interface', () => {
    /**
     * ğŸ“Œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤: ì¸í„°í˜ì´ìŠ¤ ê²€ì¦ - ê²°ê³¼ êµ¬ì¡° í™•ì¸
     *
     * ğŸ¯ ê²€ì¦ ëª©ì :
     *   NasHealthResultê°€ ì˜¬ë°”ë¥¸ êµ¬ì¡°ë¥¼ ê°€ì§€ëŠ”ì§€ í™•ì¸í•œë‹¤.
     *   API ì‘ë‹µ í˜•ì‹ì´ ì¼ê´€ë˜ì–´ì•¼ í•œë‹¤.
     *
     * âœ… ê¸°ëŒ€ ê²°ê³¼:
     *   - status, responseTimeMs, checkedAt í•„ìˆ˜
     *   - capacityëŠ” healthy ì‹œ ì„ íƒì ìœ¼ë¡œ í¬í•¨
     */
    it('should have correct structure in result', async () => {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¥ GIVEN (ì‚¬ì „ ì¡°ê±´ ì„¤ì •)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      configService.get.mockReturnValue('\\\\192.168.10.249\\Web');

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ¬ WHEN (í…ŒìŠ¤íŠ¸ ì‹¤í–‰)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const result = await service.checkHealth();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âœ… THEN (ê²°ê³¼ ê²€ì¦)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      expect(result).toHaveProperty('status');
      expect(result).toHaveProperty('responseTimeMs');
      expect(result).toHaveProperty('checkedAt');
      // capacityì™€ errorëŠ” ìƒí™©ì— ë”°ë¼ ìˆì„ ìˆ˜ ìˆìŒ
    });
  });

  describe('UNC ê²½ë¡œ íŒŒì‹±', () => {
    /**
     * ğŸ“Œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤: ë‹¤ì–‘í•œ UNC ê²½ë¡œ í˜•ì‹ ì²˜ë¦¬
     *
     * ğŸ¯ ê²€ì¦ ëª©ì :
     *   ë‹¤ì–‘í•œ ì´ìŠ¤ì¼€ì´í”„ í˜•ì‹ì˜ UNC ê²½ë¡œê°€ ì˜¬ë°”ë¥´ê²Œ íŒŒì‹±ë˜ëŠ”ì§€ í™•ì¸í•œë‹¤.
     *   .env íŒŒì¼ì—ì„œ ì½ì–´ì˜¨ ê²½ë¡œê°€ ë‹¤ì–‘í•œ í˜•íƒœì¼ ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤.
     *
     * âœ… ê¸°ëŒ€ ê²°ê³¼:
     *   - ì •ìƒì ì¸ UNC ê²½ë¡œëŠ” checkHealthê°€ ë™ì‘
     *   - ì˜ëª»ëœ í˜•ì‹ì€ unhealthy ë°˜í™˜
     */
    it.each([
      // [ì…ë ¥ ê²½ë¡œ, ì„¤ëª…]
      ['\\\\192.168.10.249\\Web', 'í‘œì¤€ UNC ê²½ë¡œ (ë°±ìŠ¬ë˜ì‹œ 2ê°œ)'],
      ['\\\\\\\\192.168.10.249\\\\Web', 'ì´ìŠ¤ì¼€ì´í”„ëœ UNC ê²½ë¡œ (ë°±ìŠ¬ë˜ì‹œ 4ê°œ)'],
      ['//192.168.10.249/Web', 'ìŠ¬ë˜ì‹œ í˜•ì‹ UNC ê²½ë¡œ'],
      ['\\\\192.168.10.249\\Web\\personal\\ì„œìš°í˜\\dms', 'í•˜ìœ„ í´ë” í¬í•¨ UNC ê²½ë¡œ'],
      ['\\\\\\\\192.168.10.249\\\\Web\\\\personal\\\\ì„œìš°í˜\\\\dms', 'ì´ìŠ¤ì¼€ì´í”„ëœ í•˜ìœ„ í´ë” í¬í•¨'],
    ])('should handle UNC path: %s (%s)', async (uncPath, _description) => {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¥ GIVEN (ì‚¬ì „ ì¡°ê±´ ì„¤ì •)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      configService.get.mockReturnValue(uncPath);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ¬ WHEN (í…ŒìŠ¤íŠ¸ ì‹¤í–‰)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const result = await service.checkHealth();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âœ… THEN (ê²°ê³¼ ê²€ì¦)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // íŒŒì‹±ì€ ì„±ê³µí•´ì•¼ í•¨ (ì‹¤ì œ NAS ì—°ê²° ì‹¤íŒ¨ëŠ” ë³„ê°œ)
      // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ì— 'íŒŒì‹± ì‹¤íŒ¨' í¬í•¨
      if (result.error) {
        expect(result.error).not.toContain('íŒŒì‹± ì‹¤íŒ¨');
      }
      expect(result).toHaveProperty('status');
    });

    /**
     * ğŸ“Œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤: ì˜ëª»ëœ UNC ê²½ë¡œ - ì„œë²„ë§Œ ìˆëŠ” ê²½ìš°
     *
     * ğŸ¯ ê²€ì¦ ëª©ì :
     *   ê³µìœ  í´ë” ì—†ì´ ì„œë²„ë§Œ ìˆëŠ” ê²½ë¡œëŠ” íŒŒì‹± ì‹¤íŒ¨í•´ì•¼ í•œë‹¤.
     *
     * âœ… ê¸°ëŒ€ ê²°ê³¼:
     *   - status = 'unhealthy'
     *   - errorì— íŒŒì‹± ì‹¤íŒ¨ ë©”ì‹œì§€ í¬í•¨
     */
    it('should fail when UNC path has only server without share', async () => {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¥ GIVEN (ì‚¬ì „ ì¡°ê±´ ì„¤ì •)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      configService.get.mockReturnValue('\\\\192.168.10.249');

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ¬ WHEN (í…ŒìŠ¤íŠ¸ ì‹¤í–‰)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const result = await service.checkHealth();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âœ… THEN (ê²°ê³¼ ê²€ì¦)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      expect(result.status).toBe('unhealthy');
      expect(result.error).toContain('íŒŒì‹± ì‹¤íŒ¨');
    });
  });
});
