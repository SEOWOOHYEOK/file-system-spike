/**
 * ============================================================
 * ğŸ“¦ Cache Health Check ë„ë©”ì¸ ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸
 * ============================================================
 *
 * ğŸ¯ í…ŒìŠ¤íŠ¸ ëŒ€ìƒ:
 *   - CacheHealthCheckDomainService
 *
 * ğŸ“‹ ë¹„ì¦ˆë‹ˆìŠ¤ ë§¥ë½:
 *   - ìºì‹œ ìŠ¤í† ë¦¬ì§€(Local)ì˜ ì—°ê²° ìƒíƒœë¥¼ ë…ë¦½ì ìœ¼ë¡œ í™•ì¸
 *   - ì‹¤ì œ íŒŒì¼ ì“°ê¸°/ì½ê¸°/ì‚­ì œë¥¼ í†µí•´ ìŠ¤í† ë¦¬ì§€ ì •ìƒ ë™ì‘ ê²€ì¦
 *   - ì‘ë‹µ ì‹œê°„ì— ë”°ë¼ healthy/degraded/unhealthy ìƒíƒœ ë°˜í™˜
 *
 * âš ï¸ ì¤‘ìš” ê³ ë ¤ì‚¬í•­:
 *   - ìŠ¤í† ë¦¬ì§€ ì—°ê²° ì‹¤íŒ¨ ì‹œì—ë„ ì—ëŸ¬ë¥¼ ë˜ì§€ì§€ ì•Šê³  ìƒíƒœë¡œ ë°˜í™˜
 *   - ì‘ë‹µ ì‹œê°„ 1ì´ˆ ì´ˆê³¼ ì‹œ degraded ìƒíƒœë¡œ íŒë‹¨
 *   - íƒ€ì„ì•„ì›ƒ 5ì´ˆ ì„¤ì •ìœ¼ë¡œ ë¬´í•œ ëŒ€ê¸° ë°©ì§€
 *   - finallyì—ì„œ í—¬ìŠ¤ì²´í¬ íŒŒì¼ ì‚­ì œ
 * ============================================================
 */
import { Test, TestingModule } from '@nestjs/testing';
import { CacheHealthCheckService } from './cache-health-check.service';
import {
  CACHE_STORAGE_PORT,
  ICacheStoragePort,
} from '../../../domain/storage/ports/cache-storage.port';

describe('CacheHealthCheckService', () => {
  let service: CacheHealthCheckService;
  let cacheStorage: jest.Mocked<ICacheStoragePort>;

  /**
   * ğŸ­ Mock ì„¤ì •
   * ğŸ“ cacheStorage.íŒŒì¼ì“°ê¸°:
   *   - ì‹¤ì œ ë™ì‘: ìºì‹œ ìŠ¤í† ë¦¬ì§€ì— íŒŒì¼ ì €ì¥
   *   - Mock ì´ìœ : ì‹¤ì œ íŒŒì¼ ì‹œìŠ¤í…œ ì—†ì´ ì“°ê¸° ë™ì‘ ì‹œë®¬ë ˆì´ì…˜
   *
   * ğŸ“ cacheStorage.íŒŒì¼ì½ê¸°:
   *   - ì‹¤ì œ ë™ì‘: ìºì‹œ ìŠ¤í† ë¦¬ì§€ì—ì„œ íŒŒì¼ ì½ê¸°
   *   - Mock ì´ìœ : ì“´ ë‚´ìš©ê³¼ ë™ì¼í•œ ë‚´ìš© ë°˜í™˜í•˜ë„ë¡ ì„¤ì •
   *
   * ğŸ“ cacheStorage.íŒŒì¼ì‚­ì œ:
   *   - ì‹¤ì œ ë™ì‘: ìºì‹œ ìŠ¤í† ë¦¬ì§€ì—ì„œ íŒŒì¼ ì‚­ì œ
   *   - Mock ì´ìœ : finallyì—ì„œ ì •ë¦¬ ë™ì‘ í™•ì¸
   */
  beforeEach(async () => {
    cacheStorage = {
      íŒŒì¼ì“°ê¸°: jest.fn(),
      íŒŒì¼ì½ê¸°: jest.fn(),
      íŒŒì¼ì‚­ì œ: jest.fn(),
      íŒŒì¼ì¡´ì¬í™•ì¸: jest.fn(),
      íŒŒì¼í¬ê¸°ì¡°íšŒ: jest.fn(),
    } as any;

    const module: TestingModule = await Test.createTestingModule({
      providers: [
        CacheHealthCheckService,
        {
          provide: CACHE_STORAGE_PORT,
          useValue: cacheStorage,
        },
      ],
    }).compile();

    service = module.get<CacheHealthCheckService>(
      CacheHealthCheckService,
    );
  });

  describe('checkHealth', () => {
    /**
     * ğŸ“Œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤: ì •ìƒ íë¦„ - ì“°ê¸°/ì½ê¸°/ì‚­ì œ ëª¨ë‘ ì„±ê³µ
     *
     * ğŸ¯ ê²€ì¦ ëª©ì :
     *   ìºì‹œ ìŠ¤í† ë¦¬ì§€ì— íŒŒì¼ì„ ì“°ê³ , ì½ì–´ì„œ ë‚´ìš©ì´ ì¼ì¹˜í•˜ë©´ healthy ìƒíƒœë¥¼ ë°˜í™˜í•´ì•¼ í•œë‹¤.
     *   ì´ëŠ” ìºì‹œ ì‹œìŠ¤í…œì˜ ì“°ê¸°/ì½ê¸° ê¸°ëŠ¥ì´ ì •ìƒ ë™ì‘í•¨ì„ ë‚˜íƒ€ë‚¸ë‹¤.
     *
     * âœ… ê¸°ëŒ€ ê²°ê³¼:
     *   - status = 'healthy'
     *   - ì‘ë‹µ ì‹œê°„ì´ 1000ms ë¯¸ë§Œ
     *   - checkedAtì´ ìœ íš¨í•œ Date
     *   - íŒŒì¼ì‚­ì œê°€ í˜¸ì¶œë¨ (finally)
     */
    it('should return healthy status when write/read/delete succeeds', async () => {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¥ GIVEN (ì‚¬ì „ ì¡°ê±´ ì„¤ì •)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      cacheStorage.íŒŒì¼ì“°ê¸°.mockResolvedValue(undefined);
      // íŒŒì¼ì½ê¸°ëŠ” ì“´ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ë°˜í™˜í•˜ë„ë¡ ì„¤ì •
      cacheStorage.íŒŒì¼ì½ê¸°.mockImplementation(async () => {
        // íŒŒì¼ì“°ê¸° í˜¸ì¶œ ì‹œ ì „ë‹¬ëœ Bufferë¥¼ ë°˜í™˜
        const writtenData = cacheStorage.íŒŒì¼ì“°ê¸°.mock.calls[0]?.[1];
        return writtenData || Buffer.from('');
      });
      cacheStorage.íŒŒì¼ì‚­ì œ.mockResolvedValue(undefined);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ¬ WHEN (í…ŒìŠ¤íŠ¸ ì‹¤í–‰)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const result = await service.checkHealth();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âœ… THEN (ê²°ê³¼ ê²€ì¦)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      expect(result.status).toBe('healthy');
      expect(result.responseTimeMs).toBeLessThan(1000);
      expect(result.checkedAt).toBeInstanceOf(Date);
      expect(cacheStorage.íŒŒì¼ì“°ê¸°).toHaveBeenCalledTimes(1);
      expect(cacheStorage.íŒŒì¼ì½ê¸°).toHaveBeenCalledTimes(1);
      expect(cacheStorage.íŒŒì¼ì‚­ì œ).toHaveBeenCalledTimes(1);
    });

    /**
     * ğŸ“Œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤: ê²½ê³„ ì¼€ì´ìŠ¤ - ìºì‹œ ì‘ë‹µì´ ëŠë¦¼
     *
     * ğŸ¯ ê²€ì¦ ëª©ì :
     *   ìºì‹œ ìŠ¤í† ë¦¬ì§€ê°€ 1ì´ˆ ì´ìƒ ê±¸ë ¤ ì‘ë‹µí•˜ë©´ degraded ìƒíƒœë¥¼ ë°˜í™˜í•´ì•¼ í•œë‹¤.
     *   ì´ëŠ” ì„±ëŠ¥ ì €í•˜ë¥¼ ê°ì§€í•˜ì—¬ ì‚¬ì „ ì¡°ì¹˜ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•œë‹¤.
     *
     * âœ… ê¸°ëŒ€ ê²°ê³¼:
     *   - status = 'degraded' (1.5ì´ˆ ì§€ì—°)
     */
    it('should return degraded status when cache responds slowly', async () => {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¥ GIVEN (ì‚¬ì „ ì¡°ê±´ ì„¤ì •)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      cacheStorage.íŒŒì¼ì“°ê¸°.mockImplementation(
        () => new Promise((resolve) => setTimeout(() => resolve(undefined), 1500)),
      );
      cacheStorage.íŒŒì¼ì½ê¸°.mockImplementation(async () => {
        const writtenData = cacheStorage.íŒŒì¼ì“°ê¸°.mock.calls[0]?.[1];
        return writtenData || Buffer.from('');
      });
      cacheStorage.íŒŒì¼ì‚­ì œ.mockResolvedValue(undefined);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ¬ WHEN (í…ŒìŠ¤íŠ¸ ì‹¤í–‰)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const result = await service.checkHealth();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âœ… THEN (ê²°ê³¼ ê²€ì¦)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      expect(result.status).toBe('degraded');
      expect(result.responseTimeMs).toBeGreaterThanOrEqual(1000);
    }, 10000);

    /**
     * ğŸ“Œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤: ì—ëŸ¬ ì¼€ì´ìŠ¤ - íŒŒì¼ ì“°ê¸° ì‹¤íŒ¨
     *
     * ğŸ¯ ê²€ì¦ ëª©ì :
     *   ìºì‹œ ìŠ¤í† ë¦¬ì§€ ì“°ê¸°ê°€ ì‹¤íŒ¨í•˜ë©´ unhealthy ìƒíƒœë¥¼ ë°˜í™˜í•´ì•¼ í•œë‹¤.
     *   ì—ëŸ¬ë¥¼ ë˜ì§€ì§€ ì•Šê³  ìƒíƒœë¡œ ë°˜í™˜í•œë‹¤.
     *
     * âœ… ê¸°ëŒ€ ê²°ê³¼:
     *   - status = 'unhealthy'
     *   - errorì— ì—ëŸ¬ ë©”ì‹œì§€ í¬í•¨
     *   - íŒŒì¼ì‚­ì œê°€ í˜¸ì¶œë¨ (finallyì—ì„œ ì •ë¦¬ ì‹œë„)
     */
    it('should return unhealthy status when write fails', async () => {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¥ GIVEN (ì‚¬ì „ ì¡°ê±´ ì„¤ì •)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      cacheStorage.íŒŒì¼ì“°ê¸°.mockRejectedValue(new Error('Write failed'));
      cacheStorage.íŒŒì¼ì‚­ì œ.mockResolvedValue(undefined);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ¬ WHEN (í…ŒìŠ¤íŠ¸ ì‹¤í–‰)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const result = await service.checkHealth();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âœ… THEN (ê²°ê³¼ ê²€ì¦)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      expect(result.status).toBe('unhealthy');
      expect(result.error).toContain('Write failed');
      // finallyì—ì„œ ì‚­ì œ ì‹œë„í•¨
      expect(cacheStorage.íŒŒì¼ì‚­ì œ).toHaveBeenCalledTimes(1);
    });

    /**
     * ğŸ“Œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤: ì—ëŸ¬ ì¼€ì´ìŠ¤ - íŒŒì¼ ì½ê¸° ì‹¤íŒ¨
     *
     * ğŸ¯ ê²€ì¦ ëª©ì :
     *   ìºì‹œ ìŠ¤í† ë¦¬ì§€ ì½ê¸°ê°€ ì‹¤íŒ¨í•˜ë©´ unhealthy ìƒíƒœë¥¼ ë°˜í™˜í•´ì•¼ í•œë‹¤.
     *
     * âœ… ê¸°ëŒ€ ê²°ê³¼:
     *   - status = 'unhealthy'
     *   - errorì— ì—ëŸ¬ ë©”ì‹œì§€ í¬í•¨
     */
    it('should return unhealthy status when read fails', async () => {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¥ GIVEN (ì‚¬ì „ ì¡°ê±´ ì„¤ì •)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      cacheStorage.íŒŒì¼ì“°ê¸°.mockResolvedValue(undefined);
      cacheStorage.íŒŒì¼ì½ê¸°.mockRejectedValue(new Error('Read failed'));
      cacheStorage.íŒŒì¼ì‚­ì œ.mockResolvedValue(undefined);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ¬ WHEN (í…ŒìŠ¤íŠ¸ ì‹¤í–‰)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const result = await service.checkHealth();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âœ… THEN (ê²°ê³¼ ê²€ì¦)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      expect(result.status).toBe('unhealthy');
      expect(result.error).toContain('Read failed');
    });

    /**
     * ğŸ“Œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤: ì—ëŸ¬ ì¼€ì´ìŠ¤ - ë‚´ìš© ë¶ˆì¼ì¹˜
     *
     * ğŸ¯ ê²€ì¦ ëª©ì :
     *   ì“´ ë‚´ìš©ê³¼ ì½ì€ ë‚´ìš©ì´ ë‹¤ë¥´ë©´ unhealthy ìƒíƒœë¥¼ ë°˜í™˜í•´ì•¼ í•œë‹¤.
     *   ë°ì´í„° ë¬´ê²°ì„± ë¬¸ì œë¥¼ ê°ì§€í•œë‹¤.
     *
     * âœ… ê¸°ëŒ€ ê²°ê³¼:
     *   - status = 'unhealthy'
     *   - errorì— 'content mismatch' í¬í•¨
     */
    it('should return unhealthy status when content mismatch', async () => {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¥ GIVEN (ì‚¬ì „ ì¡°ê±´ ì„¤ì •)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      cacheStorage.íŒŒì¼ì“°ê¸°.mockResolvedValue(undefined);
      // ì“´ ë‚´ìš©ê³¼ ë‹¤ë¥¸ ë‚´ìš© ë°˜í™˜
      cacheStorage.íŒŒì¼ì½ê¸°.mockResolvedValue(Buffer.from('corrupted_data'));
      cacheStorage.íŒŒì¼ì‚­ì œ.mockResolvedValue(undefined);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ¬ WHEN (í…ŒìŠ¤íŠ¸ ì‹¤í–‰)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const result = await service.checkHealth();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âœ… THEN (ê²°ê³¼ ê²€ì¦)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      expect(result.status).toBe('unhealthy');
      expect(result.error).toContain('content mismatch');
    });

    /**
     * ğŸ“Œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤: finally ë™ì‘ - ì‚­ì œ ì‹¤íŒ¨í•´ë„ ì •ìƒ ë°˜í™˜
     *
     * ğŸ¯ ê²€ì¦ ëª©ì :
     *   í—¬ìŠ¤ì²´í¬ íŒŒì¼ ì‚­ì œê°€ ì‹¤íŒ¨í•´ë„ healthy ìƒíƒœë¥¼ ë°˜í™˜í•´ì•¼ í•œë‹¤.
     *   ì‚­ì œ ì‹¤íŒ¨ëŠ” í—¬ìŠ¤ì²´í¬ ê²°ê³¼ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠëŠ”ë‹¤.
     *
     * âœ… ê¸°ëŒ€ ê²°ê³¼:
     *   - status = 'healthy' (ì“°ê¸°/ì½ê¸° ì„±ê³µ)
     *   - ì‚­ì œ ì‹¤íŒ¨ëŠ” ë¬´ì‹œë¨
     */
    it('should return healthy even if delete fails in finally', async () => {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¥ GIVEN (ì‚¬ì „ ì¡°ê±´ ì„¤ì •)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      cacheStorage.íŒŒì¼ì“°ê¸°.mockResolvedValue(undefined);
      cacheStorage.íŒŒì¼ì½ê¸°.mockImplementation(async () => {
        const writtenData = cacheStorage.íŒŒì¼ì“°ê¸°.mock.calls[0]?.[1];
        return writtenData || Buffer.from('');
      });
      cacheStorage.íŒŒì¼ì‚­ì œ.mockRejectedValue(new Error('Delete failed'));

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ¬ WHEN (í…ŒìŠ¤íŠ¸ ì‹¤í–‰)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const result = await service.checkHealth();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âœ… THEN (ê²°ê³¼ ê²€ì¦)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      expect(result.status).toBe('healthy');
      expect(result.error).toBeUndefined();
    });
  });
});
